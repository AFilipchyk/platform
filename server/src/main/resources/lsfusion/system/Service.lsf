MODULE Service;

REQUIRE System, Reflection, Time;

NAMESPACE Service;

checkAggregationsAction 'Проверить агрегации' = ACTION CUSTOM 'lsfusion.server.logics.service.CheckAggregationsActionProperty' ();
checkClassesAction 'Проверить классы' = ACTION CUSTOM 'lsfusion.server.logics.service.CheckClassesActionProperty' ();
recalculateClassesAction 'Пересчитать классы' = ACTION CUSTOM 'lsfusion.server.logics.service.RecalculateClassesActionProperty' ();
recalculateAction 'Пересчитать агрегации' = ACTION CUSTOM 'lsfusion.server.logics.service.RecalculateActionProperty' ();
recalculateMultiThreadAction 'Пересчитать агрегации (многопоточно)' = ACTION CUSTOM 'lsfusion.server.logics.service.RecalculateMultiThreadActionProperty' ();

recalculateFollowsAction 'Пересчитать следствия и ограничения' = ACTION CUSTOM 'lsfusion.server.logics.service.RecalculateFollowsActionProperty' ();
recalculateFollowsMultiThreadAction 'Пересчитать следствия и ограничения (многопоточно)' = ACTION CUSTOM 'lsfusion.server.logics.service.RecalculateFollowsMultiThreadActionProperty' ();
analyzeDBAction 'Анализ БД' = ACTION CUSTOM 'lsfusion.server.logics.service.AnalyzeDBActionProperty' ();
vacuumDBAction 'Упаковать БД' = ACTION CUSTOM 'lsfusion.server.logics.service.VacuumDBActionProperty' ();
packAction 'Упаковать таблицы' = ACTION CUSTOM 'lsfusion.server.logics.service.PackActionProperty' ();
serviceDBAction 'Обслуживание БД' = ACTION CUSTOM 'lsfusion.server.logics.service.ServiceDBActionProperty' ();
serviceDBMultiThreadAction 'Обслуживание БД (многопоточно)' = ACTION CUSTOM 'lsfusion.server.logics.service.ServiceDBMultiThreadActionProperty' ();
getVMInfo 'Данные виртуальной машины' = ACTION CUSTOM 'lsfusion.server.logics.service.GetVMInfoActionProperty' ();

singleTransaction 'Перерасчет одной транзакцией' = DATA BOOLEAN ();

CLASS DBType {
    POSTGRE 'Postgre',
    MSSQL 'MS SQL'
}
uploadType 'Тип базы' = DATA DBType ();
uploadStaticNameType = staticName(uploadType()); 
uploadStaticCaptionType 'Тип базы' = staticCaption(uploadType()); 
uploadHost 'Имя сервера' = DATA VARSTRING[100] ();
uploadUser 'Пользователь' = DATA VARSTRING[100] ();
uploadPassword 'Пароль' = DATA VARSTRING[100] ();
uploadInstance 'Имя сервера БД' = DATA VARSTRING[100] ();
onStarted() += ACTION {
    uploadType() <- DBType.MSSQL;
    uploadHost() <- 'localhost';
    uploadUser() <- 'sa';
    uploadPassword() <- '11111';
    uploadInstance() <- 'SQLEXPRESS';
}
uploadDB 'Имя базы' = DATA VARSTRING[100] (); 
uploadToDBAction 'Загрузить' = ACTION CUSTOM 'lsfusion.server.logics.service.UploadToDBActionProperty' ();

META defineMode(property, action, type, caption1, caption2)
    setRepeatableRead###property caption1 = ACTION CUSTOM action (type);
    refreshRepeatableRead###property caption2() = ACTION {
        setRepeatableRead###property(property());
    }
    WHEN CHANGED(property()) DO {
        refreshRepeatableRead###property();
    }
    onStarted() += ACTION {
        refreshRepeatableRead###property();
    } 
END

TILMode 'Включен SERIALIZABLE' = DATA BOOLEAN ();
serverComputer 'Сервер' = DATA Computer();
hostnameServerComputer 'Сервер' () = hostnameComputer(serverComputer());

@defineMode(TILMode, 'lsfusion.server.logics.service.SetRepeatableReadTILModeActionProperty', BOOLEAN, 'Включить SERIALIZABLE', 'Обновить SERIALIZABLE в VM');

@defineMode(hostnameServerComputer, 'lsfusion.server.logics.service.SetHostnameServerComputerActionProperty', VARSTRING[100], 'Записать Hostname Server', 'Обновить Hostname Server');

setExplainAnalyzeModeUser 'Выводить в лог EXPLAIN ANALYZE запросов' = ACTION CUSTOM 'lsfusion.server.logics.service.SetExplainAnalyzeModeUserActionProperty' (BOOLEAN, User);
explainAnalyzeModeUser 'Включён Explain Analyze' = DATA BOOLEAN (User);
refreshExplainAnalyzeModeUser 'Обновить Explain Analyze' = ACTION (user) {
    setExplainAnalyzeModeUser(explainAnalyzeModeUser(user), user);  
}
WHEN CHANGED(explainAnalyzeModeUser(user)) DO {
    refreshExplainAnalyzeModeUser(user);
}

turnExplainAnalizeOnCurrentUser 'Включить EXPLAIN ANALYZE' () = ACTION {
    explainAnalyzeModeUser(user) <- TRUE WHERE user == currentUser();     
}

setExplainModeUser 'Выводить в лог EXPLAIN запросов' = ACTION CUSTOM 'lsfusion.server.logics.service.SetExplainModeUserActionProperty' (BOOLEAN, User);
explainModeUser 'Включён Explain' = DATA BOOLEAN (User);
refreshExplainModeUser 'Обновить Explain' = ACTION (user) {
    setExplainModeUser(explainModeUser(user), user);  
}
WHEN CHANGED(explainModeUser(user)) DO {
    refreshExplainModeUser(user);
}

setLoggerDebugEnabledUser 'Включить вывод в лог SQL запросов' = ACTION CUSTOM 'lsfusion.server.logics.service.SetLoggerDebugEnabledUserActionProperty' (BOOLEAN, User);
loggerDebugEnabledUser 'Выводить в лог SQL запросы' = DATA BOOLEAN (User);
refreshLoggerDebugEnabledUser '' = ACTION (user) {
    setLoggerDebugEnabledUser(loggerDebugEnabledUser(user), user);
}
WHEN CHANGED(loggerDebugEnabledUser(user)) DO {
    refreshLoggerDebugEnabledUser(user);
}

setRemoteLoggerDebugEnabledUser 'Включить вывод в лог действий пользователей' = ACTION CUSTOM 'lsfusion.server.logics.service.SetRemoteLoggerDebugEnabledUserActionProperty' (BOOLEAN, User);
remoteLoggerDebugEnabledUser 'Выводить в лог действия пользователей' = DATA BOOLEAN (User);
refreshRemoteLoggerDebugEnabledUser '' = ACTION (user) {
    setRemoteLoggerDebugEnabledUser(remoteLoggerDebugEnabledUser(user), user);
}
WHEN CHANGED(remoteLoggerDebugEnabledUser(user)) DO {
    refreshRemoteLoggerDebugEnabledUser(user);
}

CLASS TypeExecEnv {
    materialize 'Материализация подзапросов', 
    disablenestloop 'Отключение nested loop', 
    none 'Нет'
}

captionTypeExecEnv 'Название' (type) = staticCaption (type) IN base;
idTypeExecEnv (type) = CASE EXCLUSIVE
                        WHEN type == TypeExecEnv.materialize THEN 2
                        WHEN type == TypeExecEnv.disablenestloop THEN 1
                        WHEN type == TypeExecEnv.none THEN 0 IN base;

setExecEnvUser 'Выводить в лог EXPLAIN запросов' = ACTION CUSTOM 'lsfusion.server.logics.service.SetExecEnvUserActionProperty' (INTEGER, User);
execEnvUser 'Тип адаптивного выполнения' = DATA TypeExecEnv (User);
refreshExecEnvUser 'Обновить Explain' = ACTION (user) {
    setExecEnvUser(idTypeExecEnv(execEnvUser(user)), user);  
}
WHEN CHANGED(execEnvUser(user)) DO {
    refreshExecEnvUser(user);
}
nameExecEnvUser 'Тип адаптивного выполнения' (user) = captionTypeExecEnv(execEnvUser(user));

// --------------- Удаление прикладных логов ------------------------ //

clearApplicationLog 'Очистить прикладные логи' = ABSTRACT ACTION LIST () ;

META defineLog (object, caption, container)
    countDaysClear##object 'За сколько дней хранить лог '##caption = DATA INTEGER (); 
    
    EXTEND FORM options PROPERTIES countDaysClear##object();
    DESIGN options { container { MOVE PROPERTY(countDaysClear##object());} }    
END
META defineLog (object, dateProp)
    clearApplicationLog () += ACTION () NEWSESSION {
        IF countDaysClear##object() THEN {
            DELETE d WHERE d IS object AND dateProp##object(d)<= subtractDate(currentDate(), countDaysClear##object());
        }
        apply();
    }   
END
META defineLog (object, caption, container, dateProp)
    @defineLog (object, caption, container);
    @defineLog (object, dateProp);    
END

DESIGN options {
    pane {
        NEW log {
            caption = 'Логирование';
        }
    }
}

setVolatileStatsEnabledUser 'Установить использование nested loop' = ACTION CUSTOM 'lsfusion.server.logics.service.SetVolatileStatsEnabledUserActionProperty' (BOOLEAN, User);
volatileStatsEnabledUser 'Не использовать nested loop' = DATA BOOLEAN (User);
refreshVolatileStatsEnabledUser '' = ACTION (user) {
    setVolatileStatsEnabledUser(volatileStatsEnabledUser(user), user);
}
WHEN CHANGED(volatileStatsEnabledUser(user)) DO {
    refreshVolatileStatsEnabledUser(user);
}

onStarted() += ACTION {
    FOR u IS User DO {
        refreshExplainAnalyzeModeUser(u);
        refreshExplainModeUser(u);
        refreshLoggerDebugEnabledUser(u);
        refreshVolatileStatsEnabledUser(u);
        refreshRemoteLoggerDebugEnabledUser(u);
        refreshExecEnvUser(u);
    }
} 

setReupdateMode 'Включить REUPDATE' = ACTION CUSTOM 'lsfusion.server.logics.service.SetReupdateModeActionProperty' (BOOLEAN);
reupdateMode 'Включен REUPDATE' = DATA BOOLEAN ();
refreshReupdateMode 'Обновить REUPDATE в VM'() = ACTION {
    setReupdateMode(reupdateMode());
}
WHEN CHANGED(reupdateMode()) DO {
    refreshReupdateMode();
}
onStarted() += ACTION {
    refreshReupdateMode();
} 

restartServerAction 'Остановить сервер' = ACTION CUSTOM 'lsfusion.server.logics.service.RestartActionProperty' ();
runGarbageCollector 'Запустить сборщик мусора' = ACTION CUSTOM 'lsfusion.server.logics.service.GarbageCollectorActionProperty' ();
cancelRestartServerAction 'Отменить остановку сервера' = ACTION CUSTOM 'lsfusion.server.logics.service.CancelRestartActionProperty' ();
dropLRU 'Очистить LRU' = ACTION CUSTOM 'lsfusion.server.logics.service.DropLRUActionProperty' ();
makeHeapDump 'Сделать Heap Dump' = ACTION CUSTOM 'lsfusion.server.logics.service.MakeHeapDumpActionProperty' ();
isServerRestarting = NATIVE BOOLEAN ();
isNotServerRestarting () = NOT isServerRestarting();

nameReflectionSetting 'Имя настройки' = DATA LOCAL VARSTRING[100] ();
valueReflectionSetting 'Значение настройки' = DATA LOCAL VARSTRING[100] ();

readValueReflectionSetting = ACTION CUSTOM 'lsfusion.server.logics.service.ReadValueReflectionSettingActionProperty' ();
saveValueReflectionSetting = ACTION CUSTOM 'lsfusion.server.logics.service.SaveValueReflectionSettingActionProperty' ();

WHEN SESSION CHANGED(nameReflectionSetting()) DO readValueReflectionSetting(); 
WHEN SESSION CHANGED(valueReflectionSetting()) DO saveValueReflectionSetting(); 

FORM admin 'Администрирование'
    PROPERTIES() currentDate, defaultBackgroundColor, defaultForegroundColor, 
                 selectedRowBackgroundColor, selectedRowBorderColor, selectedCellBackgroundColor, focusedCellBackgroundColor, focusedCellBorderColor,
                 reportCharWidth, reportRowHeight, reportNotToStretch, 
                 restartServerAction SHOWIF isNotServerRestarting(), cancelRestartServerAction SHOWIF isServerRestarting(), checkAggregationsAction, checkClassesAction, 
                 recalculateClassesAction, recalculateAction, recalculateMultiThreadAction, recalculateFollowsAction, recalculateFollowsMultiThreadAction, 
                 packAction, analyzeDBAction, uploadToDBAction, uploadStaticCaptionType, uploadHost, uploadUser, uploadPassword, uploadInstance, uploadDB,    
                 vacuumDBAction, serviceDBAction, serviceDBMultiThreadAction, runGarbageCollector, getVMInfo, dropLRU, makeHeapDump, 
                 TILMode, hostnameServerComputer, reupdateMode, singleTransaction,
                 nameReflectionSetting, turnExplainAnalizeOnCurrentUser, clearApplicationLog,
                 valueReflectionSetting SHOWIF nameReflectionSetting()
    OBJECTS u=User
    PROPERTIES(u) nameUser READONLY, explainAnalyzeModeUser, explainModeUser, loggerDebugEnabledUser, remoteLoggerDebugEnabledUser, nameExecEnvUser, volatileStatsEnabledUser;
;

DESIGN admin {
    NEW pane {
        type = COLUMNS;
        columns = 3;
        NEW current {
            caption = 'Текущие значения';
            MOVE PROPERTY(currentDate());
        }
        NEW colors {
            caption = 'Цвета';
            MOVE PROPERTY(defaultBackgroundColor());
            MOVE PROPERTY(defaultForegroundColor());
            MOVE PROPERTY(selectedRowBackgroundColor());
            MOVE PROPERTY(selectedRowBorderColor());
            MOVE PROPERTY(selectedCellBackgroundColor());
            MOVE PROPERTY(focusedCellBackgroundColor());
            MOVE PROPERTY(focusedCellBorderColor());
        }
        NEW report {
            caption = 'Отчеты';
            MOVE PROPERTY(reportCharWidth());
            MOVE PROPERTY(reportRowHeight());
            MOVE PROPERTY(reportNotToStretch());
        }
        NEW administration {
            caption = 'Запуск';
            
            MOVE PROPERTY(restartServerAction());
            MOVE PROPERTY(cancelRestartServerAction());
            MOVE PROPERTY(serviceDBAction());
            MOVE PROPERTY(serviceDBMultiThreadAction());
            MOVE PROPERTY(hostnameServerComputer());
        }
        NEW recalculate {
            caption = 'Исправление целостности базы данных';
            MOVE PROPERTY(recalculateClassesAction());
            MOVE PROPERTY(recalculateAction());
            MOVE PROPERTY(recalculateMultiThreadAction());
            MOVE PROPERTY(recalculateFollowsAction());
            MOVE PROPERTY(recalculateFollowsMultiThreadAction());
        }
        NEW check {
            caption = 'Проверка целостности базы данных';
            MOVE PROPERTY(checkClassesAction());
            MOVE PROPERTY(checkAggregationsAction());
        }
        NEW upload {
            caption = 'Загрузить в другую базу';
            MOVE PROPERTY(uploadStaticCaptionType());
            MOVE PROPERTY(uploadHost());
            MOVE PROPERTY(uploadUser());
            MOVE PROPERTY(uploadPassword());
            MOVE PROPERTY(uploadInstance());
            MOVE PROPERTY(uploadDB());
            MOVE PROPERTY(uploadToDBAction());
        }
        NEW database {
            caption = 'База данных';
            MOVE PROPERTY(packAction());
            MOVE PROPERTY(analyzeDBAction());
            MOVE PROPERTY(vacuumDBAction());
            MOVE PROPERTY(TILMode());
            MOVE PROPERTY(reupdateMode());
            MOVE PROPERTY(singleTransaction());
        }
        NEW virtualMachine {
            caption = 'Виртуальная машина';
            MOVE PROPERTY(runGarbageCollector());
            MOVE PROPERTY(getVMInfo());
            MOVE PROPERTY(dropLRU());
            MOVE PROPERTY(makeHeapDump());
        }
        NEW log {
            caption = 'Логирование';
            MOVE PROPERTY(turnExplainAnalizeOnCurrentUser());
            MOVE PROPERTY(clearApplicationLog());
        }
        NEW settings {
            caption = 'Настройка свойств';
            MOVE PROPERTY(nameReflectionSetting());
            MOVE PROPERTY(valueReflectionSetting());
        }        
    }
    MOVE u.box;
    MOVE functions.box;
}

NAVIGATOR { 
    configuration {
        ADD Service.admin;
    }
}

