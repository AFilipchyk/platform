MODULE Rublevski;

IMPORT BaseLogicsModule;

castToString255 = FORMULA STRING[255] 'CAST($1 AS character(255))';

CLASS doubleNamed 'Объект с кратким наименованием' : named;

shortName 'Краткое наименование' = DATA STRING[5] (doubleNamed) IN baseGroup;

CLASS STATIC yesNo 'Логическое' {
    yes 'ДА',
    no 'НЕТ'
};
CLASS language 'Язык' : doubleNamed;

// ----------------------------------- Шаблоны ------------------------------------------ //

// ----------------------------------- Свойство объект-дата------------------------------------------ //
META metaCodeObjectDateProperty(prop, object, caption, type, group)

    prop##Date caption = DATA type (object, DATE) IN group;
    date##prop (object, date) = GROUP MAX dateIn AND prop##Date(object, dateIn) AND dateIn <= (date AS DATE) BY object, date;
    prop caption (object) = prop##Date(object, date##prop(object, currentDate())) IN group;

    FORM add##prop caption
    OBJECTS a=object FIXED PANEL, d=DATE FIXED PANEL
    PROPERTIES name(a) READONLY, OBJVALUE(d), prop##Date(a, d);
    DESIGN add##prop FROM DEFAULT {
        PROPERTY(name(a)) { focusable = FALSE; }
    }

    showFormAdd##prop 'Добавить' (object) = ACTION FORM add##prop OBJECTS a MODAL;

    FORM prop caption
    OBJECTS a=object FIXED PANEL, d=DATE
    PROPERTIES name(a) READONLY, showFormAdd##prop(a), OBJVALUE(d), prop##Date(a, d)
    FILTERS NOT NULL prop##Date(a, d);
    DESIGN prop FROM DEFAULT {
        PROPERTY(name(a)) { focusable = FALSE; }
    }

    showForm##prop caption (object) = ACTION FORM prop OBJECTS a MODAL SHORTCUT prop DEFAULT;

END

// ---------------------------------- Свойство объект-дата для (пример, стат.класса)------------------------------------------ //

META metaCodeNameObjectDateProperty(prop, object, caption, type, group)

    prop##Date caption = DATA type (object, DATE) IN group;
    name##prop##Date caption (object, date) = name(prop##Date(object, date));
    date##prop (object, date) = GROUP MAX dateIn AND prop##Date(object, dateIn) AND dateIn <= (date AS DATE) BY object, date;
    prop caption (object) = prop##Date(object, date##prop(object, currentDate()));
    name##prop caption (object) = name(prop(object)) IN group;

    FORM addName##prop caption
    OBJECTS a=object FIXED PANEL, d=DATE FIXED PANEL
    PROPERTIES name(a) READONLY, OBJVALUE(d), name##prop##Date(a, d);
    DESIGN addName##prop FROM DEFAULT {
        PROPERTY(name(a)) { focusable = FALSE; }
    }

    showFormAddName##prop 'Добавить' (object) = ACTION FORM addName##prop OBJECTS a MODAL;

    FORM name##prop caption
    OBJECTS a=object FIXED PANEL, d=DATE
    PROPERTIES name(a) READONLY, showFormAddName##prop(a), OBJVALUE(d), name##prop##Date(a, d)
    FILTERS NOT NULL prop##Date(a, d);
    DESIGN name##prop FROM DEFAULT {
        PROPERTY(name(a)) { focusable = FALSE; }
    }

    showFormName##prop caption (object) = ACTION FORM name##prop OBJECTS a MODAL SHORTCUT name##prop DEFAULT;

END

// ----------------------------------- Свойство объект1-объект2-дата------------------------------------------ //
META metaCodeDoubleObjectDateProperty(prop, object1, object2, caption, type)

    prop##Date caption = DATA type (object1, object2, DATE);
    date##prop (object1, object2, date) = GROUP MAX dateIn AND prop##Date(object1, object2, dateIn) AND dateIn <= (date AS DATE) BY object1, object2, date;
    prop caption (object1, object2) = prop##Date(object1, object2, date##prop(object1, object2, currentDate()));

    FORM add##prop caption
    OBJECTS a=object1 FIXED PANEL, b=object2 FIXED PANEL, d=DATE FIXED PANEL
    PROPERTIES name(a) READONLY, name(b) READONLY, OBJVALUE(d), prop##Date(a, b, d);
    DESIGN add##prop FROM DEFAULT {
        PROPERTY(name(a)) { focusable = FALSE; }
        PROPERTY(name(b)) { focusable = FALSE; }
    }

    showFormAdd##prop 'Добавить' (object1, object2) = ACTION FORM add##prop OBJECTS a, b MODAL;

    FORM prop caption
    OBJECTS a=object1 FIXED PANEL, b=object2 FIXED PANEL, d=DATE
    PROPERTIES name(a) READONLY, name(b) READONLY, showFormAdd##prop(a, b), OBJVALUE(d), prop##Date(a, b, d)
    FILTERS NOT NULL prop##Date(a, b, d);
    DESIGN prop FROM DEFAULT {
        PROPERTY(name(a)) { focusable = FALSE; }
        PROPERTY(name(b)) { focusable = FALSE; }
    }

    showForm##prop caption (object1, object2) = ACTION FORM prop OBJECTS a, b MODAL SHORTCUT prop DEFAULT;

END
// ----------------------------------- Свойство объект1-объект2-дата для yesNo со значением по-умолчанию НЕТ------------------------------------------ //

META metaCodeNameDoubleObjectDateProperty(prop, object1, object2, caption, type)

    prop##Date caption = DATA type (object1, object2, DATE);
    name##prop##Date caption (object1, object2, date) = name(prop##Date(object1, object2, date));
    date##prop (object1, object2, date) = GROUP MAX dateIn AND prop##Date(object1, object2, dateIn) AND dateIn <= (date AS DATE) BY object1, object2, date;
    prop caption (object1, object2) = UNION OVERRIDE yesNo.no AND object1 IS object1 AND object2 IS object2,
                                                     prop##Date(object1, object2, date##prop(object1, object2, currentDate()));
    name##prop caption (object1, object2) = name(prop(object1, object2));

    FORM addName##prop caption
    OBJECTS a=object1 FIXED PANEL, b=object2 FIXED PANEL, d=DATE FIXED PANEL
    PROPERTIES name(a) READONLY, name(b) READONLY, OBJVALUE(d), name##prop##Date(a, b, d);
    DESIGN addName##prop FROM DEFAULT {
        PROPERTY(name(a)) { focusable = FALSE; }
        PROPERTY(name(b)) { focusable = FALSE; }
    }

    showFormAddName##prop 'Добавить' (object1, object2) = ACTION FORM addName##prop OBJECTS a, b MODAL;

    FORM name##prop caption
    OBJECTS a=object1 FIXED PANEL, b=object2 FIXED PANEL, d=DATE
    PROPERTIES name(a) READONLY, name(b) READONLY,  showFormAddName##prop(a, b), OBJVALUE(d), name##prop##Date(a, b, d)
    FILTERS NOT NULL prop##Date(a, b, d);
    DESIGN name##prop FROM DEFAULT {
        PROPERTY(name(a)) { focusable = FALSE; }
        PROPERTY(name(b)) { focusable = FALSE; }
    }

    showFormName##prop caption (object1, object2) = ACTION FORM name##prop OBJECTS a, b MODAL SHORTCUT name##prop DEFAULT;

END

// ----------------------------------- Свойство объект1-объект2-дата------------------------------------------ //
META metaCodeTripleObjectDateProperty(prop, object1, object2, object3, caption, type)

    prop##Date caption = DATA type (object1, object2, object3, DATE);
    date##prop (object1, object2, object3, date) = GROUP MAX dateIn AND prop##Date(object1, object2, object3, dateIn) AND dateIn <= (date AS DATE) BY object1, object2, object3, date;
    prop caption (object1, object2) = prop##Date(object1, object2, date##prop(object1, object2, object3, currentDate()));

    FORM add##prop caption
    OBJECTS a=object1 FIXED PANEL, b=object2 FIXED PANEL, c=object3  FIXED PANEL, d=DATE FIXED PANEL
    PROPERTIES name(a) READONLY, name(b) READONLY, name(c) READONLY, OBJVALUE(d), prop##Date(a, b, c, d);
    DESIGN add##prop FROM DEFAULT {
        PROPERTY(name(a)) { focusable = FALSE; }
        PROPERTY(name(b)) { focusable = FALSE; }
        PROPERTY(name(c)) { focusable = FALSE; }
    }

    showFormAdd##prop 'Добавить' (object1, object2, object3) = ACTION FORM add##prop OBJECTS a, b, c MODAL;

    FORM prop caption
    OBJECTS a=object1 FIXED PANEL, b=object2 FIXED PANEL, c=object3 FIXED PANEL, d=DATE
    PROPERTIES name(a) READONLY, name(b) READONLY, name(c) READONLY, showFormAdd##prop(a, b, c), OBJVALUE(d), prop##Date(a, b, c, d)
    FILTERS NOT NULL prop##Date(a, b, c, d);
    DESIGN prop FROM DEFAULT {
        PROPERTY(name(a)) { focusable = FALSE; }
        PROPERTY(name(b)) { focusable = FALSE; }
        PROPERTY(name(c)) { focusable = FALSE; }
    }

    showForm##prop caption (object1, object2, object3) = ACTION FORM prop OBJECTS a, b, c MODAL SHORTCUT prop DEFAULT;

END
// -------------------- Свойство объект1-объект2-объект3-дата для yesNo со значением по-умолчанию НЕТ---------------------------- //

META metaCodeNameTripleObjectDateProperty(prop, object1, object2, object3, caption, type)

    prop##Date caption = DATA type (object1, object2, object3, DATE);
    name##prop##Date caption (object1, object2, object3, date) = name(prop##Date(object1, object2, object3, date));
    date##prop (object1, object2, object3, date) = GROUP MAX dateIn AND prop##Date(object1, object2, dateIn) AND dateIn <= (date AS DATE) BY object1, object2, date;
    prop caption (object1, object2, object3) = UNION OVERRIDE yesNo.no AND object1 IS object1 AND object2 IS object2 AND  object3 IS object3,
                                                     prop##Date(object1, object2, object3, date##prop(object1, object2, object3, currentDate()));
    name##prop caption (object1, object2, object3) = name(prop(object1, object2, object3));

    FORM addName##prop caption
    OBJECTS a=object1 FIXED PANEL, b=object2 FIXED PANEL,  c=object3 FIXED PANEL, d=DATE FIXED PANEL
    PROPERTIES name(a) READONLY, name(b) READONLY, name(c) READONLY, OBJVALUE(d), name##prop##Date(a, b, c, d);
    DESIGN addName##prop FROM DEFAULT {
        PROPERTY(name(a)) { focusable = FALSE; }
        PROPERTY(name(b)) { focusable = FALSE; }
        PROPERTY(name(c)) { focusable = FALSE; }
    }

    showFormAddName##prop 'Добавить' (object1, object2, object3) = ACTION FORM addName##prop OBJECTS a, b, c MODAL;

    FORM name##prop caption
    OBJECTS a=object1 FIXED PANEL, b=object2 FIXED PANEL, c=object3 FIXED PANEL, d=DATE
    PROPERTIES name(a) READONLY, name(b) READONLY, name(c) READONLY, showFormAddName##prop(a, b, c), OBJVALUE(d), name##prop##Date(a, b, c, d)
    FILTERS NOT NULL prop##Date(a, b, c, d);
    DESIGN name##prop FROM DEFAULT {
        PROPERTY(name(a)) { focusable = FALSE; }
        PROPERTY(name(b)) { focusable = FALSE; }
        PROPERTY(name(c)) { focusable = FALSE; }
    }

    showFormName##prop caption (object1, object2, object3) = ACTION FORM name##prop OBJECTS a, b, c MODAL SHORTCUT name##prop DEFAULT;

END

// ----------------------------------- Отображение атрибутов товаров по свойству товарной группы ------------------------------------------ //
META metaCodeShowItemAttribute (attribute, caption)

show##attribute##ItemGroup caption (itemGroup) = DATA BOOLEAN (itemGroup) IN baseGroup;
toShow##attribute caption (item) = show##attribute##ItemGroup(itemGroupSku(item));

END

// ----------------------------------- Товарный классификатор ------------------------------------------ //
CLASS itemGroup 'Товарная группа' : named, externalObject;

parentItemGroup = DATA itemGroup (itemGroup);
nameParentItemGroup 'Родительская группа' = name(parentItemGroup(itemGroup));
maxTurnoverItemGroup 'Максимально допустимая товарооборачиваемость' (itemGroup) = DATA INTEGER (itemGroup);
minTurnoverItemGroup 'Минимально допустимая товарооборачиваемость' (itemGroup) = DATA INTEGER (itemGroup);

// формы за формами товара

// ----------------------------------- Единицы измерения ------------------------------------------ //
CLASS unitOfMeasure 'Единица измерения' : doubleNamed;

unitOfMeasureUnitOfMeasure 'Базовая ед.изм. ИД' = DATA unitOfMeasure(unitOfMeasure) IN idGroup;
shortNameUnitOfMeasureUnitOfMeasure 'Базовая ед.изм.' (unitOfMeasure) = shortName(unitOfMeasureUnitOfMeasure(unitOfMeasure)) IN baseGroup;
rightUnitOfMeasure 'Разместить от значения: справа' = DATA BOOLEAN (unitOfMeasure) IN baseGroup;
useUnitOfMeasure 'Используется' = DATA BOOLEAN (unitOfMeasure) IN baseGroup;
factorUnitOfMeasure 'Коэффициент пересчета в баз.ед.' = DATA DOUBLE (unitOfMeasure) IN baseGroup;
weightUnitOfMeasure 'Для весовых товаров/услуг' = DATA BOOLEAN (unitOfMeasure) IN baseGroup;
pieceUnitOfMeasure 'Для штучных товаров/услуг' = DATA BOOLEAN (unitOfMeasure) IN baseGroup;


FORM unitOfMeasure 'Единица измерения'
OBJECTS u=unitOfMeasure FIXED PANEL
PROPERTIES(u) name, shortName, shortNameUnitOfMeasureUnitOfMeasure, factorUnitOfMeasure, rightUnitOfMeasure,
              useUnitOfMeasure, weightUnitOfMeasure, pieceUnitOfMeasure
EDIT unitOfMeasure OBJECT u;

FORM unitsOfMeasure 'Единицы измерений'
OBJECTS u=unitOfMeasure
PROPERTIES(u) READONLY name, shortName, shortNameUnitOfMeasureUnitOfMeasure, factorUnitOfMeasure, rightUnitOfMeasure,
              useUnitOfMeasure, weightUnitOfMeasure, pieceUnitOfMeasure
PROPERTIES(u) ADDFORM, EDITFORM, delete;

// ------------------------------------ Цвета ------------------------------------------------ //
CLASS color 'Цвет' : named;

FORM color 'Цвет'
OBJECTS c=color FIXED PANEL
PROPERTIES(c) name;

// ------------------------------------ Вкусы ------------------------------------------------------ //
CLASS taste 'Вкус' : named;

FORM taste 'Вкус'
OBJECTS t=taste FIXED PANEL
PROPERTIES(t) name;

// ----------------------------------- Производители ---------------------------------- //
//CLASS manufacturer 'Производитель' : named;

//------------------------------------ Сорта-категории --------------------------------- //
CLASS sort 'Сорт/Категория' : named;

FORM sort 'Сорт/Категория'
OBJECTS s=sort FIXED PANEL
PROPERTIES(s) name;

//------------------------------------ Упаковки ----------------------------------------//
CLASS pack 'Упаковка' : doubleNamed;

FORM pack 'Упаковка'
OBJECTS p=pack FIXED PANEL
PROPERTIES(p) name, shortName;

//------------------------------------ Особенности изготовления ------------------------//
CLASS specialty 'Особенность' : doubleNamed;

FORM specialty 'Особенность'
OBJECTS s=specialty FIXED PANEL
PROPERTIES(s) name, shortName;

//------------------------------------ Размеры/Калибры/Габариты ------------------------//
CLASS size 'Размер/калибр' : doubleNamed;

FORM size 'Размер/калибр'
OBJECTS s=size FIXED PANEL
PROPERTIES(s) name, shortName;

//------------------------------------ Степень охлаждения ------------------------//
CLASS coolingDegree 'Степень охлаждения' : doubleNamed;

FORM coolingDegree 'Степень охлаждения'
OBJECTS c=coolingDegree FIXED PANEL
PROPERTIES(c) name, shortName;

//------------------------------- Ценники ------------------------------------//
CLASS tag 'Ценник' : named;

FORM tag 'Ценник'
OBJECTS t=tag FIXED PANEL
PROPERTIES(t) name;

//------------------------------- Строки 1-торг ------------------------------------//
CLASS rowTorg1 'Строка формы 1-торг' : named;

FORM rowTorg1 'Строка формы 1-торг'
OBJECTS r=rowTorg1 FIXED PANEL
PROPERTIES(r) name;

//------------------------------- Виды ------------------------------------//
CLASS typeItem 'Вид' : named;

FORM typeItem 'Вид'
OBJECTS t=typeItem FIXED PANEL
PROPERTIES(t) name;

// ----------------------------------- Товар ------------------------------------------ //
GROUP descriptionGroup 'Общее описание' : baseGroup;
GROUP sizeGroup 'Физические характеристики' : publicGroup;
GROUP substanceGroup 'Пищевые характеристики' : publicGroup;
GROUP retailGroup 'Ценовые характеристики' : publicGroup;
GROUP expiryGroup 'Сроки годности' : publicGroup;
GROUP equipmentGroup 'Кассы/весы/ценники' : publicGroup;
GROUP manufactoryGroup 'Собственное производство' : publicGroup;


CLASS ABSTRACT sku 'SKU' : named;
CLASS itemComponent 'itemComponent' : sku;
CLASS item 'Товар' : itemComponent;
CLASS dish 'Блюдо' : sku;
CLASS ware 'Посуда' : sku;

CLASS brand 'Бренд' : named;

CLASS STATIC groupProduct 'Группа изделий для печати заборного листа'
{
   hot 'Горячее',
   cold  'Холодное'
};

//baseGroup
itemGroupSku = DATA itemGroup(sku) IN idGroup;
nameItemGroupSku 'Группа товара' = name(itemGroupSku(sku)) IN baseGroup;

//descriptionGroup
brandItem = DATA brand(item);
nameBrandItem 'Бренд' (item) = name(brandItem(item)) IN descriptionGroup;
@metaCodeShowItemAttribute(Brand, 'Показывать бренд');

typeItemItem = DATA typeItem(item) IN idGroup;
nameTypeItemItem 'Вид' = name(typeItemItem(item)) IN descriptionGroup;
@metaCodeShowItemAttribute(Type, 'Показывать тип');

unitOfMeasureItem = DATA unitOfMeasure (item) IN idGroup;
shortNameUnitOfMeasureItem 'Единица измерения' (item) = shortName(unitOfMeasureItem(item)) IN descriptionGroup;
@metaCodeShowItemAttribute(UnitOfMeasure, 'Показывать ед.измерения');

sortItem = DATA sort(item) IN idGroup;
nameSortItem 'Сорт/категория товара' = name(sortItem(item)) IN descriptionGroup;
@metaCodeShowItemAttribute(Sort, 'Показывать сорт');

packItem = DATA pack(item) IN idGroup;
shortNamePackItem 'Упаковка' = shortName(packItem(item)) IN descriptionGroup;
@metaCodeShowItemAttribute(Pack, 'Показывать упаковку');

specialtyItem = DATA specialty(item) IN idGroup;
shortNameSpecialtyItem 'Особенности' = shortName(specialtyItem(item)) IN descriptionGroup;
@metaCodeShowItemAttribute(Specialty, 'Показывать особенности');

sizeItem = DATA size(item) IN idGroup;
shortNameSizeItem 'Размер/калибр' = shortName(sizeItem(item)) IN descriptionGroup;
@metaCodeShowItemAttribute(Size, 'Показывать размер');

colorItem = DATA color (item) IN idGroup;
nameColorItem 'Цвет' = name(colorItem(item)) IN descriptionGroup;
@metaCodeShowItemAttribute(Color, 'Показывать цвет');

tasteItem = DATA taste (item) IN idGroup;
nameTasteItem 'Вкус' = name(tasteItem(item)) IN descriptionGroup;
@metaCodeShowItemAttribute(Taste, 'Показывать вкус');

hallmarkItem 'Отличительный признак (особенности)' = DATA STRING[100] (item) IN descriptionGroup;
@metaCodeShowItemAttribute(Hallmark, 'Показывать отличительный признак');

articleItem 'Артикул поставщика/производителя' = DATA STRING[100] (item) IN descriptionGroup;

coolingDegreeItem 'Степень охлаждения (ИД)' = DATA coolingDegree (item) IN idGroup;
nameCoolingDegreeItem 'Степень охлаждения' = name(coolingDegreeItem(item)) IN descriptionGroup;
@metaCodeShowItemAttribute(CoolingDegree, 'Показывать степень охлаждения');

countryItem = DATA country (item) IN idGroup;
nameCountryItem 'Страна' = name(countryItem(item)) IN descriptionGroup;
@metaCodeShowItemAttribute(Country, 'Показывать страну');

isManufacturedItem 'Товар производится' = DATA BOOLEAN (item) IN descriptionGroup;
hintItem 'Подсказка по товару' = DATA STRING[200] (item) IN descriptionGroup;

wareItem = DATA ware (item) IN idGroup;
nameWareItem 'Посуда' = name(wareItem(item)) IN descriptionGroup;
@metaCodeShowItemAttribute(Ware, 'Показывать посуду');

//equipmentGroup
isWeightItem 'Весовой товар' = DATA BOOLEAN (itemComponent) IN equipmentGroup;
isWeightedItem 'Признак взвешиваемого товара' = DATA BOOLEAN (item) IN equipmentGroup;
compositionScalesItem 'Состав товара (ингредиенты) для весов' = DATA STRING[400] (item)IN equipmentGroup;
tagItem 'Ценник (ИД)' = DATA tag (item) IN idGroup;
nameTagItem 'Ценник' = name(tagItem(item)) IN equipmentGroup;
multiplierItem 'Множитель для печати ценника' = DATA DOUBLE (item) IN equipmentGroup;
isMarkItem 'Маркировать товар' = DATA BOOLEAN (item) IN equipmentGroup;
isLoafCutItem 'Буханка разрезается' = DATA BOOLEAN (item) IN equipmentGroup;
passScalesItem 'Передавать на весы' = DATA BOOLEAN (item) IN equipmentGroup;

//substanceGroup
percentFatItem '% жирности' =  DATA DOUBLE (item) IN substanceGroup;
percentAlcoholItem '% алкоголя' =  DATA DOUBLE (item) IN substanceGroup;
nutritionalValueItem 'Энергетическая и пищевая ценность' = DATA STRING[400] (item) IN substanceGroup;
energyItem 'Энергетическая ценность на 100г, ккал' = DATA DOUBLE (item) IN substanceGroup;
fatsItem 'Жиры на 100г, г' = DATA DOUBLE (item) IN substanceGroup;
carbohydratesItem 'Углеводы на 100г, г' = DATA DOUBLE (item) IN substanceGroup;
proteinsItem 'Белки на 100г, г' = DATA DOUBLE (item) IN substanceGroup;
isContainGMOItem 'Содержит ГМО' = DATA BOOLEAN (item) IN substanceGroup;

//sizeGroup
lengthItem 'Длина товара' = DATA INTEGER (item) IN sizeGroup;
widthItem 'Ширина товара' = DATA INTEGER (item) IN sizeGroup;
heightItem 'Высота товара' = DATA INTEGER (item) IN sizeGroup;
grossWeightItem 'Вес брутто товара' = DATA DOUBLE (item) IN sizeGroup;
lengthPackItem 'Длина упаковки' = DATA INTEGER (item) IN sizeGroup;
widthPackItem 'Ширина упаковки' = DATA INTEGER (item) IN sizeGroup;
heightPackItem 'Высота упаковки' = DATA DOUBLE (item) IN sizeGroup;
grossWeightPackItem 'Вес брутто упаковки' = DATA DOUBLE (item) IN sizeGroup;
volumeItem 'Объём' = DATA DOUBLE (item) IN sizeGroup;
netWeightItem 'Вес нетто' = DATA DOUBLE (item) IN sizeGroup;
quantityPackItem 'Количество в грузовом месте' = DATA DOUBLE (item) IN sizeGroup;

//retailGroup
minResourceItem 'Минимальный запас' = DATA INTEGER (item) IN retailGroup;
minReserveItem 'Минимальный резерв' = DATA INTEGER (item) IN retailGroup;
bonusReturnItem 'Уценка (бонус) по товару при возврате поставщику' = DATA DOUBLE (item) IN retailGroup;
nameReturnItem 'Наименование для уценки, бонуса по товару в возврат' = DATA STRING[200] (item) IN retailGroup;
quantityDiscountItem 'Количество товара, при котором предост-ся скидка' = DATA INTEGER (item) IN retailGroup;
fixPriceItem 'Фиксированная цена при соотв.типе скидки' = DATA INTEGER (item) IN retailGroup;
isFixPriceItem 'Товар с фиксированной ценой' = DATA BOOLEAN (item) IN retailGroup;
banMarkdownItem 'Запретить уценку товара' = DATA BOOLEAN (item) IN retailGroup;
oldPriceItem 'Старая цена для печати на ценник' = DATA DOUBLE (item) IN retailGroup;
minTradeAllowanceItem 'MIN допустимая торговая надбавка, %' = DATA DOUBLE (item) IN retailGroup;
maxTradeAllowanceItem 'MAX допустимая торговая надбавка, %' = DATA DOUBLE (item) IN retailGroup;
minAllowedRetailPriceItem 'MIN допустимая розн.цена' = DATA INTEGER (item) IN retailGroup;
bonusItem 'Бонус получаемый по товару' = DATA DOUBLE (item) IN retailGroup;
percentWholesaleMarkItem '% оптовой надбавки' = DATA DOUBLE (item) IN retailGroup;

//expiryGroup

controlExpiryItem 'Контролировать сроки годности товара?' = DATA BOOLEAN (item) IN expiryGroup;
daysExpiryItem 'Срок годности в днях' = DATA DOUBLE (item) IN expiryGroup;
daysExpiryPackItem 'Срок годности в днях с момента фасовки' = DATA DOUBLE (item) IN expiryGroup;
hoursExpiryPackItem 'Срок годности в часах с момента фасовки' = DATA INTEGER (item) IN expiryGroup;

//manufactoryGroup
isCrudeItem 'Товар-сырьё для калькуляции?' = DATA BOOLEAN (item) IN manufactoryGroup;

groupProductItem = DATA groupProduct (item) IN idGroup;
nameGroupProductItem 'Группа изделий для печати заборного листа' = name(groupProductItem(item)) IN manufactoryGroup;

compositionMenuItem 'Состав изделия для печати в меню' = DATA STRING[400] (item)IN manufactoryGroup;
standartItem 'Стандарт изготовления изделия (СТБ и пр.)' = DATA STRING[100] (item) IN manufactoryGroup;
normOutItem 'Норма выхода для печати в меню и калькуляцию' = DATA STRING[100] (item) IN manufactoryGroup;
groupMenuItem 'Группа для печати в меню' = DATA STRING[100] (item) IN manufactoryGroup;
isCutedItem 'Товар разрубается/прорабатывается' = DATA BOOLEAN (item) IN manufactoryGroup;
storageTemperatureItem 'Температура хранения' =  DATA STRING[100] (item) IN manufactoryGroup;

rowTorg1Item 'Строка формы 1-торг (ИД)' = DATA rowTorg1(item) IN idGroup;

// ----------------------------------- Атрибуты ------------------------------------------ //

CLASS ABSTRACT itemAttribute 'Атрибут товара' : named;

CLASS STATIC stringItemAttribute 'Строковый атрибут' {
    nameItem 'Наименование',
    article 'Артикул'
} : itemAttribute;

valueNameItemAttribute(item, attribute) = castToString255(name(item)) AND attribute == stringItemAttribute.nameItem;
valueArticleItemAttribute(item, attribute) = castToString255(articleItem(item)) AND attribute == stringItemAttribute.article;

valueStringItemAttribute(item, attribute) = UNION EXCLUSIVE  valueNameItemAttribute(item, attribute),
                                                             valueArticleItemAttribute(item, attribute);

CLASS STATIC integerItemAttribute 'Целочисленный атрибут' {
    length 'Длина',
    width 'Ширина',
    height 'Высота'
} : itemAttribute;

valueLengthItemAttribute(item, attribute) = lengthItem(item) AND attribute == integerItemAttribute.length;
valueWidthItemAttribute(item, attribute) = widthItem(item) AND attribute == integerItemAttribute.width;
valueHeightItemAttribute(item, attribute) = heightItem(item) AND attribute == integerItemAttribute.height;

valueIntegerItemAttribute(item, attribute) = UNION EXCLUSIVE valueLengthItemAttribute(item, attribute),
                                                             valueWidthItemAttribute(item, attribute),
                                                             valueHeightItemAttribute(item, attribute);
stringIntegerItemAttribute(item, attribute) = castToString255(valueIntegerItemAttribute(item, attribute));

CLASS STATIC doubleItemAttribute 'Дробный атрибут' {
    netWeight 'Вес нетто',
    grossWeight 'Вес брутто'
} : itemAttribute;

valueNetWeightItemAttribute(item, attribute) = netWeightItem(item) AND attribute == doubleItemAttribute.netWeight;
valueGrossWeightItemAttribute(item, attribute) = grossWeightItem(item) AND attribute == doubleItemAttribute.grossWeight;

valueDoubleItemAttribute(item, attribute) = UNION EXCLUSIVE valueNetWeightItemAttribute(item, attribute),
                                                            valueGrossWeightItemAttribute(item, attribute);
stringDoubleItemAttribute(item, attribute) = castToString255(valueDoubleItemAttribute(item, attribute));

CLASS STATIC booleanItemAttribute 'Логический атрибут' {
    fixPrice 'Товар с фиксированной ценой',
    manufactured 'Товар производится'
} : itemAttribute;

valueFixPriceWeightItemAttribute(item, attribute) = isFixPriceItem(item) AND attribute == booleanItemAttribute.fixPrice;
valueManufacturedItemAttribute(item, attribute) = isManufacturedItem(item) AND attribute == booleanItemAttribute.manufactured;

valueBooleanItemAttribute(item, attribute) = UNION EXCLUSIVE valueFixPriceWeightItemAttribute(item, attribute),
                                                             valueManufacturedItemAttribute(item, attribute);
stringBooleanItemAttribute(item, attribute) = castToString255(valueBooleanItemAttribute(item, attribute));

CLASS STATIC objectItemAttribute 'Объектный атрибут' {
    unitOfMeasure 'Единица измерения',
    brand 'Брэнд',
    typeItem 'Вид',
    sort 'Сорт/категория',
    pack 'Упаковка',
    specialty 'Особенность',
    size 'Размер/калибр',
    coolingDegree 'Степень охлаждения',
    color 'Цвет',
    taste 'Вкус'

} : itemAttribute;

valueUOMItemAttribute(item, attribute) = unitOfMeasureItem(item) AND attribute == objectItemAttribute.unitOfMeasure;
valueBrandItemAttribute(item, attribute) = brandItem(item) AND attribute == objectItemAttribute.brand;
valueTypeItemAttribute(item, attribute) = typeItemItem(item) AND attribute == objectItemAttribute.color;
valueSortItemAttribute(item, attribute) = sortItem(item) AND attribute == objectItemAttribute.color;
valuePackItemAttribute(item, attribute) = packItem(item) AND attribute == objectItemAttribute.color;
valueSpecialtyItemAttribute(item, attribute) = specialtyItem(item) AND attribute == objectItemAttribute.color;
valueSizeItemAttribute(item, attribute) = sizeItem(item) AND attribute == objectItemAttribute.color;
valueCoolingDegreeItemAttribute(item, attribute) = coolingDegreeItem(item) AND attribute == objectItemAttribute.color;
valueColorItemAttribute(item, attribute) = colorItem(item) AND attribute == objectItemAttribute.color;
valueTasteItemAttribute(item, attribute) = tasteItem(item) AND attribute == objectItemAttribute.taste;

valueObjectItemAttribute(item, attribute) = UNION EXCLUSIVE valueUOMItemAttribute(item, attribute),
                                                            valueBrandItemAttribute(item, attribute),
                                                            valueTypeItemAttribute(item, attribute),
                                                            valueSortItemAttribute(item, attribute),
                                                            valuePackItemAttribute(item, attribute),
                                                            valueSpecialtyItemAttribute(item, attribute),
                                                            valueSizeItemAttribute(item, attribute),
                                                            valueCoolingDegreeItemAttribute(item, attribute),
                                                            valueColorItemAttribute(item, attribute),
                                                            valueTasteItemAttribute(item, attribute);
nameObjectItemAttribute(item, attribute) = name(valueObjectItemAttribute(item, attribute));

valueItemAttribute(item, attribute) = UNION EXCLUSIVE valueStringItemAttribute(item, attribute),
                                                      stringIntegerItemAttribute(item, attribute),
                                                      stringDoubleItemAttribute(item, attribute),
                                                      stringBooleanItemAttribute(item, attribute),
                                                      nameObjectItemAttribute(item, attribute);


// ----------------------------------- Штрих код ------------------------------------------ //
GROUP barcodeGroup : baseGroup;

CLASS barcode 'Штрих код' : barcodeObject;

inSkuBarcode 'Присоединение штрих-кода к товару' = DATA BOOLEAN (sku, barcode) IN baseGroup;

titleScalesBarcode 'Наименование для весов' = DATA STRING[100] (barcode) IN barcodeGroup;
titleCashBarcode 'Наименование для касс' = DATA STRING[100] (barcode) IN barcodeGroup;
unitOfMeasureBarcode = DATA unitOfMeasure (barcode) IN idGroup;
shortNameUnitOfMeasureBarcode 'Единица измерения' (barcode) = shortName(unitOfMeasureBarcode(barcode)) IN barcodeGroup;
amountBarcode 'Количество (сколько списать при продаже)' = DATA INTEGER (barcode) IN barcodeGroup;
removeBarcode 'Заблокирован (удален с оборудования)' = DATA BOOLEAN (barcode) IN barcodeGroup;
commentRemoveBarcode 'Причина блокировки' = DATA STRING[100] (barcode) IN barcodeGroup;

userBarcodeSku = DATA barcode(sku) IN idGroup;
//barcodeUserBarcodeSku 'Установленный штрих-код' = barcode(userBarcodeSku(sku)) IN baseGroup;

defaultBarcodeSku(sku) = GROUP MAX barcode IF inSkuBarcode(sku, barcode) BY sku IN idGroup;
barcodeSku(sku) = UNION OVERRIDE defaultBarcodeSku(sku), userBarcodeSku(sku) IN baseGroup;

CONSTRAINT CHECKED item IS item AND NOT inSkuBarcode(item, barcodeSku(item)) MSG 'Товар основного штрих-кода должен совпадать с товаром';

barcodeBarcodeSku  'Основной штрих-код' = barcode(barcodeSku(sku)) IN baseGroup;

FORM barcode 'Штрих-код'
OBJECTS b=barcode
PROPERTIES(b) barcode;


// ----------------------------------- Компоненты ------------------------------------------ //
CLASS component 'Компонент' : sku;

nettoBruttoCoeffComponent 'Сезонный коэффициент пересчета сырья из нетто в брутто' (component) = DATA DOUBLE (component) IN baseGroup;
percentHumidityFlourDepartmentStoreComponent '% влажности муки' = DATA DOUBLE (departmentStore, component) IN baseGroup;

FORM component 'Компонент'
OBJECTS c=component FIXED PANEL
PROPERTIES(c) name, nettoBruttoCoeffComponent
EDIT component OBJECT c;

FORM components 'Компоненты'
OBJECTS c=component
PROPERTIES(c) READONLY name, nettoBruttoCoeffComponent
PROPERTIES(c) ADDFORM, EDITFORM, delete;


// ----------------------------------- Генерация графика --------------------------------------- //

CLASS STATIC genType 'Тип генерации' {
    genWeek 'Генерация каждые N недель',
    genDay 'Генерация через N дней',
    genNumber 'Генерация по числам',
    genDayMonth 'Генерация по дням недели и месяца'

};

CLASS genTimeTable 'Генерация графика' : named;

genTimeTableType 'Тип генерации графика (ИД)' = DATA genType (genTimeTable);
nameGenTimeTableType 'Тип генерации графика' (genTimeTable) = name(genTimeTableType(genTimeTable)) IN baseGroup;
startDateGenTimeTable 'Дата начала' = DATA DATE (genTimeTable) IN baseGroup;
endDateGenTimeTable 'Дата окончания' = DATA DATE (genTimeTable) IN baseGroup;
supplierGenTimeTable 'Поставщик (ИД)' = DATA supplier (genTimeTable);
nameSupplierGenTimeTable 'Поставщик' (genTimeTable) = name(supplierGenTimeTable(genTimeTable)) IN baseGroup;
departmentStoreGenTimeTable 'Подразделение (ИД)' =DATA departmentStore (genTimeTable);
nameDepartmentStoreGenTimeTable 'Подразделение' (genTimeTable) = name(departmentStoreGenTimeTable(genTimeTable)) IN baseGroup;

inMonthGenTimeTable 'Включать' = DATA BOOLEAN (genTimeTable, captionMonth);
inDayGenTimeTable 'Включать' = DATA BOOLEAN (genTimeTable, captionDOW);
inAllMonthGenTable 'Включить все месяцы' = DATA BOOLEAN (genTimeTable);
inMonthGenTimeTable(genTimeTable, captionMonth) <- inAllMonthGenTable(genTimeTable) ON ASSIGN inAllMonthGenTable(genTimeTable) AND captionMonth IS captionMonth;
toShowGenDayMonth (genTimeTable) = genTimeTableType(genTimeTable) == genType.genDayMonth;

FORM genTimeTable 'Генерация графика'
OBJECTS g=genTimeTable FIXED PANEL, m=captionMonth, d=captionDOW
PROPERTIES(g) nameGenTimeTableType, nameSupplierGenTimeTable, nameDepartmentStoreGenTimeTable, startDateGenTimeTable, endDateGenTimeTable, inAllMonthGenTable SHOWIF toShowGenDayMonth(g)
PROPERTIES(m) READONLY name SHOWIF toShowGenDayMonth(g)
PROPERTIES(d) READONLY name SHOWIF toShowGenDayMonth(g)
PROPERTIES(g, m) inMonthGenTimeTable SHOWIF toShowGenDayMonth(g)
PROPERTIES(g, d) inDayGenTimeTable SHOWIF toShowGenDayMonth(g)
EDIT genTimeTable OBJECT g;

FORM genTimeTables 'Графики' //служит для добавления сущности "генерации графиков" и в дальнейшем будет удалена
OBJECTS g=genTimeTable
PROPERTIES(g) READONLY name
PROPERTIES(g) ADDFORM, EDITFORM, delete;

showFormGenTimeTable 'Добавить график' (genTimeTable) = ACTION FORM genTimeTable OBJECTS g MODAL;

// ----------------------------------- Склад ------------------------------------------ //

CLASS ABSTRACT stock 'Склад' : named;

// ----------------------------------- Магазин ----------------------------------------- //

CLASS store 'Магазин' : named;
CLASS tradingNetwork 'Торговая сеть' : named; // "Рублевский", "Базар"
CLASS storeType 'Формат магазина' : named; //Мини, Супер, ...

companyStore 'Юридическое лицо магазина (ИД)' = DATA company (store);
nameCompanyStore 'Юридическое лицо магазина' (store) = name(companyStore(store)) IN baseGroup;
addressStore 'Адрес магазина' = DATA STRING[100] (store);

storeTypeStore 'Формат магазина (ИД)' = DATA storeType (store);
nameStoreTypeStore 'Формат магазина' (store) = name(storeTypeStore(store)) IN baseGroup;

tradingNetworkStoreType 'Торговая сеть формата магазина (ИД)' = DATA tradingNetwork (storeType);
nameTradingNetworkStoreType 'Торговая сеть формата магазина' (storeType) = name(tradingNetworkStoreType(storeType)) IN baseGroup;

inStoreTypeTradingNetwork(storeType, tradingNetwork) = tradingNetworkStoreType(storeType) == tradingNetwork;

// ----------------------------------- Физические лица -------------------------------------------------- //

GROUP employeeGroup 'Пользовательская информация' : baseGroup;

CLASS ABSTRACT person 'Физическое лицо';
CLASS employee 'Сотрудник' : person, customUser;
CLASS employeeSystem 'Операционная система';


nameEmployeeSystem 'Операционная система' = DATA STRING[100] (employeeSystem) IN employeeGroup;
employeeSystemEmployee(employee) = DATA employeeSystem (employee) IN idGroup;
nameEmployeeSystemEmployee 'Операционная система на рабочем месте пользователя' (employee) = nameEmployeeSystem(employeeSystemEmployee(employee)) IN employeeGroup;

languageEmployee(employee) = DATA language (employee) IN idGroup;
nameLanguageEmployee 'Язык интерфейса' = name(languageEmployee(employee)) IN employeeGroup;
shortNameLanguageEmployee 'Язык интерфейса сокр.' = shortName(languageEmployee(employee)) IN employeeGroup;
numberEmployee 'Номер кассира для касс' = DATA STRING[10] (employee) IN employeeGroup;
passwordEmployee 'Пароль для касс' = DATA STRING[20] (employee) IN employeeGroup;
dataEmployee 'Данные для регистрации на кассе (штрих-код)' = DATA STRING[20] (employee) IN employeeGroup;


departmentStoreEmployee 'Сотрудник отдела' = DATA BOOLEAN (departmentStore, employee);
phoneEmployee 'Телефон' = DATA STRING[50] (employee) IN employeeGroup;


FORM employee 'Сотрудник'
OBJECTS e=employee FIXED PANEL, d=departmentStore
PROPERTIES(e) userFirstName, userLastName, phoneEmployee, nameEmployeeSystemEmployee, shortNameLanguageEmployee, numberEmployee,
              passwordEmployee, dataEmployee
PROPERTIES(d) name
PROPERTIES(d, e) departmentStoreEmployee
FILTERGROUP filterEmployeeDepartmentStore
    FILTER 'Показывать только отделы данного сотрудника' 'F10' NOT NULL departmentStoreEmployee(d, e)
EDIT employee OBJECT e;

FORM employees 'Сотрудники'
OBJECTS e=employee, d=departmentStore
PROPERTIES(e) READONLY userFirstName, userLastName
PROPERTIES(e) ADDFORM, EDITFORM, delete
PROPERTIES(d) READONLY name
FILTERS NOT NULL departmentStoreEmployee(d, e);

// ----------------------------------- Торговая площадь -------------------------------------------------- //

CLASS tradingSquare 'Торговая площадь' : named;
squareTradingSquare 'Размер торговой площади' = DATA DOUBLE (tradingSquare) IN baseGroup;
departmentStoreTradingSquare 'Отдел торговой площади (ИД)' = DATA departmentStore (tradingSquare);
nameDepartmentStoreTradingSquare 'Отдел торговой площади' (tradingSquare) = name(departmentStoreTradingSquare(tradingSquare)) IN baseGroup;
dateTradingSquare 'Дата' = DATA DATE (tradingSquare) IN baseGroup;

FORM tradingSquare 'Торговая площадь'
OBJECTS s=tradingSquare FIXED PANEL
PROPERTIES(s) name, squareTradingSquare, nameDepartmentStoreTradingSquare, dateTradingSquare
EDIT tradingSquare OBJECT s;

// ------------------------------------- Скидки ---------------------------------------------------------- //

TABLE departmentStoreDate (object, DATE);

@metaCodeNameObjectDateProperty(discount, departmentStore, 'Разрешать скидки', yesNo, baseGroup);

// ----------------------------------- Отдел магазина (Подразделение) ----------------------------------- //

CLASS departmentStore 'Отдел магазина' : stock;
CLASS kafeteria 'Кафетерий' : departmentStore;
CLASS tradingFloar 'Торговый зал' : departmentStore;
CLASS wholesaleStock 'Оптовый склад' : departmentStore;
CLASS placeOfAcceptance 'Приемный пункт' : departmentStore;
CLASS restaurant 'Ресторан' : departmentStore;
//CLASS stock 'Склад' : departmentStore; в дальнейшем будет распределительный центр
CLASS manufactory 'Цех' : departmentStore;

CLASS STATIC itemStatus 'Статус товара'
{
    notTransfer '0',
    transfer '1',
    delete '2',
    requireTransfer '3',
    requireDelete '4'
};

storeDepartmentStore 'Магазин отдела (ИД)' = DATA store (departmentStore);
nameStoreDepartmentStore 'Магазин' (departmentStore) = name(storeDepartmentStore(departmentStore)) IN baseGroup;
revaluationCommitteeDepartmentStore 'Комиссия отдела (ИД)' = DATA revaluationCommittee (departmentStore);
nameRevaluationCommitteeDepartmentStore 'Комиссия отдела' (departmentStore) = name(revaluationCommitteeDepartmentStore(departmentStore));
controlMinusRestsDepartmentStore 'Контроль за минусовыми остатками' = DATA BOOLEAN (departmentStore);
deleteItemMinusRestsDepartmentStore 'Удалять товары с отрицательным остатком с весов и касс?' = DATA BOOLEAN (departmentStore);
controlMinusRestsContainerDepartmentStore 'Контроль за минусовыми остатками тары' = DATA BOOLEAN (departmentStore);
// controlAssortmentProviderDepartmentStore 'Контролировать ассортимент поставщиков в подразделении?' = DATA BOOLEAN (departmentStore);
verifyOrderArrivalDepartmentStore 'Сверять заказ и приход в подразделении?' = DATA BOOLEAN (departmentStore);
maxQuantityDeliveryHourDepartmentStore 'Максимальное допустимое число поставок в час' = DATA INTEGER (departmentStore);
resolveMaxQuantityDeliveryHourAssortmentLessDepartmentStore 'Разрешить превысить количество поставок/час при ассортименте <' = DATA DOUBLE (departmentStore);
resolveOrderItemDepartmentStore 'Разрешить заказ товара в подразделение?' = DATA BOOLEAN (departmentStore);
quantityCashChangeOneOperationAccountDepartmentStore ' Количество кассовых смен в одном оперативном отчете' = DATA INTEGER (departmentStore);
materiallyResponsiblePersonItemReportDepartmentStore 'Материально ответственное лицо, подписывающее товарный отчет (ИД)' = DATA employee (departmentStore);
commonNameMateriallyResponsiblePersonItemReportDepartmentStore 'Материально ответственное лицо, подписывающее товарный отчет' (departmentStore) = commonName (materiallyResponsiblePersonItemReportDepartmentStore(departmentStore));
bookkeeperItemReportDepartmentStore 'Бухгалтер, принимающий товарный отчет (ИД)' = DATA employee (departmentStore);
commonNameBookkeeperItemReportDepartmentStore 'Бухгалтер, принимающий товарный отчет' (departmentStore) = commonName(bookkeeperItemReportDepartmentStore(departmentStore));
personCheckReportDepartmentStore 'Кто проверяет товарный отчет (ИД)' = DATA employee (departmentStore);
commonNamePersonCheckReportDepartmentStore 'Кто проверяет товарный отчет' (departmentStore) = commonName(personCheckReportDepartmentStore(departmentStore));
idTradingSquareDepartmentStore 'Торговая площадь отдела магазина' (departmentStore) = GROUP MAX tradingSquare BY departmentStoreTradingSquare(tradingSquare);   //максимизирует только по ID, переделать после расширения функционала
defaultTradingSquareDepartmentStore 'Торговая площадь отдела магазина, кв.м.' (departmentStore) = squareTradingSquare(idTradingSquareDepartmentStore(departmentStore));
tradingSquareStore 'Торговая площадь магазина' = GROUP SUM defaultTradingSquareDepartmentStore(departmentStore) BY storeDepartmentStore(departmentStore);

inStoreDepartment(store, departmentStore) = storeDepartmentStore(departmentStore) == store;
inTradingSquareDepartmentStore(departmentStore, tradingSquare) = departmentStoreTradingSquare(tradingSquare) == departmentStore;

// ----------------------------------- Цех ----------------------------------- //

outDepartmentManufactory 'Подразделение, куда передаются изделия (ИД)' (manufactory) = DATA departmentStore(manufactory) IN idGroup;
nameOutDepartmentManufactory 'Подразделение, куда передаются изделия' (manufactory) = name(outDepartmentManufactory(manufactory)) IN manufactoryGroup;
inPriceDepartmentManufactory 'Подразделение, откуда брать цены (ИД)' (manufactory) = DATA departmentStore(manufactory) IN idGroup;
nameInPriceDepartmentManufactory 'Подразделение, откуда брать цены ' (manufactory) = name(inPriceDepartmentManufactory(manufactory)) IN manufactoryGroup;
marginPublicCateringManufactory 'Наценка общепита по умолчанию для формирования цены в подразделении' (manufactory) = DATA DOUBLE (manufactory) IN manufactoryGroup;
rawDepartmentStore 'Подразделения, из которых можно получить сырье' = DATA BOOLEAN (manufactory, departmentStore);

inRawDepartmentStore(manufactory, departmentStore) = storeDepartmentStore(manufactory) == storeDepartmentStore(departmentStore);

//----------------------------------- Для товара и подразделения ------------------------------------------//
additionPriceDepartmentStoreItem 'Торговая надбавка в рублях' = DATA DOUBLE (departmentStore, item) IN baseGroup;
boundCertificateDepartmentStoreItem 'Сертификат / удостоверение обязательны для товара?' = DATA BOOLEAN (departmentStore, item) IN baseGroup;
maxAllowedRetailPriceDepartmentStoreItem 'MAX допустимая розн.цена' = DATA INTEGER (departmentStore, item) IN baseGroup;
netWeightManufacterDepartmentStoreItem 'Вес нетто продукта для производства' = DATA DOUBLE (departmentStore, itemComponent) IN baseGroup;
statusCashDepartmentStoreItem 'Статус товара на кассах (ИД)' = DATA itemStatus (departmentStore, item) IN idGroup;
nameStatusCashDepartmentStoreItem 'Статус товара на кассах' = name(statusCashDepartmentStoreItem (departmentStore, item)) IN baseGroup;

dateManufactureDepartmentStoreItem 'Дата изготовления' = DATA DATE (departmentStore, item) IN baseGroup;
dateFitToDepartmentStoreItem 'Годен до' = DATA DATE (departmentStore, item) IN baseGroup;
fromDateDeliveryDepartmentStoreItem 'Дату [Годен до] рассчитывать от даты поставки?' = DATA BOOLEAN (departmentStore, item) IN baseGroup;
banSaleDepartmentStoreItem 'Запрет продаж товара в подразделении' = DATA BOOLEAN (departmentStore, item) IN baseGroup;
banMovementDepartmentStoreItem 'Запрет на внутреннее перемещение товара' = DATA BOOLEAN (departmentStore, item) IN baseGroup;
reserveDepartmentStoreItem 'Резерв по товару' = DATA DOUBLE (departmentStore, item) IN baseGroup;

//------------------------------------ Товар с историей -------------------------------------------------------------//
GROUP historyGroup 'Изменяемые характеристики' : baseGroup;

@metaCodeNameObjectDateProperty(isPortionBarItem, item, 'Порционный товар для бара', yesNo, historyGroup);

@metaCodeNameObjectDateProperty(banDiscountItem, item, 'Запретить скидки по товару', yesNo, historyGroup);

@metaCodeObjectDateProperty(coefficientNetGrossItem, item, 'Сезонный коэффициент пересчета сырья из нетто в брутто', DOUBLE, historyGroup);

@metaCodeObjectDateProperty(rateNaturalLossItem, item, 'Норма естественной убыли,%', DOUBLE, historyGroup);

@metaCodeObjectDateProperty(NDSSupplierItem, item, 'НДС поставщика,%', DOUBLE, historyGroup);

@metaCodeObjectDateProperty(importerPriceItem, item, 'Цена импортёра', DOUBLE, historyGroup);


//------------------------------------ Товар для подразделения с историей -------------------------------------------//
//maxReserveItemDepartmentDate 'Максимально допустимый товарный запас в днях' = DATA DOUBLE (item, departmentStore, DATE) IN baseGroup;
//minReserveItemDepartmentDate 'Минимально допустимый товарный запас в днях' = DATA DOUBLE (item, departmentStore, DATE) IN baseGroup;
//banRevaluationItemDepartmentDate 'Запрет на переоценку' = DATA BOOLEAN (item, departmentStore, DATE) IN baseGroup;
//inActionItemDepartmentDate 'Товар акции' = DATA BOOLEAN (item, departmentStore, DATE) IN baseGroup;
//marginProductionItemDepartmentDate 'Наценка производства' = DATA DOUBLE (item, departmentStore, DATE) IN baseGroup;
//discountItemDepartmentDate 'Скидка для товара' = DATA STRING[100] (item, departmentStore, DATE) IN baseGroup;

TABLE itemDepartmentStoreDate (item, departmentStore, DATE);

@metaCodeDoubleObjectDateProperty(maxReserveItemDepartment, item, departmentStore, 'Максимально допустимый товарный запас в днях', DOUBLE);
@metaCodeDoubleObjectDateProperty(minReserveItemDepartment, item, departmentStore, 'Минимально допустимый товарный запас в днях', DOUBLE);

@metaCodeNameDoubleObjectDateProperty(banRevaluationItemDepartment, item, departmentStore, 'Запрет на переоценку', yesNo);

@metaCodeNameDoubleObjectDateProperty(inActionItemDepartment, item, departmentStore, 'Товар акции', yesNo);

@metaCodeDoubleObjectDateProperty(marginProductionItemDepartment, item, departmentStore, 'Наценка производства', DOUBLE);

@metaCodeDoubleObjectDateProperty(retailPriceItemDepartment, item, departmentStore, 'Розничная цена', DOUBLE);

@metaCodeDoubleObjectDateProperty(discountItemDepartment, item, departmentStore, 'Скидка для товара', STRING[100]);

//@metaCodeNameTripleObjectDateProperty(isSupplierItemDepartment, supplier, item, departmentStore, 'Поставщик', yesNo);


FORM item 'Товар'
OBJECTS i=item FIXED PANEL, b=barcode, d=departmentStore, s=supplier
PROPERTIES(i) name, nameItemGroupSku, barcodeBarcodeSku, isManufacturedItem, nameBrandItem SHOWIF toShowBrand(i), shortNameUnitOfMeasureItem SHOWIF toShowUnitOfMeasure(i), nameTypeItemItem SHOWIF toShowType(i),
 nameSortItem SHOWIF toShowSort(i), shortNamePackItem SHOWIF toShowPack(i), shortNameSizeItem SHOWIF toShowSize(i), shortNameSpecialtyItem SHOWIF toShowSpecialty(i),
 isWeightedItem, isWeightItem, volumeItem, netWeightItem, nameColorItem SHOWIF toShowColor(i), nameTasteItem SHOWIF toShowTaste(i),
 hallmarkItem SHOWIF toShowHallmark(i), articleItem, quantityPackItem, nameCoolingDegreeItem SHOWIF toShowCoolingDegree(i), minResourceItem, minReserveItem, compositionScalesItem, compositionMenuItem,
 percentFatItem, percentAlcoholItem, lengthItem, widthItem, heightItem, grossWeightItem, lengthPackItem, widthPackItem, heightPackItem, grossWeightPackItem,
 nameCountryItem SHOWIF toShowCountry(i), nutritionalValueItem, energyItem, fatsItem, carbohydratesItem, proteinsItem, isContainGMOItem,
 bonusReturnItem, nameReturnItem, quantityDiscountItem, fixPriceItem, isFixPriceItem,
 banMarkdownItem, oldPriceItem, nameTagItem, multiplierItem, controlExpiryItem, daysExpiryItem, isMarkItem, hintItem,
 isCrudeItem, nameGroupProductItem,
 nameWareItem SHOWIF toShowWare(i), daysExpiryPackItem, hoursExpiryPackItem, standartItem, normOutItem, groupMenuItem,
 isCutedItem, isLoafCutItem, storageTemperatureItem, passScalesItem, bonusItem, percentWholesaleMarkItem,
 minTradeAllowanceItem, maxTradeAllowanceItem, minAllowedRetailPriceItem
PROPERTIES(i) nameisPortionBarItem, showFormNameisPortionBarItem,
              namebanDiscountItem, showFormNamebanDiscountItem,
              coefficientNetGrossItem, showFormcoefficientNetGrossItem,
              rateNaturalLossItem, showFormrateNaturalLossItem,
              NDSSupplierItem, showFormNDSSupplierItem,
              importerPriceItem, showFormimporterPriceItem

PROPERTIES (b) barcode, titleScalesBarcode, titleCashBarcode, shortNameUnitOfMeasureBarcode, amountBarcode, removeBarcode, commentRemoveBarcode
//PROPERTIES inSkuBarcode(i, b)
PROPERTIES (d) name
PROPERTIES (i, d) FORCE PANEL maxReserveItemDepartment, showFormmaxReserveItemDepartment,
                  minReserveItemDepartment, showFormminReserveItemDepartment,
                  namebanRevaluationItemDepartment, showFormNamebanRevaluationItemDepartment,
                  nameinActionItemDepartment, showFormNameinActionItemDepartment,
                  marginProductionItemDepartment, showFormmarginProductionItemDepartment,
                  retailPriceItemDepartment, showFormretailPriceItemDepartment,
                  discountItemDepartment, showFormdiscountItemDepartment
//PROPERTIES (s, i, d) nameisSupplierItemDepartment, showFormNameisSupplierItemDepartment

FILTERS NOT NULL inSkuBarcode(i, b)
PROPERTIES(b) ADDOBJ, delete
EDIT item OBJECT i
EDIT barcode OBJECT b;

DESIGN item FROM DEFAULT {
    main {
       ADD item.box BEFORE b.box {
            tabbedPane = TRUE;
            ADD i.descriptionGroup;
            ADD i.retailGroup;
            ADD i.equipmentGroup;
            ADD i.sizeGroup {
                fillVertical = 1.0;
                fillHorizontal = 1.0;
            }
            ADD i.equipmentGroup;
            ADD i.substanceGroup;
            ADD i.manufactoryGroup{
                fillVertical = 1.0;
                fillHorizontal = 1.0;
            }
            ADD i.expiryGroup{
                fillVertical = 1.0;
                fillHorizontal = 1.0;
            }
            ADD i.historyGroup{
                fillVertical = 1.0;
                fillHorizontal = 1.0;
            }
            ADD d.box{
                POSITION d.grid.box TO THE LEFT d.panel;
            }
       }
    }
}

inItemGroupSku(itemGroup, sku) = itemGroupSku(sku) == itemGroup;

FORM items 'Товары'
TREE treeGroup g=itemGroup PARENT parentItemGroup
OBJECTS i=item
PROPERTIES(g) READONLY name
PROPERTIES(i) READONLY name, shortNameUnitOfMeasureItem, barcodeBarcodeSku
PROPERTIES(i) ADDFORM, EDITFORM, delete
FILTERS NOT NULL inItemGroupSku(g, i);

DESIGN items FROM DEFAULT {
    POSITION treeGroup.box TO THE LEFT i.box;
}

FORM itemInDepartment  'Товары в подразделениях'
OBJECTS d=departmentStore, i=item
PROPERTIES(d) READONLY name, nameStoreDepartmentStore
PROPERTIES(d) ADDFORM, EDITFORM, delete
PROPERTIES(i) READONLY name, shortNameUnitOfMeasureItem
PROPERTIES(i) ADDFORM, EDITFORM, delete
PROPERTIES(d, i) additionPriceDepartmentStoreItem, boundCertificateDepartmentStoreItem, maxAllowedRetailPriceDepartmentStoreItem, netWeightManufacterDepartmentStoreItem,
                 nameStatusCashDepartmentStoreItem, dateManufactureDepartmentStoreItem, dateFitToDepartmentStoreItem, fromDateDeliveryDepartmentStoreItem,
                 banSaleDepartmentStoreItem, banMovementDepartmentStoreItem, reserveDepartmentStoreItem,
                 maxReserveItemDepartment, showFormmaxReserveItemDepartment,
                 minReserveItemDepartment, showFormminReserveItemDepartment,
                 namebanRevaluationItemDepartment, showFormNamebanRevaluationItemDepartment,
                 nameinActionItemDepartment, showFormNameinActionItemDepartment,
                 marginProductionItemDepartment, showFormmarginProductionItemDepartment,
                 discountItemDepartment, showFormdiscountItemDepartment;

FORM itemGroup 'Товарная группа'
OBJECTS g=itemGroup FIXED PANEL
PROPERTIES(g) name, nameParentItemGroup, maxTurnoverItemGroup, minTurnoverItemGroup, extSID
EDIT itemGroup OBJECT g;

FORM itemGroups 'Товарные группы'
TREE g=itemGroup PARENT parentItemGroup
PROPERTIES(g) READONLY name, extSID
PROPERTIES(g) ADDFORM, EDITFORM, delete
DIALOG itemGroup OBJECT g;

// ----------------------------------- Ассортимент -------------------------------------------------------- //

CLASS assortment 'Ассортимент' : named;
itemAssortment 'Товар включен в ассортимент' = DATA BOOLEAN (assortment, item);
infoAssortment 'Описание' = DATA STRING[100] (assortment) IN baseGroup;

FORM assortment 'Ассортимент'
OBJECTS a=assortment FIXED PANEL, i=item
PROPERTIES(a) name, infoAssortment
PROPERTIES(a, i) itemAssortment
PROPERTIES(i) name
PROPERTIES(i) ADDSESSIONFORM, EDITSESSIONFORM, delete
FILTERGROUP assortment
    FILTER 'Только товары ассортимента' 'F10' NOT NULL itemAssortment(a, i) DEFAULT
EDIT assortment OBJECT a;

FORM assortments 'Ассортименты'
OBJECTS a=assortment, i=item
PROPERTIES(a) READONLY name, infoAssortment
PROPERTIES(a) ADDFORM, EDITFORM, delete
PROPERTIES(i) READONLY name
FILTERS NOT NULL itemAssortment(a, i);

// ----------------------------------- Комиссии ---------------------------------------------------------- //

CLASS ABSTRACT committee 'Комиссия' : named;
CLASS revaluationCommittee 'Комиссия переоценки' : committee;

chairmanRevaluationCommittee 'Председатель комиссии (ИД)' = DATA employee (revaluationCommittee);
commonNameChairmanRevaluationCommittee 'Председатель комиссии' (revaluationCommittee) = commonName(chairmanRevaluationCommittee(revaluationCommittee)) IN baseGroup;
departmentStoreRevaluationCommittee 'Отдел комиссии (ИД)' = DATA departmentStore (revaluationCommittee);
nameDepartmentStoreRevaluationCommittee 'Отдел комиссии' (revaluationCommittee) = commonName(departmentStoreRevaluationCommittee(revaluationCommittee)) IN baseGroup;
CONSTRAINT CHECKED chairmanRevaluationCommittee(revaluationCommittee) AND NOT departmentStoreEmployee(departmentStoreRevaluationCommittee(revaluationCommittee), chairmanRevaluationCommittee(revaluationCommittee)) MSG 'Отдел комиссии должен соответствовать отделу председателя комиссии';
CONSTRAINT CHECKED departmentStoreRevaluationCommittee(revaluationCommitteeDepartmentStore(departmentStore)) != departmentStore MSG 'Отдел комиссии должен соответствовать текущему отделу';

inDepartmentStoreEmployeeRevaluationCommittee (revaluationCommittee, employee) = departmentStoreEmployee(departmentStoreRevaluationCommittee(revaluationCommittee), employee);
inCommitteeDepartmentStore 'Является членом комиссии' (revaluationCommittee, employee) = DATA BOOLEAN (revaluationCommittee, employee);

FORM revaluationCommittee 'Комиссия переоценки'
OBJECTS c=revaluationCommittee FIXED PANEL, e=employee
PROPERTIES(c) name, nameDepartmentStoreRevaluationCommittee, commonNameChairmanRevaluationCommittee
PROPERTIES(e) READONLY name
PROPERTIES(e) userFirstName, userLastName, ADDSESSIONFORM, EDITSESSIONFORM, delete
PROPERTIES(c, e) inCommitteeDepartmentStore
FILTERS NOT NULL inDepartmentStoreEmployeeRevaluationCommittee(c, e)
EDIT revaluationCommittee OBJECT c;

FORM employeesCommittees 'Сотрудники и комиссии '
OBJECTS c=revaluationCommittee, e=employee
PROPERTIES(c) READONLY name, nameDepartmentStoreRevaluationCommittee, commonNameChairmanRevaluationCommittee
PROPERTIES(c) ADDFORM, EDITFORM, delete
PROPERTIES(e) READONLY userFirstName, userLastName
FILTERS NOT NULL inCommitteeDepartmentStore(c, e);

// ----------------------------------- Банк ------------------------------------------- //

GROUP banksGroup 'Информация о банке' : baseGroup;

CLASS bank 'Банк' : named;

MFOBank 'Код МФО' = DATA STRING[9] (bank) IN banksGroup;
departmentBank 'Отдел банка' = DATA STRING[100] (bank) IN banksGroup;
CBUBank 'ЦБУ' = DATA STRING[3] (bank) IN banksGroup;
infoBank 'Дополнительные сведения' = DATA STRING[100] (bank) IN banksGroup;

@metaCodeObjectDateProperty(addressBank, bank, 'Адрес банка', STRING[150], banksGroup);

FORM bank 'Банк'
OBJECTS b=bank FIXED PANEL
PROPERTIES(b)  name, addressBank, showFormaddressBank, MFOBank, departmentBank, CBUBank, infoBank
EDIT bank OBJECT b;

FORM banks 'Банки'
OBJECTS b=bank
PROPERTIES(b) READONLY name, addressBank, MFOBank, departmentBank, CBUBank, infoBank
PROPERTIES(b) ADDFORM, EDITFORM, delete;

// ----------------------------------- Расчетный счет ------------------------------------------ //

GROUP accountGroup 'Банковская информация' : baseGroup;

CLASS account 'Расчетный счет';

bankAccount 'Банк (ИД)' = DATA bank (account) IN idGroup;

dataAccount 'Номер расчетного счета'  = DATA STRING[13] (account) IN accountGroup;
nameBankAccount 'Наименование банка' (account) = name(bankAccount(account)) IN accountGroup;
addressBankAccount 'Адрес банка' (account) = addressBank(bankAccount(account)) IN accountGroup;
MFOBankAccount 'Код МФО банка' (account) = MFOBank(bankAccount(account)) IN accountGroup;
departmentBankAccount 'Отдел банка' (account) = departmentBank(bankAccount(account)) IN accountGroup;
CBUBankAccount 'ЦБУ банка' (account) = CBUBank(bankAccount(account)) IN accountGroup;
noteAccount 'Примечание'  = DATA STRING[50] (account) IN accountGroup;

// ----------------------------------- Форма собственности ------------------------------------------ //
CLASS ownership 'Форма собственности' : named;
shortNameOwnership 'Cокращенное название' = DATA STRING[10] (ownership) IN baseGroup;

FORM ownership 'Форма собственности'
OBJECTS o=ownership FIXED PANEL
PROPERTIES(o) name, shortNameOwnership;

// ----------------------------------- Лицензия ------------------------------------------ //
GROUP licensGroup 'Лицензиионная информация' : baseGroup;
CLASS license 'Лицензия' ;

dataLicense 'Номер лицензии' = DATA STRING[100] (license) IN licensGroup;
dateFromLicense 'Действует с ' = DATA DATE (license) IN licensGroup;
dateToLicense 'Действует по ' = DATA DATE (license) IN licensGroup;

//tabaccoLicense 'Табачная' = DATA BOOLEAN  (license) IN licensGroup;

// ----------------------------------- Юридическое лицо ------------------------------------------ //

GROUP lawGroup 'Юридическая информация' : baseGroup;
GROUP contactGroup 'Контактная информация' : baseGroup;
GROUP docGroup 'Для договора' : baseGroup;

CLASS ABSTRACT legalEntity 'Юридическое лицо' : named;

ownershipLegalEntity 'Форма собственности (ИД)' = DATA ownership (legalEntity) IN licensGroup;

nameOwnershipLegalEntity 'Форма собственности' = name(ownershipLegalEntity(legalEntity)) IN lawGroup;
shortNameOwnershipLegalEntity 'Форма собственности (сокр.)' = shortNameOwnership(ownershipLegalEntity(legalEntity)) IN lawGroup;
fullNameLegalEntity 'Наименование для накладных' = DATA STRING[200] (legalEntity) IN lawGroup;
UNPLegalEntity 'УНП' = DATA STRING[9] (legalEntity) IN docGroup;
OKPOLegalEntity 'Код по ОКПО' = DATA STRING[20] (legalEntity) IN docGroup;
OKYLPLegalEntity 'Код ОКЮЛП' = DATA STRING[20] (legalEntity) IN docGroup;
emailLegalEntity 'e-mail' = DATA STRING[100] (legalEntity) IN contactGroup;
siteLegalEntity 'Сайт' = DATA STRING[100] (legalEntity) IN contactGroup;
contactsLegalEntity 'Дополнительная информация' = DATA STRING[300] (legalEntity) IN contactGroup;
residentLegalEntity 'Резидент РБ' = DATA BOOLEAN (legalEntity) IN lawGroup;
manufacturerLegalEntity 'Производитель' = DATA BOOLEAN (legalEntity) IN lawGroup;

legalEntityAccount 'Ю.Л. (ИД)' = DATA legalEntity (account) IN idGroup;
userAccountLegalEntity 'Р/сч. (ИД)' = DATA account (legalEntity) IN idGroup;
defaultAccountLegalEntity(legalEntity) = GROUP MAX account AS account BY legalEntityAccount(account);
overrideAccountLegalEntity 'Основной р/сч.' (legalEntity) = UNION OVERRIDE defaultAccountLegalEntity(legalEntity), userAccountLegalEntity(legalEntity);
dataOverrideAccountLegalEntity 'Основной р/сч.' (legalEntity) = dataAccount(overrideAccountLegalEntity(legalEntity)) IN lawGroup;

CONSTRAINT CHECKED legalEntity != legalEntityAccount(userAccountLegalEntity(legalEntity)) MSG 'ошибка: Р/сч. по умолчанию должен соответствовать р/сч. Ю.Л.';
equalsLegalEntityAccount 'Основной р/сч.' (legalEntity, account) = userAccountLegalEntity(legalEntity) == account;

legalEntityLicense 'ЮЛ (ИД)' = DATA legalEntity (license) IN idGroup;

//userLicenseLegalEntity 'ЮЛ (ИД)' = DATA license (legalEntity) IN idGroup;
//actingLicense 'Действующая, м/у датами' (license) = license AS license IF dateFromLicense(license) <= currentDate() AND NOT dateToLicense(license) < currentDate();
actingLicenseDate 'Действующая между датами' (license, date) = license AS license IF dateFromLicense(license) <= date AND NOT dateToLicense(license) < date AND date AS DATE;
actingLicenseLegalEntityDate 'Действующая на дату' (legalEntity, date) = GROUP MAX actingLicenseDate(license, date) BY legalEntityLicense(license), date;
actingLicenseLegalEntity 'Действующая' (legalEntity) = actingLicenseLegalEntityDate(legalEntity, currentDate());
dataActingLicenseLegalEntity 'Действующая лицензия' (legalEntity) = dataLicense(actingLicenseLegalEntity(legalEntity)) IN lawGroup;

//actingLicenseLegalEntity (legalEntity) = GROUP MAX actingLicense(license) BY legalEntityLicense(license);        // сгруппировали по ID
//overrideLicenseLegalEntity 'Действующая' (legalEntity) = UNION OVERRIDE defaultLicenseLegalEntity(legalEntity) IF dateFromLicense(defaultLicenseLegalEntity(legalEntity)) < currentDate() AND dateToLicense(defaultLicenseLegalEntity(legalEntity)) > currentDate(),
//                                                                        userLicenseLegalEntity(legalEntity) IF dateFromLicense(userLicenseLegalEntity(legalEntity)) < currentDate() AND dateToLicense(userLicenseLegalEntity(legalEntity)) > currentDate();
                        // работает как то не так, надо проверить //
//CONSTRAINT CHECKED legalEntity != legalEntityLicense(userLicenseLegalEntity(legalEntity)) MSG 'ошибка: Лицензия по умолчанию должен соответствовать лицензии Ю.Л.';
//CONSTRAINT  dateFromLicense(overrideLicenseLegalEntity(legalEntity)) > currentDate() MSG 'ошибка: действие лицензии еще не началось';
//CONSTRAINT  dateToLicense(overrideLicenseLegalEntity(legalEntity)) < currentDate() MSG 'ошибка: действие выбранной лицензии уже окончилось';
//equalsLegalEntityLicense 'Действующая' (legalEntity, license) = userLicenseLegalEntity(legalEntity) == license IN lawGroup;

// ----------------------------------- Юридическое лицо-дата ------------------------------------------ //

TABLE legalEntityDate (legalEntity, DATE);

@metaCodeObjectDateProperty(addressLegalEntity, legalEntity, 'Юридический адрес', STRING[150], baseGroup);
@metaCodeObjectDateProperty(managerLegalEntity, legalEntity, 'Руководитель', STRING[100], baseGroup);
@metaCodeObjectDateProperty(accountantLegalEntity, legalEntity, 'Главный бухгалтер', STRING[100], baseGroup);
@metaCodeObjectDateProperty(postAddressLegalEntity, legalEntity, 'Почтовый адрес', STRING[150], baseGroup);
@metaCodeObjectDateProperty(phoneLegalEntity, legalEntity, 'Телефон/факс', STRING[100], baseGroup);


// ----------------------------------- Договор ------------------------------------------ //

GROUP contractGroup 'Общая информация' : baseGroup;

CLASS ABSTRACT contract 'Договор';
CLASS contractProvider 'Договор с поставщиком' : contract;

CLASS STATIC contractType 'Тип договора'
{
    sale 'договор купли-продажи',
    commission 'договор комиссии'
};

CLASS STATIC contractForm 'Порядок оплаты'
{
    prepayment 'с отсрочкой платежа',
    implement 'По факту реализации',
    instruction 'Платежное поручение',
    requirement 'Платежное требование'
};

dataContract 'Номер договора' = DATA STRING[30] (contract) IN contractGroup;
//formContract(contract) = DATA contractForm (contract) IN contractGroup;
//nameFormContract 'Порядок оплаты по договору' (contract) = name(formContract(contract)) IN contractGroup;
typeContract(contract) = DATA contractType (contract) IN contractGroup;
nameTypeContract 'Тип договора' (contract) = name(UNION OVERRIDE contractType.sale IF contract IS contract,
                                                                 typeContract(contract)) IN contractGroup;
dateFromContract 'Дата начала договора' = DATA DATE (contract) IN contractGroup;
dateToContract 'Дата окончания договора' = DATA DATE (contract) IN contractGroup;
currencyContract 'Валюта взаиморасчетов' = DATA STRING[20] (contract) IN contractGroup; // может и не надо   или справочником
warnContract 'За сколько дней предупредить об окончании' = DATA INTEGER (contract) IN contractGroup;
banContract 'За сколько дней запретить закупку товара' = DATA INTEGER (contract) IN contractGroup;
//delayContract 'Отсрочка платежа, дней' = DATA INTEGER (contract) IN contractGroup;
requestContract 'Форма оплаты: Платежное требование' = DATA BOOLEAN (contract) IN contractGroup;
noteContract 'Примечание' = DATA STRING[100] (contract) IN contractGroup;

@metaCodeNameObjectDateProperty(formContract, contract, 'Порядок оплаты по договору', contractForm, contractGroup);
CONSTRAINT contract IS contract AND NOT formContract(contract)  MSG 'ошибка: Не выбран порядок оплаты по договору';
@metaCodeObjectDateProperty(delayContract, contract, 'Отсрочка платежа(кален. дней),при "-" предоплата', DOUBLE, baseGroup);


// ----------------------------------- Поставщик ------------------------------------------ //

GROUP supplierGroup 'Информация о поставщике' : baseGroup;
CLASS supplier 'Поставщик' : legalEntity;
CLASS company 'Компания' : legalEntity;

companyContract 'Организация (ИД)' = DATA company (contract) IN idGroup;
supplierContract 'Поставщик (ИД)' = DATA supplier (contract) IN idGroup;
userContractSupplier 'Контракт (ИД)' = DATA contract (supplier) IN idGroup;
//companySupplier 'Организация (ИД)' = DATA company (supplier) IN idGroup;

payerSupplier 'Плательщик НДС' = DATA BOOLEAN (supplier) IN supplierGroup;
scheduleSupplier 'Разрешить доп.заказ товаров вне графика' = DATA BOOLEAN (supplier) IN supplierGroup;
surePercentSupplier 'Обязательный % заказанных товаров в прих. накладной' = DATA INTEGER (supplier) IN supplierGroup;
allowablePercentSupplier 'Допустимый % изменения цен 1го поставщика' = DATA INTEGER (supplier) IN supplierGroup;
afterDaysSupplier 'Максимальное число дней до поставки после заказа' = DATA INTEGER (supplier) IN supplierGroup;
forHoursSupplier 'За сколько часов до поставки закрыть заказ' = DATA INTEGER (supplier) IN supplierGroup;
limitSupplier 'Кредитный лимит' = DATA INTEGER (supplier) IN docGroup;
prioritySupplier 'Приоритет оплаты (1 - в первую очередь)' = DATA INTEGER (supplier) IN docGroup;
signsSupplier 'Число знаков после запятой для строки накладной' = DATA INTEGER (supplier) IN supplierGroup;
marksSupplier 'Число знаков после зап.в сумме к оплате по накладной' = DATA INTEGER (supplier) IN supplierGroup;

emailOrderSupplierDepartmentStore 'e-mail для передачи заказа' = DATA STRING[100] (supplier, departmentStore)IN supplierGroup;
contactSupplierDepartmentStore 'Контактная информация' = DATA STRING[500] (supplier, departmentStore)IN supplierGroup;
controlSupplierDepartmentStore(supplier, departmentStore) = DATA yesNo (supplier, departmentStore)IN idGroup;
nameControlSupplierDepartmentStore 'Контролировать ассортимент поставщика, ДА/НЕТ' (supplier, departmentStore) = name(UNION OVERRIDE yesNo.no IF supplier IS supplier AND departmentStore IS departmentStore,
                                                                                                                                controlSupplierDepartmentStore(supplier, departmentStore)) IN supplierGroup;

@metaCodeNameDoubleObjectDateProperty(sureSupplierDepartmentStore, supplier, departmentStore, 'Обязателен заказ поставщику, ДА/НЕТ', yesNo);

overrideSupplierDepartmentStore(supplier, departmentStore) = UNION OVERRIDE (TRUE IF UNION OVERRIDE emailOrderSupplierDepartmentStore(supplier, departmentStore), contactSupplierDepartmentStore(supplier, departmentStore)),
                                                                             UNION OVERRIDE controlSupplierDepartmentStore(supplier, departmentStore) == yesNo.yes , sureSupplierDepartmentStore(supplier, departmentStore) == yesNo.yes;

//dataContractSupplier 'Договор по умолчанию' (supplier) = dataContract(userContractSupplier(supplier));
defaultContractSupplier(supplier) = GROUP MAX contract AS contract BY supplierContract(contract);
//dataDefaultContractSupplier(supplier) = dataContract(defaultContractSupplier(supplier));

overrideContractSupplier 'Основной договор' (supplier) = UNION OVERRIDE defaultContractSupplier(supplier), userContractSupplier(supplier);
dataOverrideContractSupplier 'Основной договор' (supplier) = dataContract(overrideContractSupplier(supplier)) IN lawGroup;
CONSTRAINT CHECKED supplier != supplierContract(userContractSupplier(supplier)) MSG 'ошибка: Договор по умолчанию для поставщика должен соответствовать договорам поставщика';
equalsSupplierContract 'Основной договор' (supplier, contract) = userContractSupplier(supplier) == contract;

inSupplierContract(supplier, contract) = supplierContract(contract) == supplier;
inSupplierAccount(supplier, account) = legalEntityAccount(account) == supplier;
inSupplierLicense(supplier, license) = legalEntityLicense(license) == supplier;

inCompanyContract(company, contract) = companyContract(contract) == company;
inCompanyAccount(company, account) = legalEntityAccount(account) == company;

nameSupplierContract 'Контрагент' (contract) = name(supplierContract(contract));
nameCompanyContract 'Контрагент' (contract) = name(companyContract(contract));

userContractCompanySupplier 'Контракт (ИД)' = DATA contract (company, supplier) IN idGroup;
//dataContractCompanySupplier 'Договор по умолчанию' (company, supplier) = dataContract(userContractCompany(company));
actingContract(contract) = contract IF dateFromContract(contract) <= currentDate() AND dateToContract(contract) >= currentDate();
actingContractCompanySupplier(company, supplier) = GROUP MAX actingContract(contract) BY companyContract(contract), supplierContract(contract);

overrideContractCompanySupplier 'Основной договор' (company, supplier) = UNION OVERRIDE actingContractCompanySupplier(company, supplier), userContractCompanySupplier(company, supplier);
dataOverrideContractCompanySupplier 'Основной договор' (company, supplier) = dataContract(overrideContractCompanySupplier(company, supplier)) IN lawGroup;
CONSTRAINT CHECKED supplier != supplierContract(userContractCompanySupplier(company, supplier)) MSG 'ошибка: Договор по умолчанию для поставщика должен соответствовать договорам поставщика';
CONSTRAINT CHECKED company != companyContract(userContractCompanySupplier(company, supplier)) MSG 'ошибка: Договор по умолчанию для компании должен соответствовать договорам компании';
// более глубокая прроверка нужна
equalsCompanySupplierContract 'Основной договор' (company, supplier, contract) = userContractCompanySupplier(company, supplier) == contract;


FORM supplier 'Поставщик'
OBJECTS s=supplier FIXED PANEL
OBJECTS a=account, c=contractProvider, l=license, d=departmentStore
PROPERTIES(s) nameOwnershipLegalEntity, name, fullNameLegalEntity, addressLegalEntity, showFormaddressLegalEntity, postAddressLegalEntity, showFormpostAddressLegalEntity,
              managerLegalEntity, showFormmanagerLegalEntity, accountantLegalEntity, showFormaccountantLegalEntity,
              phoneLegalEntity, showFormphoneLegalEntity, UNPLegalEntity, OKPOLegalEntity, OKYLPLegalEntity, emailLegalEntity, siteLegalEntity, payerSupplier,
              dataOverrideAccountLegalEntity, residentLegalEntity, manufacturerLegalEntity, dataOverrideContractSupplier, surePercentSupplier, allowablePercentSupplier,
              afterDaysSupplier, forHoursSupplier, limitSupplier, prioritySupplier, signsSupplier, marksSupplier, dataActingLicenseLegalEntity
PROPERTIES(a) dataAccount, nameBankAccount, addressBankAccount, departmentBankAccount, CBUBankAccount, MFOBankAccount, noteAccount, ADDOBJ, delete
PROPERTIES(c) dataContract, nameCompanyContract, nameformContract, showFormNameformContract, nameTypeContract, dateFromContract, dateToContract, currencyContract, warnContract, banContract,   // nameFormContract
              delayContract, showFormdelayContract, requestContract, noteContract, ADDOBJ, delete
PROPERTIES(l) dataLicense, dateFromLicense, dateToLicense, ADDOBJ, delete   //        tabaccoLicense
PROPERTIES(d) nameStoreDepartmentStore, name
PROPERTIES(s,d) emailOrderSupplierDepartmentStore, contactSupplierDepartmentStore, nameControlSupplierDepartmentStore, namesureSupplierDepartmentStore, showFormNamesureSupplierDepartmentStore//nameSureSupplierDepartmentStore, sureSupplierDepartmentStore, showFormsureSupplierDepartmentStore
PROPERTIES(s,c) equalsSupplierContract
PROPERTIES(s,a) equalsLegalEntityAccount
//PROPERTIES(s,l) equalsLegalEntityLicense
FILTERS NOT NULL inSupplierContract(s, c),
        NOT NULL inSupplierAccount(s, a),
        NOT NULL inSupplierLicense(s, l)
FILTERGROUP filters9
    FILTER 'Показывать только с заполненными полями' 'F10' NOT NULL overrideSupplierDepartmentStore(s, d)
EDIT supplier OBJECT s;

DESIGN supplier FROM DEFAULT {
//PROPERTY (showFormaddressLegalEntity){panelLocation = SHORTCUT addressLegalEntity DEFAULT;}
    main{
       ADD prop.box BEFORE functions.box{
            tabbedPane = TRUE;
            ADD a.box;
            ADD c.box;
            ADD l.box;
            ADD d.box;
    }
   }
}

FORM suppliers 'Поставщики'
OBJECTS s=supplier
PROPERTIES(s) READONLY shortNameOwnershipLegalEntity, name, fullNameLegalEntity, managerLegalEntity, phoneLegalEntity, UNPLegalEntity, emailLegalEntity, siteLegalEntity
PROPERTIES(s) ADDFORM, EDITFORM, delete;

FORM company 'Компания'
OBJECTS co=company FIXED PANEL
OBJECTS a=account
OBJECTS s=supplier
OBJECTS c=contractProvider
PROPERTIES(co) nameOwnershipLegalEntity, shortNameOwnershipLegalEntity, name, fullNameLegalEntity, addressLegalEntity, showFormaddressLegalEntity, postAddressLegalEntity, showFormpostAddressLegalEntity,
               managerLegalEntity, showFormmanagerLegalEntity, accountantLegalEntity, showFormaccountantLegalEntity, phoneLegalEntity, showFormphoneLegalEntity, UNPLegalEntity, OKPOLegalEntity, OKYLPLegalEntity, emailLegalEntity, siteLegalEntity
PROPERTIES(a) dataAccount, nameBankAccount, addressBankAccount, departmentBankAccount, CBUBankAccount, MFOBankAccount, noteAccount, ADDOBJ, delete
PROPERTIES(c) dataContract, nameSupplierContract, nameformContract, showFormNameformContract, nameTypeContract, dateFromContract, dateToContract, currencyContract, noteContract, delayContract, showFormdelayContract, ADDOBJ, delete
PROPERTIES(s) name, fullNameLegalEntity
PROPERTIES(co, s)    dataOverrideContractCompanySupplier
PROPERTIES(co, s, c) equalsCompanySupplierContract
FILTERS NOT NULL inCompanyContract(co, c),
        NOT NULL inCompanyAccount(co, a),
        NOT NULL inSupplierContract(s, c)

EDIT company OBJECT co;

DESIGN company FROM DEFAULT {
    main{
       ADD prop.box BEFORE functions.box {
            tabbedPane = TRUE;
            ADD a.box;
            ADD v.box { title = 'Поставщик-договор'; }
            ADD s.box IN v.box;
            ADD c.box IN v.box;
            POSITION s.box TO THE LEFT c.box;
       }
   }
}
FORM companies 'Компании'
OBJECTS co=company
PROPERTIES(co) READONLY shortNameOwnershipLegalEntity, name, fullNameLegalEntity, managerLegalEntity, phoneLegalEntity, UNPLegalEntity, emailLegalEntity, siteLegalEntity, dataOverrideAccountLegalEntity
PROPERTIES(co) ADDFORM, EDITFORM, delete;

// ----------------------------------- Ассортимент поставщиков-------------------------------------------- //

itemAssortmentSupplier 'Товар в ассортименте поставщика' = DATA BOOLEAN (departmentStore, supplier, item);

FORM assortmentSupplier 'Ассортимент поставщика'
OBJECTS d=departmentStore FIXED PANEL, s=supplier, i=item
PROPERTIES(d) READONLY name
PROPERTIES(s) name
PROPERTIES(s) ADDFORM, EDITFORM, delete
PROPERTIES(i) name
PROPERTIES(i) ADDFORM, EDITFORM, delete
PROPERTIES(d, s, i)  itemAssortmentSupplier;

//---------------------------- по поставщикам и товарам ----------------------------------------

// ----------------------------------- Разрешать поставки ------------------------------------------- //

TABLE supplierDepartmentStoreDate (supplier, departmentStore, DATE);

@metaCodeDoubleObjectDateProperty(timeTable, supplier, departmentStore, 'Поставка', BOOLEAN);

FORM timeTableDate 'График поставок'
OBJECTS t=DATE FIXED PANEL, d=departmentStore FIXED PANEL, s=supplier
PROPERTIES(t) OBJVALUE
PROPERTIES(d) READONLY name
PROPERTIES(s) READONLY name
PROPERTIES(s, d, t) timeTableDate
//FILTERS NOT NULL timeTableDate(s, d, t);
FILTERGROUP filters
    FILTER 'Показывать с поставкой на дату' 'F10' NOT NULL timeTableDate(s, d, t);
//--------------------------------------Заказ------------------------------------------------------------------//

CLASS ABSTRACT order 'Заказ' : named;
CLASS orderSupplier 'Заказ поставщику' : order;
//CLASS orderStock 'Заказ складу' :order;

curDateOrderSupplier 'Дата создания заказа' = DATA DATE (orderSupplier);
personOrderSupplier 'ФИО, кем создан документ (ИД)' = DATA employee (orderSupplier);
namePersonOrderSupplier 'ФИО, кем создан документ' (orderSupplier) = commonName(personOrderSupplier(orderSupplier));
dateOrderSupplier 'Дата поставки' = DATA DATE (orderSupplier);
departmentStoreOrderSupplier 'Отдел заказа (ИД)' = DATA departmentStore (orderSupplier);
nameDepartmentStoreOrderSupplier 'Отдел заказа' (orderSupplier) = name(departmentStoreOrderSupplier(orderSupplier));
supplierOrderSupplier 'Поставщик заказа (ИД)' = DATA supplier (orderSupplier);
nameSupplierOrderSupplier 'Поставщик заказ' (orderSupplier) = name(supplierOrderSupplier(orderSupplier));
completePercentageOrderSupplier 'Процент выполнения' (orderSupplier) = DATA DOUBLE (orderSupplier) IN baseGroup;

quantityPackItem2 'Количество в грузовом месте' (item) = UNION OVERRIDE 1 IF item IS item, quantityPackItem(item);
itemAssortmentOrderSupplier 'Ассортимен заказа' (orderSupplier, item) = itemAssortmentSupplier(departmentStoreOrderSupplier(orderSupplier), supplierOrderSupplier(orderSupplier), item);
packQuantityItemOrderSupplier 'Количество мест' = DATA INTEGER (orderSupplier, item);
sumQuantityItemOrderSupplier 'Сумарное количество товара' (orderSupplier, item) = quantityPackItem2(item) * packQuantityItemOrderSupplier(orderSupplier, item);
fullPriceItemOrderSupplier 'Цена с НДС' (orderSupplier, item) = DATA DOUBLE (orderSupplier, item) IN baseGroup;
fullSumItemOrderSupplier 'Сумма с НДС' (orderSupplier, item) =  sumQuantityItemOrderSupplier(orderSupplier, item) * fullPriceItemOrderSupplier(orderSupplier, item) IN baseGroup;
fullSumOrderSupplier 'Сумма с НДС' (orderSupplier) = GROUP SUM fullSumItemOrderSupplier(orderSupplier, item) BY orderSupplier;

FORM orderSupplier 'Заказ поставщику'
OBJECTS o=orderSupplier FIXED PANEL, i=item
PROPERTIES(o) name, curDateOrderSupplier, namePersonOrderSupplier, dateOrderSupplier, nameDepartmentStoreOrderSupplier,
              nameSupplierOrderSupplier, completePercentageOrderSupplier, fullSumOrderSupplier
PROPERTIES(i) name, quantityPackItem2
PROPERTIES(o, i) packQuantityItemOrderSupplier, sumQuantityItemOrderSupplier, fullPriceItemOrderSupplier, fullSumItemOrderSupplier
FILTERS NOT NULL itemAssortmentOrderSupplier(o, i)
FILTERGROUP filters1
    FILTER 'Показывать только заказанные позиции' 'F10' NOT NULL sumQuantityItemOrderSupplier(o, i)
EDIT orderSupplier OBJECT o;

FORM orderSuppliers 'Заказы поставшику'
OBJECTS o=orderSupplier, i=item
PROPERTIES(o) READONLY name, curDateOrderSupplier, namePersonOrderSupplier, dateOrderSupplier, nameDepartmentStoreOrderSupplier,
                       nameSupplierOrderSupplier, completePercentageOrderSupplier, fullSumOrderSupplier
PROPERTIES(o) ADDFORM, EDITFORM, delete
PROPERTIES(i) READONLY name
PROPERTIES(o, i) READONLY  packQuantityItemOrderSupplier, sumQuantityItemOrderSupplier, fullPriceItemOrderSupplier, fullSumItemOrderSupplier
FILTERS NOT NULL sumQuantityItemOrderSupplier(o, i);

//--------------------------------------Формы--------------------------------------------------------------------------//

isManufactory (departmentStore) = departmentStore IS manufactory;

FORM departmentStore 'Отдел магазина'
OBJECTS d=departmentStore FIXED PANEL, e=employee, t=tradingSquare, s=supplier, tm=DATE, d2=departmentStore
PROPERTIES(d) name, nameStoreDepartmentStore, controlMinusRestsDepartmentStore, deleteItemMinusRestsDepartmentStore, controlMinusRestsContainerDepartmentStore,
              verifyOrderArrivalDepartmentStore, // controlAssortmentProviderDepartmentStore это св-во для пересечения поставщ. и отдела, создано ниже
              maxQuantityDeliveryHourDepartmentStore, resolveMaxQuantityDeliveryHourAssortmentLessDepartmentStore, resolveOrderItemDepartmentStore,
              quantityCashChangeOneOperationAccountDepartmentStore, commonNameMateriallyResponsiblePersonItemReportDepartmentStore,
              commonNameBookkeeperItemReportDepartmentStore, commonNamePersonCheckReportDepartmentStore, nameRevaluationCommitteeDepartmentStore
              //nameOutDepartmentManufactory, nameInPriceDepartmentManufactory, marginPublicCateringManufactory
PROPERTIES(e) READONLY userFirstName, userLastName
PROPERTIES(e) ADDSESSIONFORM, EDITSESSIONFORM, delete
PROPERTIES(t) squareTradingSquare, dateTradingSquare
PROPERTIES(t) ADDOBJ, delete
PROPERTIES(d2) READONLY name
PROPERTIES(d, d2) rawDepartmentStore
FILTERS NOT NULL inRawDepartmentStore(d, d2)
FILTERGROUP rawFilter
    FILTER 'Подразделения из которых полуется сырье' 'F10' NOT NULL rawDepartmentStore(d, d2)
PROPERTIES(d) namediscount, showFormNamediscount
PROPERTIES(s) READONLY name
//PROPERTIES(s, d) timeTable
PROPERTIES(tm) OBJVALUE
PROPERTIES(s, d, tm) READONLY timeTableDate
FILTERS NOT NULL timeTableDate(s, d, tm)
FILTERS NOT NULL inTradingSquareDepartmentStore(d, t)
FILTERS NOT NULL departmentStoreEmployee(d, e)
EDIT departmentStore OBJECT d;

DESIGN departmentStore FROM DEFAULT {
    main{
       ADD prop.box BEFORE functions.box{
            tabbedPane = TRUE;
            ADD e.box;
            ADD t.box;
            ADD d2.box;
            ADD s.box{
                ADD tm.box;
            };
      }
   }
}

FORM store 'Магазин'
OBJECTS s=store FIXED PANEL, d=departmentStore, t=tradingSquare
PROPERTIES(s) name, addressStore, nameStoreTypeStore, tradingSquareStore, nameCompanyStore
PROPERTIES(d) READONLY name, defaultTradingSquareDepartmentStore
PROPERTIES(d) ADDSESSIONFORM, EDITSESSIONFORM, delete
FILTERS NOT NULL inStoreDepartment(s, d)
EDIT store OBJECT s;

FORM stores 'Магазины'
OBJECTS s=store, d=departmentStore
PROPERTIES(s) READONLY name, addressStore, nameStoreTypeStore, nameCompanyStore
PROPERTIES(s) ADDFORM, EDITFORM, delete
PROPERTIES(d) READONLY name
FILTERS NOT NULL inStoreDepartment(s, d);

FORM tradingNetwork 'Торговая сеть'
OBJECTS n=tradingNetwork FIXED PANEL, s=storeType
PROPERTIES(n) name
PROPERTIES(s) name
PROPERTIES(s) ADDOBJ, delete
FILTERS NOT NULL inStoreTypeTradingNetwork(s, n)
EDIT tradingNetwork OBJECT n;

FORM qualifier 'Классификатор магазинов'
OBJECTS n=tradingNetwork, s=storeType
PROPERTIES(n) READONLY name
PROPERTIES(n) ADDFORM, EDITFORM
PROPERTIES(s) READONLY name
FILTERS NOT NULL inStoreTypeTradingNetwork(s, n);

//---------------------------- Модели оборудования ----------------------------------------//
CLASS ABSTRACT model 'Модель' : named;
CLASS cashModel 'Модель касс' : model;
CLASS scalesModel 'Модель весов' : model;
CLASS checkModel 'Модель прайс чекеров' : model;

CLASS frontOffice 'Фронт офис';
nameFrontOffice 'Версия фронт офиса на кассе' = DATA STRING[100] (frontOffice) IN baseGroup;

noteModel 'Примечание' = DATA STRING[200] (model) IN baseGroup;
useModel 'Модель используется' = DATA BOOLEAN (model) IN baseGroup;
lettersModel 'Преобразовать наименование товара В ЗАГЛАВНЫЕ БУКВЫ' = DATA BOOLEAN (model) IN baseGroup;


frontOfficeCashModel 'Модель касс (ИД)' = DATA frontOffice (cashModel) IN idGroup;
nameFrontOfficeCashModel 'Версия фронт офиса на кассе' (cashModel) = nameFrontOffice(frontOfficeCashModel(cashModel)) IN baseGroup;
dateToCashModel 'Дата, до которой модель внесена в реестр' = DATA DATE (cashModel) IN baseGroup;
maxProductModel 'MAX допустимое колич.товаров' = DATA INTEGER (model) IN baseGroup;

CLASS flash 'Прошивка';
nameFlash 'Модель весов/версия прошивки' = DATA STRING[100] (flash) IN baseGroup;

flashScalesModel 'Прошивка (ИД)' = DATA flash (scalesModel) IN idGroup;
nameFlashScalesModel 'Модель весов/версия прошивки' = nameFlash(flashScalesModel(scalesModel)) IN baseGroup;
maxTextScalesModel 'MAX допустимое колич.дополнительных текстов' = DATA INTEGER (scalesModel) IN baseGroup;
folderScalesModel 'Папка на сервере весов с драйвером весов' = DATA STRING[200] (scalesModel) IN baseGroup;
compositionScalesModel 'Число знаков в доп.тексте(составе товара)' = DATA INTEGER (scalesModel) IN baseGroup;

CLASS modelCheck 'Модель чекера';
nameModelCheck 'Модель прайс чекера' = DATA STRING[100] (modelCheck) IN baseGroup;

modelCheckModel 'Модель (ИД)' = DATA modelCheck (checkModel) IN idGroup;
nameModelCheckModel 'Модель прайс чекера' = nameModelCheck(modelCheckModel(checkModel)) IN baseGroup;

FORM models 'Модели оборудования'
OBJECTS m=model
PROPERTIES(m) READONLY objectClassName, name, useModel, maxProductModel, noteModel
PROPERTIES(m) ADDFORM, EDITFORM, delete;                // либо так как ниже//
//OBJECTS s=scalesModel, ch=checkModel, c=cashModel
//PROPERTIES(ch) READONLY name, nameModelCheckModel, noteModel, useModel, maxProductModel
//PROPERTIES(s)  READONLY name, nameFlashScalesModel, noteModel, useModel, maxProductModel, maxTextScalesModel,
//               folderScalesModel, lettersModel, compositionScalesModel
//PROPERTIES(c)  READONLY name, nameFrontOfficeCashModel, noteModel, useModel, dateToCashModel, lettersModel
//PROPERTIES(s) ADDFORM, EDITFORM, delete
//PROPERTIES(c) ADDFORM, EDITFORM, delete
//PROPERTIES(ch) ADDFORM, EDITFORM, delete;

//DESIGN models FROM DEFAULT {
//    main{
//       ADD prop1.box BEFORE functions.box{
//            tabbedPane = TRUE;
//            ADD c.box;
//            ADD s.box;
//            ADD ch.box;
//    }
//   }
//}

FORM checkModel 'Модель прайс чекера'
OBJECTS ch=checkModel FIXED PANEL
PROPERTIES(ch) name, nameModelCheckModel, noteModel, useModel, maxProductModel
EDIT checkModel OBJECT ch;

FORM cashModel 'Модель касс'
OBJECTS c=cashModel FIXED PANEL
PROPERTIES(c) name, nameFrontOfficeCashModel, noteModel, useModel, dateToCashModel, lettersModel
EDIT cashModel OBJECT c;

FORM scalesModel 'Модель весов'
OBJECTS s=scalesModel FIXED PANEL
PROPERTIES(s) name, nameFlashScalesModel, noteModel, useModel, maxProductModel, maxTextScalesModel,
              folderScalesModel, lettersModel, compositionScalesModel
EDIT scalesModel OBJECT s;


//---------------------------- группы оборудования ----------------------------------------//

CLASS ABSTRACT groupMachinery 'Группы оборудования';
CLASS groupScales 'Группы весов' : groupMachinery;
CLASS groupCash 'Группы касс' : groupMachinery;
CLASS groupCheck 'Группы прайс чекеров' : groupMachinery;

nameGroupMachinery 'Наименование группы' = DATA STRING[200] (groupMachinery) IN baseGroup;
transferGroupMachinery 'Передать товар на группу оборудования' = DATA BOOLEAN (groupMachinery) IN baseGroup;

cellGroupScales 'Помещать на ценники номера ячеек с этой группы' = DATA BOOLEAN (groupScales) IN baseGroup;
sidSectionGroupScales 'Код отдела в Set Retail' = DATA INTEGER (groupScales) IN baseGroup;
directoryGroupScales 'Директория сервера Set Retail' = DATA STRING[200] (groupScales) IN baseGroup;

departmentStoreGroupMachinery 'Подразделение ИД' = DATA departmentStore (groupMachinery) IN baseGroup;
nameDepartmentStoreGroupMachinery 'Подразделение' (groupMachinery) = name(departmentStoreGroupMachinery(groupMachinery)) IN baseGroup;

//---------------------------- типы оборудования  ----------------------------------------//
CLASS ABSTRACT machinery 'Оборудование';
CLASS cash 'Касса' : machinery;
CLASS scales 'Весы' : machinery;
CLASS check 'Прайс чекер' : machinery;


groupCashCash 'Группа ИД' = DATA groupCash (cash) IN idGroup;
isGroupCashCash (groupCash, cash) = groupCashCash(cash) == groupCash;

groupScalesScales 'Группа ИД' = DATA groupScales (scales) IN idGroup;
isGroupScalesScales (groupScales, scales) = groupScalesScales(scales) == groupScales;

groupCheckCheck 'Группа ИД' = DATA groupCheck (check) IN idGroup;
isGroupCheckCheck (groupCheck, check) = groupCheckCheck(check) == groupCheck;

nameGroupMachineryCash 'Наименование группы' (cash) = nameGroupMachinery(groupCashCash(cash)) IN baseGroup;
nameGroupMachineryScales 'Наименование группы' (scales) = nameGroupMachinery(groupScalesScales(scales)) IN baseGroup;
nameGroupMachineryCheck 'Наименование группы' (check) = nameGroupMachinery(groupCheckCheck(check)) IN baseGroup;

dataGroupMachineryMachinery 'Наименование группы' (machinery) = UNION EXCLUSIVE nameGroupMachineryCash(machinery), nameGroupMachineryScales(machinery), nameGroupMachineryCheck(machinery);

descriptionMachinery 'Описание' = DATA STRING[200] (machinery) IN baseGroup;
portMachinery 'Адрес/порт' = DATA STRING[100] (machinery) IN baseGroup;
useMachinery 'Оборудование используется' = DATA BOOLEAN (machinery) IN baseGroup;

cashModelCash 'Модель ИД' = DATA cashModel (cash) IN idGroup;
numberCash 'Регистрационный номер кассы' = DATA STRING[100] (cash) IN baseGroup;
directoryCash 'Директория обмена с кассой' = DATA STRING[100] (cash) IN baseGroup;
nameCashModelCash 'Модель кассы' (cash) = name(cashModelCash(cash)) IN baseGroup;
statusCash 'Статус кассы (на момент посл.передачи)' = DATA STRING[200] (cash) IN baseGroup;
resultCash 'Результат передачи на кассу товаров' = DATA STRING[200] (cash) IN baseGroup;
dateCash 'Дата фискализации кассового аппарата' = DATA DATE (cash) IN baseGroup;
nppCash 'Порядковый номер кассы в торговом объекте ' = DATA INTEGER (cash) IN baseGroup;

CLASS STATIC feature 'Свойство для оборудования'
{
    never 'HET,(пример: для годен это значит - печатаем в поле этикетки "Годен до")',
    always 'ДА для ВСЕХ товаров поместить в состав',
    sometimes 'ДА (для товаров с признаком [Контролировать срок годности по товару?]'
};

scalesModelScales 'Модель ИД' = DATA scalesModel (scales) IN idGroup;
numberScales 'Заводской(серийный) номер ' = DATA STRING[100] (scales) IN baseGroup;
nameScalesModelScales 'Модель весов' (scales) = name(scalesModelScales(scales)) IN baseGroup;
dateScales 'Дата следующей обязательной поверки' = DATA DATE (scales) IN baseGroup;
passScales 'свойство ИД' = DATA feature (scales) IN idGroup;
namePassScales 'Свойство товара [Годен до] помещать в ингредиенты' (scales) = name(UNION OVERRIDE feature.always IF scales IS scales,
                                                                                                  passScales(scales)) IN baseGroup;
manufactureScales 'свойство ИД' = DATA feature (scales) IN idGroup;
nameManufactureScales 'Свойство товара [Дата изг.] помещать в ингредиенты' (scales) = name(UNION OVERRIDE feature.always IF scales IS scales,
                                                                                                  manufactureScales(scales)) IN baseGroup;
productionScales 'свойство ИД' = DATA feature (scales) IN idGroup;
nameProductionScales 'Св-во товара[Срок годн.в часах] поместить в ингр-ты' (scales) = name(UNION OVERRIDE feature.always IF scales IS scales,
                                                                                                  productionScales(scales)) IN baseGroup;
sidScales 'ID весов для Set Retail' = DATA INTEGER (scales) IN baseGroup;


FORM machineries 'Оборудование'
OBJECTS m=machinery
PROPERTIES(m) READONLY objectClassName, descriptionMachinery, dataGroupMachineryMachinery, portMachinery, useMachinery
PROPERTIES(m) ADDFORM, EDITFORM, delete;

FORM cash 'Касса'
OBJECTS c=cash FIXED PANEL
PROPERTIES(c) numberCash, descriptionMachinery, nameGroupMachineryCash, portMachinery, useMachinery, directoryCash, nameCashModelCash,
              dateCash, nppCash, statusCash, resultCash
EDIT cash OBJECT c;

FORM scales 'Весы'
OBJECTS s=scales FIXED PANEL
PROPERTIES(s) numberScales, descriptionMachinery, nameGroupMachineryScales, portMachinery, useMachinery, nameScalesModelScales,
              dateScales, namePassScales, nameManufactureScales, nameProductionScales, sidScales
EDIT scales OBJECT s;

FORM check 'Прайс чекер'
OBJECTS ch=check FIXED PANEL
PROPERTIES(ch) descriptionMachinery, dataGroupMachineryMachinery, portMachinery, useMachinery
EDIT check OBJECT ch;

FORM groupScales 'Группа весов'
OBJECTS grs=groupScales FIXED PANEL
OBJECTS s=scales
PROPERTIES(grs) nameDepartmentStoreGroupMachinery, nameGroupMachinery, transferGroupMachinery, cellGroupScales, sidSectionGroupScales, directoryGroupScales
PROPERTIES(s)   numberScales, descriptionMachinery, nameGroupMachineryScales, portMachinery, useMachinery, nameScalesModelScales,
                dateScales, namePassScales, nameManufactureScales, nameProductionScales, sidScales, ADDOBJ, delete
FILTERGROUP filters1
    FILTER 'Показывать только для данной группы' 'F10' NOT NULL isGroupScalesScales(grs, s)
EDIT groupScales OBJECT grs;

FORM groupsScales 'Группы весов'
OBJECTS grs=groupScales, s=scales
PROPERTIES(grs) READONLY nameDepartmentStoreGroupMachinery, nameGroupMachinery, transferGroupMachinery, cellGroupScales, sidSectionGroupScales, directoryGroupScales
PROPERTIES(grs) ADDFORM, EDITFORM, delete
PROPERTIES(s)   READONLY numberScales, descriptionMachinery, nameGroupMachineryScales, portMachinery, useMachinery, nameScalesModelScales,
                dateScales, namePassScales, nameManufactureScales, nameProductionScales, sidScales
FILTERS NOT NULL isGroupScalesScales(grs, s);

FORM groupCash 'Группа касс'
OBJECTS grc=groupCash FIXED PANEL
OBJECTS c=cash
PROPERTIES(grc) nameDepartmentStoreGroupMachinery, nameGroupMachinery, transferGroupMachinery
PROPERTIES(c)   numberCash, descriptionMachinery, nameGroupMachineryCash, portMachinery, useMachinery, directoryCash, nameCashModelCash,
                dateCash, nppCash, statusCash, resultCash, ADDOBJ, delete
FILTERGROUP filters2
    FILTER 'Показывать только для данной группы' 'F10' NOT NULL isGroupCashCash(grc, c)
EDIT groupCash OBJECT grc;


FORM groupsCash 'Группы касс'
OBJECTS grc=groupCash, c=cash
PROPERTIES(grc)  READONLY nameDepartmentStoreGroupMachinery, nameGroupMachinery, transferGroupMachinery
PROPERTIES(grc)  ADDFORM, EDITFORM, delete
PROPERTIES(c)    READONLY numberCash, descriptionMachinery, nameGroupMachineryCash, portMachinery, useMachinery, directoryCash, nameCashModelCash,
                 dateCash, nppCash, statusCash, resultCash
FILTERS NOT NULL isGroupCashCash(grc, c);

FORM groupCheck 'Группа прайс чекеров'
OBJECTS grch=groupCheck FIXED PANEL
OBJECTS ch=check
PROPERTIES(grch) nameDepartmentStoreGroupMachinery, nameGroupMachinery, transferGroupMachinery
PROPERTIES(ch)   descriptionMachinery, dataGroupMachineryMachinery, portMachinery, useMachinery, ADDOBJ, delete
FILTERGROUP filters3
    FILTER 'Показывать только для данной группы' 'F10' NOT NULL isGroupCheckCheck(grch, ch)
EDIT groupCheck OBJECT grch;

FORM groupsCheck 'Группы прайс чекеров'
OBJECTS grch=groupCheck, ch=check
PROPERTIES(grch) READONLY nameDepartmentStoreGroupMachinery, nameGroupMachinery, transferGroupMachinery
PROPERTIES(grch) ADDFORM, EDITFORM, delete
PROPERTIES(ch)   READONLY descriptionMachinery, dataGroupMachineryMachinery, portMachinery, useMachinery
FILTERS NOT NULL isGroupCheckCheck(grch, ch);

// ----------------------------------- Группы пользователей -------------------------------------------------- //

CLASS groupUser 'Группы пользователей';

nameGroupUser 'Наименование группы' = DATA STRING[100] (groupUser) IN baseGroup;
sidGroupUser 'Идентификатор' = DATA STRING[20] (groupUser) IN baseGroup;

groupUserEmployee(employee) = DATA groupUser (employee)  IN idGroup;
nameGroupUserEmployee 'Наименование группы' (employee) = nameGroupUser(groupUserEmployee(employee)) IN baseGroup;

includedEmployeeCash 'Подключить'  = DATA BOOLEAN (employee, cash) IN baseGroup;
dateFromEmployeeCash 'Дата с'  = DATA DATE (employee, cash) IN baseGroup;
dateToEmployeeCash 'Дата по'  = DATA DATE (employee, cash) IN baseGroup;

CLASS STATIC typeAction 'Тип действия'
{
    all 'Все подразделения',
    notAll 'Отдельные подразделения'
};
actionEmployee(employee) = DATA typeAction (employee)  IN idGroup;
nameActionEmployee 'доступ к подразделениям' (employee) = name(UNION OVERRIDE typeAction.all IF employee IS employee,
                                                                              actionEmployee(employee)) IN baseGroup;

inEmployeeDepartmentStoreDefault(employee, departmentStore) = DATA BOOLEAN (employee, departmentStore);
inEmployeeDepartmentStore 'Подключить' (employee, departmentStore) = inEmployeeDepartmentStoreDefault(employee, departmentStore) IF actionEmployee(employee) == typeAction.notAll IN baseGroup;
dateFromEmployeeDepartmentStore 'Начало доступа'  = DATA DATE (employee, departmentStore) IN baseGroup;
dateToEmployeeDepartmentStore 'Окончание доступа'  = DATA DATE (employee, departmentStore) IN baseGroup;

isGroupUserEmployee(groupUser, employee) =  groupUserEmployee(employee) == groupUser;

departmentStoreCash(cash) = departmentStoreGroupMachinery(groupCashCash(cash)) IN idGroup;
nameDepartmentStoreCash 'Наименование отдела' (cash) = name(departmentStoreCash(cash)) IN baseGroup;
nameStoreDepartmentStoreCash 'Наименование магазина' (cash) = name(storeDepartmentStore(departmentStoreCash(cash)))  IN baseGroup;

CONSTRAINT  groupUserEmployee(employee) AND NOT actionEmployee(employee) MSG 'Для сотрудника не выбран доступ к подразделениям';
// todo: надо сделать проверку для сотрудника на доступ к подразделению//


FORM groupUser 'Группa пользователей'
OBJECTS gru=groupUser FIXED PANEL
OBJECTS e=employee, c=cash, d=departmentStore
PROPERTIES(gru)  nameGroupUser, sidGroupUser
PROPERTIES(e)    nameGroupUserEmployee, userFirstName, userLastName, phoneEmployee, nameActionEmployee, nameEmployeeSystemEmployee,
                 shortNameLanguageEmployee, numberEmployee, passwordEmployee, dataEmployee
PROPERTIES(c)    READONLY nameStoreDepartmentStoreCash, nameDepartmentStoreCash, nameGroupMachineryCash, numberCash, nppCash
PROPERTIES(e, c) includedEmployeeCash, dateFromEmployeeCash, dateToEmployeeCash
PROPERTIES(d)    READONLY nameStoreDepartmentStore, name
PROPERTIES(e, d) dateFromEmployeeDepartmentStore, dateToEmployeeDepartmentStore, inEmployeeDepartmentStore
FILTERGROUP filters1
    FILTER 'Показывать кассы только для данного пользователя' 'F10' NOT NULL includedEmployeeCash(e, c)
FILTERGROUP filters2
    FILTER 'Показывать сотрудников только для данной группы пользователей' 'F9' NOT NULL isGroupUserEmployee(gru, e)
FILTERGROUP filters3
    FILTER 'Показывать подразделения только для данного пользователя' 'F8' NOT NULL inEmployeeDepartmentStore(e, d)
EDIT groupUser OBJECT gru;

DESIGN groupUser FROM DEFAULT {
    main{
       ADD prop.box BEFORE functions.box {
            ADD c.box;
            ADD d.box;
            POSITION c.box TO THE LEFT d.box;
       }
       ADD xrop.box BEFORE prop.box {
            ADD e.box;
       }

    }
}

FORM groupsUser 'Группы пользователей'
OBJECTS gru=groupUser, e=employee, c=cash, d=departmentStore
PROPERTIES(gru)  READONLY nameGroupUser, sidGroupUser
PROPERTIES(gru)  ADDFORM, EDITFORM, delete
PROPERTIES(e)    READONLY userFirstName, userLastName, phoneEmployee, nameActionEmployee
PROPERTIES(c)    READONLY nameStoreDepartmentStoreCash, nameDepartmentStoreCash, numberCash, nameGroupMachineryCash, nppCash
PROPERTIES(e, c) includedEmployeeCash, dateFromEmployeeCash, dateToEmployeeCash
PROPERTIES(d)    READONLY nameStoreDepartmentStore, name
PROPERTIES(e, d) READONLY dateFromEmployeeDepartmentStore, dateToEmployeeDepartmentStore, inEmployeeDepartmentStore
FILTERS NOT NULL includedEmployeeCash(e, c),
        NOT NULL isGroupUserEmployee(gru, e),
        NOT NULL inEmployeeDepartmentStore(e, d);

DESIGN groupsUser FROM DEFAULT {
    main{
       ADD prop.box BEFORE functions.box {
            tabbedPane = TRUE;
            ADD c.box;
            ADD d.box;
       }
       ADD case.box BEFORE prop.box {
            ADD gru.box;
            ADD e.box;
            POSITION gru.box TO THE LEFT e.box;
       }
   }
}

 //---------------------------- Карты проработки (разруба) ----------------------------------------//
GROUP cutGroup 'Разделка' : baseGroup;
CLASS cutting 'Карта пророботки (разделки)' : named;
CLASS detailCutting 'Компоненты';

sidCutting 'Номер карты (из сборника и прочее)' = DATA INTEGER (cutting) IN cutGroup;
dateCutting 'Дата создания' = DATA DATE (cutting) IN cutGroup;
useCutting 'Используется' = DATA BOOLEAN (cutting) IN cutGroup;
//             номер из сборника.....
descriptionCutting 'Описание' = DATA STRING[200] (cutting) IN cutGroup;
percAllowancesCutting 'Процент надбавок' = DATA DOUBLE (cutting) IN cutGroup;
percLossesCutting 'Процент потерь' = DATA DOUBLE (cutting) IN cutGroup;
percSweepsCutting 'Процент зачисток' = DATA DOUBLE (cutting) IN cutGroup;
InDepartmentStoreCutting 'В каких подразделениях разрешено использовать карту' = DATA BOOLEAN (departmentStore, cutting) IN baseGroup;

cuttingDetailCutting 'Строка ИД' = DATA cutting (detailCutting) IN idGroup;
sidCuttingDetailCutting 'Номер карты' (detailCutting) =  sidCutting(cuttingDetailCutting(detailCutting)) IN cutGroup;
itemDetailCutting 'Товар ИД' = DATA item (detailCutting) IN idGroup;
shortNameUnitOfMeasureItemDetailCutting 'Ед.изм.' (detailCutting) = shortNameUnitOfMeasureItem(itemDetailCutting(detailCutting)) IN cutGroup;
nameItemDetailCutting 'Наименование товара' (detailCutting) = name(itemDetailCutting(detailCutting)) IN cutGroup;
factorDetailCutting 'Рассчетный коэффициент цены' = DATA DOUBLE (detailCutting) IN cutGroup;
percGoodsDetailCutting '% выхода товара' = DATA DOUBLE (detailCutting) IN cutGroup;

isCuttingDetailCutting(cutting, detailCutting) = cuttingDetailCutting(detailCutting) == cutting;
    // todo :  надо сделать свойство на уникальность товара в карте разруба

inItemCutting 'Вкл.' = DATA BOOLEAN (item, cutting) IN cutGroup;

FORM cutting 'Карта проработки'
OBJECTS c=cutting FIXED PANEL
OBJECTS d=detailCutting, dep=departmentStore, i=item
PROPERTIES(c)      sidCutting, descriptionCutting, dateCutting, useCutting, percAllowancesCutting, percLossesCutting, percSweepsCutting
PROPERTIES(d)      nameItemDetailCutting, shortNameUnitOfMeasureItemDetailCutting, factorDetailCutting, percGoodsDetailCutting, ADDOBJ, delete
PROPERTIES(dep)    nameStoreDepartmentStore, name
PROPERTIES(i)      name, shortNameUnitOfMeasureItem, nameBrandItem
PROPERTIES(dep, c) InDepartmentStoreCutting
PROPERTIES(i, c)   inItemCutting

FILTERS NOT NULL isCuttingDetailCutting(c, d)
FILTERGROUP filters7
    FILTER 'Показывать подразделения только для данной карты' 'F10' NOT NULL InDepartmentStoreCutting(dep, c)
FILTERGROUP filters8
    FILTER 'Показывать товар только для данной карты' 'F9' NOT NULL inItemCutting(i, c)

EDIT cutting OBJECT c;

DESIGN cutting FROM DEFAULT {
    main{
       ADD cut.box BEFORE functions.box{
            tabbedPane = TRUE;
            ADD d.box;
            ADD dep.box { title = 'Подразделение'; }
            ADD i.box { title = 'Товар, для которого действует карта'; }
       }
   }
}

FORM cuttings 'Карты проработки'
OBJECTS c=cutting, d=detailCutting, dep=departmentStore, i=item
PROPERTIES(c)      READONLY sidCutting, descriptionCutting, dateCutting, useCutting, percAllowancesCutting, percLossesCutting, percSweepsCutting
PROPERTIES(c)      ADDFORM, EDITFORM, delete
PROPERTIES(d)      READONLY nameItemDetailCutting, shortNameUnitOfMeasureItemDetailCutting, factorDetailCutting, percGoodsDetailCutting
PROPERTIES(dep)    READONLY nameStoreDepartmentStore, name
PROPERTIES(i)      READONLY name, shortNameUnitOfMeasureItem, nameBrandItem
PROPERTIES(dep, c) READONLY InDepartmentStoreCutting
PROPERTIES(i, c) READONLY inItemCutting
FILTERS NOT NULL   isCuttingDetailCutting(c, d),
        NOT NULL   InDepartmentStoreCutting(dep, c),
        NOT NULL   inItemCutting(i, c)
ORDER BY           nameStoreDepartmentStore, sidCutting, nameItemDetailCutting, name;


DESIGN cuttings FROM DEFAULT {
    main{

       ADD cut2.box BEFORE functions.box{
            ADD dep.box { title = 'Подразделение'; }

            ADD i.box { title = 'Товар, для которого действует карта'; }
            POSITION dep.box TO THE LEFT i.box;
       }
       ADD cut1.box BEFORE cut2.box{
            ADD d.box;

       }
   }
}
//---------------------------- Налоги ----------------------------------------//
CLASS tax 'Налог';
CLASS taxNDS 'НДС' : tax;

nameTax 'Наименование налога' = DATA STRING[200] (tax) IN baseGroup;
shortNameTax 'Сокращение' = DATA STRING[20] (tax) IN baseGroup;

CLASS range 'Шкала';
dataRange 'Шкала' = DATA INTEGER (range);

CLASS rate 'История изменений шкалы' : historyObject;
rangeRate 'Шкала ИД' = DATA range (rate) IN idGroup;
taxRange 'Налог ИД' = DATA tax (range) IN idGroup;

maxDataRangeTax(tax) = GROUP MAX dataRange(range) BY taxRange(range);
overrideMaxRangeTax(tax) = UNION OVERRIDE 0 IF tax IS tax, maxDataRangeTax(tax);
dataMaxOneRangeTax(tax) = overrideMaxRangeTax(tax) + 1;
dataOneRange '+1' (range)  = dataMaxOneRangeTax(taxRange(range));
//dataRange(range) <- dataOneRange(range) ON ASSIGN range IS range;

CLASS STATIC rangeType 'Для каких подразделений действует шкала'
{
    common 'Общий',
    units 'Для подразделений'
};
rangeTypeRange 'Тип ИД' = DATA rangeType (range) IN idGroup;
nameRangeTypeRange 'Тип действия' = name(rangeTypeRange(range)) IN baseGroup;
inRangeStoreDefault 'Вкл.' (range, store) = DATA BOOLEAN (range, store) IN baseGroup;
inRangeStore 'Вкл.' (range, store) = inRangeStoreDefault(range, store)  IF rangeTypeRange(range) == rangeType.units IN baseGroup;

rangeTypeRange(range) <- rangeType.common ON ASSIGN range IS range;     /// потом согласовать, какое значение должно быть по-умолчанию ///

dataRate 'Значение ставки' = DATA DOUBLE (rate) IN baseGroup;
dateFromRate 'Действует с' = DATA DATE (rate) IN baseGroup;
dateToRate 'Действует по' = DATA DATE (rate) IN baseGroup;

quantityRateRange 'Количество историй' (range) = GROUP SUM 1 IF rate BY rangeRate(rate);
CONSTRAINT CHECKED range IS range AND NOT rangeTypeRange(range)  MSG 'ошибка: Не выбран тип действия для шкалы';
CONSTRAINT CHECKED rate IS rate AND NOT dataRate(rate)  MSG 'ошибка: Не указано значение ставки';


inRangeRate(range, rate) = rangeRate(rate) == range;
inTaxRange(tax, range) = taxRange(range) == tax;

actingRateDate(rate, date) = rate IF dateFromRate(rate) <= date AND NOT dateToRate(rate) < date AND date AS DATE;
actingRateRangeDate(range, date) = GROUP MAX actingRateDate(rate, date) BY rangeRate(rate), date;
dataActingRateRangeDate 'На дату' (range, date) = dataRate(actingRateRangeDate(range, date));  // в последствии, если надо можно сделать проверку на одну ставку на дату
actingRateRange 'Действующая ИД' (range) = actingRateRangeDate(range, currentDate()) IN idGroup;
dataActingRateRange 'Действующая ставка' (range) = dataRate(actingRateRange(range)) IN baseGroup;
dateFromActingRateRange 'Действует с' (range) = dateFromRate(actingRateRange(range)) IN baseGroup;
dateToActingRateRange 'Действует по' (range) = dateToRate(actingRateRange(range)) IN baseGroup;
nameUserRateRange 'Создан пользователем' (range) = nameUserCreated(actingRateRange(range)) IN baseGroup;

quantityActingRateRangeDate(range, date) = GROUP SUM 1 IF actingRateDate(rate, date) BY rangeRate(rate), date;
quantityActingRateRange 'Количество действующих историй' (range) = quantityActingRateRangeDate(range, currentDate());
CONSTRAINT CHECKED quantityActingRateRange(range) > 1 MSG 'ошибка: Одновременно не может быть несколько действующих ставок';

FORM tax 'Налог'
OBJECTS t=tax FIXED PANEL
OBJECTS ra=range, rt=rate, s=store
PROPERTIES(t)     nameTax, shortNameTax
PROPERTIES(ra)    dataRange, nameRangeTypeRange, ADDOBJ, delete
PROPERTIES(rt)    dataRate, dateFromRate, dateToRate, timeCreated, nameUserCreated, ADDOBJ, delete
PROPERTIES(s)     name, addressStore//, ADDOBJ, delete
PROPERTIES(ra, s) inRangeStore
FILTERS NOT NULL  inRangeRate(ra, rt),
        NOT NULL  inTaxRange(t, ra)
FILTERGROUP filters6
    FILTER 'Показывать магазины только для данного налога' 'F10' NOT NULL inRangeStore(ra, s)

EDIT tax OBJECT t;

DESIGN tax FROM DEFAULT {
    main {
       ADD pax.box BEFORE functions.box {
            ADD s.box;
       }
       ADD sax.box BEFORE pax.box {
            ADD ra.box;
            ADD rt.box;
            POSITION ra.box TO THE LEFT rt.box;
       }

    }
}

FORM taxes 'Налоги'
OBJECTS t=tax
OBJECTS ra=range, s=store
PROPERTIES(t)     READONLY nameTax, shortNameTax
PROPERTIES(t)     ADDFORM, EDITFORM, delete
PROPERTIES(s)     READONLY name, addressStore
PROPERTIES(ra, s) READONLY inRangeStore
PROPERTIES(ra)  READONLY dataRange, dataActingRateRange, dateFromActingRateRange, dateToActingRateRange, nameUserRateRange, nameRangeTypeRange, quantityRateRange
FILTERS NOT NULL inTaxRange(t, ra),
        NOT NULL inRangeStore(ra, s);


//---------------------------- Рецепты блюд ----------------------------------------//
CLASS recipe 'Рецепт' : named;
CLASS recipeDetail 'Сырье рецепта';

dishRecipe  'Блюдо (ИД)' = DATA item (recipe) IN idGroup;
CONSTRAINT CHECKED dishRecipe (recipe) AND NOT isManufacturedItem(dishRecipe(recipe)) MSG 'Блюдо должно производиться';
nameDishRecipe 'Блюдо' = name(dishRecipe(recipe)) IN baseGroup;

beginDateRecipe 'Используется с' = DATA DATE (recipe) IN baseGroup;
isUsedRecipe 'Используется' = DATA BOOLEAN (recipe) IN baseGroup;
numberRecipe 'Номер рецептуры (из сборника и пр.)' = DATA STRING[40] (recipe) IN baseGroup;
notesRecipe 'Технология приготовления' = DATA STRING[100] (recipe) IN baseGroup;
outWeightRecipe 'Количество выхода изделия' = DATA DOUBLE (recipe) IN baseGroup;

recipeRecipeDetail 'Рецепт (ИД)' = DATA recipe(recipeDetail) IN baseGroup;
componentRecipeDetail 'Компонент (ИД)' = DATA component(recipeDetail) IN idGroup;
nameComponentRecipeDetail 'Компонент' = name(componentRecipeDetail(recipeDetail)) IN baseGroup;
normQuantityRecipeDetail 'Норма закладки (брутто)' = DATA DOUBLE (recipeDetail) IN baseGroup;

inRecipeRecipeDetail(recipe, recipeDetail) = recipeRecipeDetail(recipeDetail) == recipe;

FORM recipe 'Рецепт блюда'
OBJECTS r=recipe FIXED PANEL
OBJECTS rd=recipeDetail
PROPERTIES(r) nameDishRecipe, numberRecipe, beginDateRecipe, isUsedRecipe, notesRecipe, outWeightRecipe
PROPERTIES(rd) nameComponentRecipeDetail, normQuantityRecipeDetail, ADDOBJ, delete
FILTERS NOT NULL inRecipeRecipeDetail(r, rd)
EDIT recipe OBJECT r;

FORM recipes 'Рецепты блюд'
OBJECTS r=recipe
OBJECTS rd=recipeDetail
PROPERTIES(r) READONLY nameDishRecipe, numberRecipe, isUsedRecipe
PROPERTIES(r) ADDFORM, EDITFORM, delete
PROPERTIES(rd) READONLY nameComponentRecipeDetail, normQuantityRecipeDetail
FILTERS NOT NULL inRecipeRecipeDetail(r, rd);


//---------------------------- Товар на оборудовании ----------------------------------------//

CLASS stage 'Ячейка';
valueStage 'Ячейка' = DATA INTEGER (stage) IN baseGroup;
barcodeStageGroupMachinery 'Штрих-код ИД' = DATA barcode (stage, groupMachinery) IN idGroup;
priceStageGroupMachinery 'Розничная цена для штрих-кода' (stage, groupMachinery) = DATA DOUBLE (stage, groupMachinery) IN baseGroup;
dateStageGroupMachinery 'Дата истечения срока годности' (stage, groupMachinery) = DATA DATE (stage, groupMachinery) IN baseGroup;
timeStageGroupMachinery 'Время истечения срока годности' (stage, groupMachinery) = DATA INTEGER (stage, groupMachinery) IN baseGroup;
stockStageGroupMachinery 'Остаток на момент передачи' (stage, groupMachinery) = DATA DOUBLE (stage, groupMachinery) IN baseGroup;

barcodeBarcodeStageGroupMachinery 'Штрих-код' (stage, groupMachinery) = barcode(barcodeStageGroupMachinery(stage, groupMachinery)) IN baseGroup;
//nameSkuBarcodeStageGroupMachinery 'Товар' (stage, groupMachinery) = nameSkuBarcode(barcodeStageGroupMachinery(stage, groupMachinery)) IN baseGroup;
//titleScalesBarcodeStageGroupMachinery 'Наименование для весов' (stage, groupMachinery) = titleScalesBarcode(barcodeStageGroupMachinery(stage, groupMachinery));
//titleCashBarcodeStageGroupMachinery 'Наименование для касс' (stage, groupMachinery) = titleCashBarcode(barcodeStageGroupMachinery(stage, groupMachinery));
//amountBarcodeStageGroupMachinery 'Количество (сколько списать при продаже)' (stage, groupMachinery) = amountBarcode(barcodeStageGroupMachinery(stage, groupMachinery));
//removeBarcodeStageGroupMachinery 'Заблокирован (удален с оборудования)' (stage, groupMachinery) = removeBarcode(barcodeStageGroupMachinery(stage, groupMachinery));
//commentRemoveBarcodeStageGroupMachinery 'Причина блокировки' (stage, groupMachinery) = commentRemoveBarcode(barcodeStageGroupMachinery(stage, groupMachinery));

FORM stages 'Товары на оборудовании'
OBJECTS gr=groupMachinery
OBJECTS st=stage
PROPERTIES(gr) READONLY nameDepartmentStoreGroupMachinery, nameGroupMachinery, transferGroupMachinery
PROPERTIES(st) valueStage
PROPERTIES(st, gr)  barcodeBarcodeStageGroupMachinery, priceStageGroupMachinery, dateStageGroupMachinery,
                    timeStageGroupMachinery, stockStageGroupMachinery
FILTERS  NOT NULL barcodeStageGroupMachinery(st, gr);

//---------------------------- Кассовые отчеты ----------------------------------------//
CLASS cashReport 'Кассовый отчет' : transaction;
CLASS cashDocument 'Кассовый документ';
CLASS incomeCashOrder 'ПКО': cashDocument;
CLASS outcomeCashOrder 'РКО': cashDocument;
CLASS bankCardsReport 'Отчет по банковским карточкам': cashDocument;

numberCashReport 'Номер кассового отчета' (cashReport) = DATA INTEGER (cashReport) IN baseGroup;
startDateCashReport 'Дата начала' (cashReport) = DATA DATE (cashReport) IN baseGroup;
endDateCashReport 'Дата окончания' (cashReport) = DATA DATE (cashReport) IN baseGroup;

reportCashDocument 'Отчет документа (ИД)' (cashDocument) = DATA cashReport (cashDocument) IN idGroup;
numberCashDocument 'Номер документа' (cashDocument) = DATA INTEGER (cashDocument) IN baseGroup;
sumCashDocument 'Сумма документа' (cashDocument) = DATA DOUBLE (cashDocument) IN baseGroup;
cashIncomeCashOrder 'Выручка кассы (ИД)' (incomeCashOrder) = DATA cash(incomeCashOrder) IN idGroup;
numberCashIncomeCashOrder 'Выручка кассы' (incomeCashOrder) = numberCash(cashIncomeCashOrder(incomeCashOrder)) IN baseGroup;
dopInfoCashDocument 'Описание' (cashDocument) = DATA STRING[10] (cashDocument) IN baseGroup;
infoCashDocument 'Основание документа' (cashDocument) = UNION EXCLUSIVE numberCashIncomeCashOrder(cashDocument) IF cashDocument IS incomeCashOrder, dopInfoCashDocument (cashDocument);

inCashReportDocument 'Документ в текущем кассовом отчете' (cashReport, cashDocument) = reportCashDocument(cashDocument)==cashReport;

FORM cashReport 'Кассовый отчет'
OBJECTS r=cashReport FIXED PANEL
OBJECTS d=cashDocument
PROPERTIES (r) numberCashReport, startDateCashReport, endDateCashReport
PROPERTIES (d) objectClassName, numberCashDocument, infoCashDocument, sumCashDocument, ADDOBJ, delete
FILTERS NOT NULL inCashReportDocument(r,d)
EDIT cashReport OBJECT r;

FORM cashReports 'Кассовые отчеты'
OBJECTS r=cashReport, d=cashDocument
PROPERTIES (r) startDateCashReport, endDateCashReport
PROPERTIES (r) ADDFORM, EDITFORM, delete
PROPERTIES (d) READONLY numberCashDocument, sumCashDocument
FILTERS NOT NULL inCashReportDocument(r,d);

//---------------------------- Импорт данных ----------------------------------------//

importDataAction 'Импортировать данные' = ACTION 'rublevski.actions.ImportDataActionProperty';
importUrl 'URL' = DATA STRING[200] ();
importLogin 'Логин' = DATA STRING[200] ();
importPassword 'Пароль' = DATA STRING[200] ();

FORM importData 'Импорт данных'
PROPERTIES() importDataAction, importUrl, importLogin, importPassword;

//---------------------------- Настройка навигатора ----------------------------------------//

WINDOW TOOLBAR topToolbar 'Папки' VERTICAL HIDETITLE HIDESCROLLBARS POSITION(0, 0, 20, 5);
WINDOW TOOLBAR formsToolbar 'Формы' VERTICAL HIDETITLE POSITION (0, 5, 20, 65);
WINDOW TREE formsTree 'Формы' HIDETITLE POSITION (0, 5, 20, 65);

HIDE WINDOW BaseLogicsModule.relevantForms;
HIDE WINDOW BaseLogicsModule.relevantClassForms;

NAVIGATOR {

    baseElement TO topToolbar;

    NEW lists 'Справочники' TO formsToolbar {
        NEW goods 'Товары' {
            ADD items;
            ADD components;
            ADD itemGroups;
            ADD unitsOfMeasure;
            ADD assortments;
            ADD itemInDepartment;
        }
        NEW shopStructure 'Магазины' {
            ADD companies;
            ADD qualifier;
            ADD stores;
        }
        NEW employeeRelations 'Сотрудники' {
            ADD employees;
            ADD employeesCommittees;
            ADD groupsUser;
        }
        NEW supplierRelation 'Поставщики'{
            ADD suppliers;
            ADD banks;
            ADD assortmentSupplier;
            ADD orderSuppliers;
            ADD genTimeTables;
            ADD timeTableDate;
        }
        NEW equipment 'Оборудование' {
            ADD groupsCash;
            ADD groupsScales;
            ADD groupsCheck;
            ADD machineries;
            ADD models;
            ADD stages;
            ADD cashReports;
        }
        NEW producing 'Производство'{
            ADD cuttings;
            ADD recipes;
        }
        NEW pricing 'Ценообразование'{
            ADD taxes;
        }
    }

    NEW documents 'Документы' TO formsToolbar {

    }

    ADD adminElement TO formsTree {
        NEW objects 'Карточки' {
            ADD itemGroup;
            ADD unitOfMeasure;
            ADD item;
            ADD barcode;
            ADD employee;
            ADD groupUser;
            ADD tradingSquare;
            ADD departmentStore;
            ADD store;
            ADD tradingNetwork;
            ADD revaluationCommittee;
            ADD bank;
            ADD ownership;
            ADD supplier;
            ADD company;
            ADD cashModel;
            ADD scalesModel;
            ADD checkModel;
            ADD assortment;
            ADD typeItem;
            ADD tag;
            ADD rowTorg1;
            ADD color;
            ADD taste;
            ADD pack;
            ADD sort;
            ADD size;
            ADD specialty;
            ADD coolingDegree;
            ADD addNameisPortionBarItem;
            ADD nameisPortionBarItem;
            ADD addNamebanDiscountItem;
            ADD namebanDiscountItem;
            ADD addcoefficientNetGrossItem;
            ADD coefficientNetGrossItem;
            ADD addrateNaturalLossItem;
            ADD rateNaturalLossItem;
            ADD addNDSSupplierItem;
            ADD NDSSupplierItem;
            ADD addimporterPriceItem;
            ADD importerPriceItem;
            ADD addmaxReserveItemDepartment;
            ADD maxReserveItemDepartment;
            ADD addminReserveItemDepartment;
            ADD minReserveItemDepartment;
            ADD addNamebanRevaluationItemDepartment;
            ADD namebanRevaluationItemDepartment;
            ADD addNameinActionItemDepartment;
            ADD nameinActionItemDepartment;
            ADD addmarginProductionItemDepartment;
            ADD marginProductionItemDepartment;
            ADD addretailPriceItemDepartment;
            ADD retailPriceItemDepartment;
            ADD adddiscountItemDepartment;
            ADD discountItemDepartment;
            //ADD addNameisSupplierItemDepartment;
            //ADD nameisSupplierItemDepartment;
            ADD cash;
            ADD scales;
            ADD check;
            ADD tax;
            ADD cutting;
            ADD recipe;
            ADD groupCash;
            ADD groupScales;
            ADD groupCheck;
            ADD component;
            ADD addaddressLegalEntity;
            ADD addressLegalEntity;
            ADD addpostAddressLegalEntity;
            ADD postAddressLegalEntity;
            ADD addmanagerLegalEntity;
            ADD managerLegalEntity;
            ADD addaccountantLegalEntity;
            ADD accountantLegalEntity;
            ADD addphoneLegalEntity;
            ADD phoneLegalEntity;
            ADD addNamesureSupplierDepartmentStore;
            ADD namesureSupplierDepartmentStore;
            ADD addressBank;
            ADD addaddressBank;
            ADD nameformContract;
            ADD addNameformContract;
            ADD delayContract;
            ADD adddelayContract;
            ADD genTimeTable;
            ADD addNamediscount;
            ADD addtimeTable;
            ADD orderSupplier;
            ADD timeTable;
            ADD cashReport;
            ADD namediscount;
        }
        ADD importData;
    }
}

