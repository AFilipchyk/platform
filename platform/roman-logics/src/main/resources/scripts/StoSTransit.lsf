//To Store From Store (the different company)
MODULE StoSTransit;

REQUIRE System,

        Stock,
        Numerator,
        Document,
        RomanDocument,
        Consignment,
        Declaration,
        MasterData,
        RomanLogicsModule;

PRIORITY RomanLogicsModule, Stock;

CLASS StoSTr 'Перемещение (расход) на магазин (др. юрлицо)' : historyObject, numberedObject, consignment;
CLASS StoSTrDetail 'Строка перемещения (расход) на магазин (др. юрлицо)' : outAutoSkuLedger, consignmentDetail;
CLASS StoSTrPosted 'Закрытое перемещение (расход) на магазин (др.юрлицо)' : StoSTr, postedObject, consignment;


skuStoSTrDetail 'Товар (ИД)' (StoSTrDetail) = DATA sku (StoSTrDetail)IN idGroup;
nameSkuStoSTrDetail 'Наименование товара' (StoSTrDetail) = nameSku(skuStoSTrDetail(StoSTrDetail));

@defineRBCorrespondingDocumentWithRetailPrices(StoSTr, departmentStore, 'Отдел документа', sku, 'Перемещение (расход) на магазин (др. юрлицо)', store, 'Магазин-получатель');
@defineDocumentDetailPackWeightSku(StoSTr);
@defineDocumentHeaderSkuQuantity(StoSTr);

senderStoreStoSTr 'Магазин-отправитель (ИД)' (StoSTr) = storeDepartmentStore(departmentStoreStoSTr(StoSTr));
nameSenderStoreStoSTrDetail 'Магазин-отправитель' (StoSTrDetail) = name(senderStoreStoSTr(StoSTrDetail)) MINCHARWIDTH 20 PREFCHARWIDTH 20;

CONSTRAINT StoSTr IS StoSTr AND companyStore(senderStoreStoSTr(StoSTr)) == companyStore(storeStoSTr(StoSTr))
    CHECKED BY storeStoSTr  MESSAGE 'Перемещение (расход) в рамках одного юрлица';

transitWarehouseStoSTr 'Промежуточный склад (ИД)' (WHtoSTr) = DATA warehouse (StoSTr) IN idGroup;
nameTransitWarehouseStoSTr 'Промежуточный склад' (StoSTr) = name(transitWarehouseStoSTr(StoSTr)) IN documentHeaderGroup  MINCHARWIDTH 20 PREFCHARWIDTH 20;

CONSTRAINT StoSTr IS StoSTr AND NOT companyWarehouse(transitWarehouseStoSTr(StoSTr)) == companyStore(storeStoSTr(StoSTr))
    CHECKED BY storeStoSTr, transitWarehouseStoSTr MESSAGE 'Промежуточный склад и магазин-получатель не одного юрлица';

CONSTRAINT StoSTr IS StoSTr AND companyWarehouse(transitWarehouseStoSTr(StoSTr)) == companyStore(senderStoreStoSTr(StoSTr))
    CHECKED BY senderStoreStoSTr, transitWarehouseStoSTr MESSAGE 'Промежуточный склад и магазин-получатель д.б. разных юрлиц';

//quantityOutAutoSkuLedger (ledger) += quantityStoSTrDetail (ledger);
//descriptionSkuLedger (ledger) += descriptionStoSTrDetail (ledger);


FORM StoSTr 'Перемещение (расход) на магазин (др. юрлицо)'
    OBJECTS s = StoSTr FIXED PANEL
    PROPERTIES (s) numberObject, seriesObject, dateStoSTr, timeStoSTr, nameDepartmentStoreStoSTr, nameStoreStoSTr, nameTransitWarehouseStoSTr,
                   quantityStoSTrDetailStoSTr, invoiceVATSumStoSTrDetailStoSTr, invoiceSumStoSTrDetailStoSTr, retailSumStoSTrDetailStoSTr, noteStoSTr



//    PROPERTIES (s) numberObject, seriesObject, dateStoSTr, timeStoSTr, nameDepartmentStoreStoSTr, nameRecipientStoreStoSTr, nameTransitWarehouseStoSTr,
//                   quantityStoSTrDetailStoSTr, importerSumStoSTrDetailStoSTr, sumRetailVATStoSTrDetailStoSTr,
//                   retailSumStoSTrDetailStoSTr, sumNetWeightStoSTr, packQuantityStoSTrDetailStoSTr, noteStoSTr

    OBJECTS d = StoSTrDetail
//    PROPERTIES(d) indexStoSTrDetail, barcodeStoSTrDetail, nameSkuStoSTrDetail, nameBrandStoSTrDetail, sidArticleStoSTrDetail,
//                  nameCategoryStoSTrDetail, sidColorStoSTrDetail, nameColorStoSTrDetail, shortNameUOMStoSTrDetail, balanceBSkuStoSTrDetail,
//                  quantityStoSTrDetail, retailPriceStoSTrDetail, importerSumStoSTrDetail, numberRetailVATStoSTrDetail, valueRetailVATStoSTrDetail,
//                  sumRetailVATStoSTrDetail, retailSumStoSTrDetail
    PROPERTIES(d) indexStoSTrDetail, barcodeStoSTrDetail, nameSkuStoSTrDetail, nameBrandStoSTrDetail, sidArticleStoSTrDetail,
                  nameCategoryStoSTrDetail, sidColorStoSTrDetail, nameColorStoSTrDetail, shortNameUOMStoSTrDetail, balanceBSkuStoSTrDetail,
                  quantityStoSTrDetail, importerPriceStoSTrDetail, supplierPriceStoSTrDetail,
                  numberSupplierVATStoSTrDetail, valueSupplierVATStoSTrDetail,
                  supplierVATISumStoSTrDetail, invoiceISumStoSTrDetail,
                  numberRetailVATStoSTrDetail, valueRetailVATStoSTrDetail,
                  retailPriceStoSTrDetail


    PROPERTIES(s) TODRAW d addDetailDialogSkuStoSTrDetailStoSTr, addDetailDialogBarcodeStoSTrDetailStoSTr, deleteStoSTrDetailStoSTr


    PROPERTIES(d) ADDOBJ, delete

    FILTERS inStoSTrStoSTrDetail(s, d)

    EDIT StoSTr OBJECT s
;

DESIGN StoSTr FROM DEFAULT {
    main {
        preferredSize = (1024, 768);
        ADD s.box {
            childConstraints = TO THE RIGHT;
            NEW row1 {
                childConstraints = TO THE BOTTOM;
                ADD s.documentHeaderGroup {
                    childConstraints = TO THE RIGHT;
                    ADD PROPERTY (nameDepartmentStoreStoSTr);
                    ADD PROPERTY (numberObject);
                    ADD PROPERTY (seriesObject);
                    ADD PROPERTY (dateStoSTr);
                    ADD PROPERTY (timeStoSTr);
                }
                NEW case1 {
                childConstraints = TO THE RIGHT;
                    NEW case11 {
                        title = 'Контрагент';
                        ADD PROPERTY (nameStoreStoSTr);
                    }
                    NEW case12 {
                        title = 'Транзит';
                        ADD PROPERTY (nameTransitWarehouseStoSTr);
                    }
                }
                ADD s.documentPrmGroup;
            }
            NEW row2 {
                ADD s.documentSumGroup {
                    childConstraints = TO THE BOTTOM;
                }
            }
        };
        ADD d.box;
        ADD functions.box;
    }
}

FORM StoSTrs 'Перемещения (расход) на магазин (др. юрлицо)'
    OBJECTS s = StoSTr
//    PROPERTIES (s) READONLY objectClassName, numberObject, seriesObject, dateStoSTr, timeStoSTr, nameDepartmentStoreStoSTr, nameRecipientStoreStoSTr,
//                   countStoSTrDetailStoSTr, quantityStoSTrDetailStoSTr, importerSumStoSTrDetailStoSTr, sumRetailVATStoSTrDetailStoSTr,
//                   retailSumStoSTrDetailStoSTr, sumNetWeightStoSTr, packQuantityStoSTrDetailStoSTr

    PROPERTIES (s) READONLY objectClassName, numberObject, seriesObject, dateStoSTr, timeStoSTr, nameDepartmentStoreStoSTr, nameStoreStoSTr,
                   countStoSTrDetailStoSTr, quantityStoSTrDetailStoSTr, invoiceVATSumStoSTrDetailStoSTr, invoiceSumStoSTrDetailStoSTr,
                   retailSumStoSTrDetailStoSTr

    PROPERTIES (s) READONLY FORCE PANEL nameUserCreated, timeCreated, hostnameComputerCreated, nameUserClosed, timeClosed, hostnameComputerClosed


    PROPERTIES (s) ADDFORM, EDITFORM SHOWIF isDraftStoSTr(s), delete FORCE PANEL SHOWIF isDraftStoSTr(s),
                   postStoSTr SHOWIF isDraftStoSTr(s), unpostStoSTr SHOWIF isPostedStoSTr(s)

    PROPERTIES (s) FORCE PANEL printConsignmentVerticalA, printConsignmentHorizontalA,
                   printConsignmentVerticalB, printConsignmentHorizontalB,
                   printConsignmentAttach, printConsignmentSimpleHorizontal, editConsignment,
                   printConsignmentSimpleVertical, printConsignmentSimpleAttach

    OBJECTS d = StoSTrDetail
//    PROPERTIES(d) READONLY indexStoSTrDetail, barcodeStoSTrDetail, nameSkuStoSTrDetail, shortNameUOMStoSTrDetail,
//                  quantityStoSTrDetail, retailPriceStoSTrDetail, importerSumStoSTrDetail, numberRetailVATStoSTrDetail, valueRetailVATStoSTrDetail,
//                  sumRetailVATStoSTrDetail, retailSumStoSTrDetail
    PROPERTIES(d) READONLY  indexStoSTrDetail, barcodeStoSTrDetail, nameSkuStoSTrDetail, shortNameUOMStoSTrDetail, balanceBSkuStoSTrDetail,
                  quantityStoSTrDetail, importerPriceStoSTrDetail, supplierPriceStoSTrDetail,
                  numberSupplierVATStoSTrDetail, valueSupplierVATStoSTrDetail,
                  supplierVATISumStoSTrDetail, invoiceISumStoSTrDetail,
                  numberRetailVATStoSTrDetail, valueRetailVATStoSTrDetail,
                  retailPriceStoSTrDetail

    FILTERS inStoSTrStoSTrDetail(s, d)
;

DESIGN StoSTrs FROM DEFAULT {
    ADD s.box{
        PROPERTY (delete(s)) {
            panelLocation = TOOLBAR;
            askConfirm = TRUE;
        PROPERTY (objectClassName(s)) {
            preferredCharWidth = 15;
        }
        }
    }
    ADD d.box;

    NEW footer.container {
        childConstraints = TO THE BOTTOM;

        NEW cont3 {
            childConstraints = TO THE RIGHT;
            ADD s.historyGroup {
                childConstraints = TO THE BOTTOM;
            }

            ADD s.postedGroup {
                childConstraints = TO THE BOTTOM;
            }
        }

        ADD s.printGroup {
            childConstraints = TO THE BOTTOM;
            NEW case55{
                childConstraints = TO THE RIGHT;

                NEW contOne {
                    title = 'Накладная';
                    ADD PROPERTY(editConsignment);
                }
                NEW tn{
                    childConstraints = TO THE RIGHT;
                    title = 'ТН-2';
                    ADD PROPERTY(printConsignmentSimpleVertical);
                    ADD PROPERTY(printConsignmentSimpleHorizontal);
                    ADD PROPERTY(printConsignmentSimpleAttach);
                }
            }
            NEW ttn1{
                childConstraints = TO THE RIGHT;
                title = 'ТТН-1';
                ADD PROPERTY(printConsignmentVerticalA);
                ADD PROPERTY(printConsignmentHorizontalA);
                ADD PROPERTY(printConsignmentVerticalB);
                ADD PROPERTY(printConsignmentHorizontalB);
                ADD PROPERTY(printConsignmentAttach);
            }

        }

    }
    ADD functions.box;
}

FORM StoSTrsDialog 'Перемещения (расход) на магазин (др. юрлицо)'
    OBJECTS s = StoSTrPosted
    PROPERTIES (s) READONLY objectClassName, numberObject, seriesObject, dateStoSTr, nameDepartmentStoreStoSTr,
                   nameStoreStoSTr, countStoSTrDetailStoSTr, quantityStoSTrDetailStoSTr, invoiceVATSumStoSTrDetailStoSTr,
                   invoiceSumStoSTrDetailStoSTr, retailSumStoSTrDetailStoSTr

    DIALOG StoSTrPosted OBJECT s
;

@defineConsignment(StoSTr);
@implementConsignmentHeader(StoSTr, departmentStore);

senderConsignment (consignment) += companyStore(senderStoreStoSTr(consignment));
recipientConsignment (consignment) += companyStore(storeStoSTr(consignment));

consignmentConsignmentDetail (consignmentDetail) += StoSTrStoSTrDetail (consignmentDetail);
skuConsignmentDetail (consignmentDetail) += skuStoSTrDetail (consignmentDetail);
shortNameUOMConsignmentDetail (consignmentDetail) += shortNameUOMStoSTrDetail (consignmentDetail);
quantityConsignmentDetail (consignmentDetail) += quantityStoSTrDetail (consignmentDetail);
priceConsignmentDetail (consignmentDetail) += retailPriceStoSTrDetail (consignmentDetail);
vatConsignmentDetail (consignmentDetail) += valueRetailVATStoSTrDetail (consignmentDetail);
sumVATConsignmentDetail (consignmentDetail) += supplierVATISumStoSTrDetail (consignmentDetail);
sumConsignmentDetail (consignmentDetail) += supplierSumStoSTrDetail (consignmentDetail);
sumInvoiceConsignmentDetail (consignmentDetail) += invoiceSumStoSTrDetail (consignmentDetail);
grossWeightConsignmentDetail (consignmentDetail) += grossWeightStoSTrDetail (consignmentDetail);
packQuantityConsignmentDetail (consignmentDetail) += packQuantityStoSTrDetail(consignmentDetail);
//currencyConsignment(consignment) += currencyStoSTr(consignment);
//isCustomsFlowConsignment (consignment) += consignment IS StoSTr;
noteConsignment(consignment) += noteStoSTr(consignment);

//noteConsignmentDetail

//todo: Надо наполнить свойствами накладную. (УНП...)