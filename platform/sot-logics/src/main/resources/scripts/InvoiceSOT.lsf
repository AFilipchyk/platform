MODULE InvoiceSOT;

REQUIRE System, PurchaseInvoice, Certificate, PurchaseCompliance, PurchaseDeclaration, PurchaseSanitation;

NAMESPACE PurchaseInvoice;

certificateTextNotNullBatch(batch) = toText('') IF batch IS batch OR certificateTextBatch(batch);

necessaryBatchPriceCertificateText = GROUP MAX batch BY skuBatch(batch), costBatch (batch), certificateTextNotNullBatch(batch);
//necessaryBatchUserInvoiceDetail = necessaryBatch (priceUserInvoiceDetail(userInvoiceDetail), toText('    ') IF userInvoiceDetail IS userInvoiceDetail OR certificateTextUserInvoiceDetail(userInvoiceDetail));
//descriptionNecessaryBatchUserInvoiceDetail = descriptionBatch(necessaryBatchUserInvoiceDetail(userInvoiceDetail));

usePurchaseBatchAutoSet 'Автоматически определять партии на приходе' = DATA BOOLEAN ();

ON SESSION { // FORMS userInvoice
    IF usePurchaseBatchAutoSet() THEN 
        FOR CHANGED(skuUserInvoiceDetail(detail)) OR
            CHANGED(shipmentPriceUserInvoiceDetail(detail)) OR
            CHANGED(certificateTextUserInvoiceDetail(detail)) DO
                SET batchUserInvoiceDetail (detail) <-
                    necessaryBatchPriceCertificateText (skuUserInvoiceDetail(detail), shipmentPriceUserInvoiceDetail(detail), toText('') IF detail IS userInvoiceDetail OR certificateTextUserInvoiceDetail(detail));
};

//EXTEND FORM userInvoice
//    PROPERTIES(d) descriptionNecessaryBatchUserInvoiceDetail
//    ;

EXTEND FORM dialogBatch
    PROPERTIES (bt) READONLY certificateTextBatch
;

EXTEND FORM options
    PROPERTIES() usePurchaseBatchAutoSet
;

EXTEND DESIGN options {
    commons {
        ADD PROPERTY(usePurchaseBatchAutoSet);
    }
}