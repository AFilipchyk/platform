MODULE Machinery;

REQUIRE System, Stock;

//---------------------------- Сервера управления оборудования ----------------------------//

CLASS equipmentServer 'Сервер оборудования' : named;
TABLE equipmentServer (equipmentServer);

sidEquipmentServer 'Идентификатор' = DATA STRING[20] (equipmentServer) IN baseGroup;
sidToEquipmentServer(equipmentServer) = GROUP UNIQUE equipmentServer BY sidEquipmentServer (equipmentServer) WHERE equipmentServer IS equipmentServer;
delayEquipmentServer 'Период обновления (в миллисекундах)' = DATA INTEGER (equipmentServer) IN baseGroup;

//---------------------------- Ошибки сервера оборудования ----------------------------//

CLASS equipmentServerError 'Ошибки';
TABLE equipmentServerError (equipmentServerError);

dataEquipmentServerError 'Сообщение об ошибке' = DATA STRING[200] (equipmentServerError) IN baseGroup;
erTraceEquipmentServerError 'След ошибки' = DATA TEXT (equipmentServerError) IN baseGroup;
dateEquipmentServerError 'Время возникновения' = DATA DATETIME (equipmentServerError) IN baseGroup;
equipmentServerEquipmentServerError 'Сервер оборудования (ID)' = DATA equipmentServer(equipmentServerError) IN baseGroup;

//---------------------------- Лог сервера оборудования ----------------------------//

CLASS equipmentServerLog 'Лог';
TABLE equipmentServerLog (equipmentServerLog);

dataEquipmentServerLog 'Сообщение' = DATA TEXT (equipmentServerLog) IN baseGroup;
dateEquipmentServerLog 'Время' = DATA DATETIME (equipmentServerLog) IN baseGroup;
equipmentServerEquipmentServerLog 'Сервер оборудования (ID)' = DATA equipmentServer(equipmentServerLog) IN baseGroup;

//---------------------------- Формы для серверов оборудования ----------------------------//

FORM equipmentServer 'Серверы оборудования'
    OBJECTS es = equipmentServer
    PROPERTIES(es)  READONLY sidEquipmentServer
    PROPERTIES(es)  delayEquipmentServer, ADDFORM, EDITFORM, delete

    OBJECTS e = equipmentServerError
    PROPERTIES(e) READONLY dataEquipmentServerError, dateEquipmentServerError
    PROPERTIES(e) delete
    PROPERTIES(e) FORCE PANEL erTraceEquipmentServerError

    OBJECTS l = equipmentServerLog
    PROPERTIES(l) READONLY dataEquipmentServerLog, dateEquipmentServerLog
    PROPERTIES(l) delete

    FILTERS equipmentServerEquipmentServerError (e) == es
    FILTERS equipmentServerEquipmentServerLog (l) == es
;

DESIGN equipmentServer FROM DEFAULT {
    main {
        NEW topContainer {
            type = SPLITV;
            childConstraints =  TO THE BOTTOM;

            ADD es.box;

            NEW specContainer {
                type = TABBED;

                NEW errorContainer {
                    title = 'Ошибки';
                    ADD e.box;
                    PROPERTY(erTraceEquipmentServerError(e)) {
                        fillHorizontal = 1;
                        panelLabelAbove = TRUE;
                    }
                }
                ADD l.box;
            }
        }
        ADD functions.box;
    }
}

//---------------------------- группы оборудования ----------------------------------------//

CLASS ABSTRACT groupMachinery 'Группы оборудования';
TABLE groupMachinery (groupMachinery);

nameGroupMachinery 'Наименование' = DATA STRING[200] (groupMachinery) IN baseGroup MINCHARWIDTH 10 PREFCHARWIDTH 20;

equipmentServerGroupMachinery = DATA equipmentServer (groupMachinery);
nameEquipmentServerGroupMachinery 'Сервер оборудования' (groupMachinery) = name(equipmentServerGroupMachinery(groupMachinery));
sidEquipmentServerGroupMachinery 'ИД сервера оборудования' (groupMachinery) = sidEquipmentServer(equipmentServerGroupMachinery(groupMachinery));

// -------------------------------- Склады --------------------------------------------- //

stockGroupMachinery = ABSTRACT stock (groupMachinery);
nameStockGroupMachinery 'Склад' (groupMachinery) = name(stockGroupMachinery(groupMachinery));

// фильтрация по группам товаров

filterSkuGroupMachinery 'Фильтровать по классификатору' = DATA BOOLEAN (groupMachinery);

inGroupMachinerySkuGroup 'Вкл' = DATA BOOLEAN (groupMachinery, skuGroup);

FORM filterSkuGroupMachinery 'Фильтрация по классификатору'
    OBJECTS gm = groupMachinery FIXED PANEL
    PROPERTIES(gm) READONLY nameStockGroupMachinery, nameEquipmentServerGroupMachinery, nameGroupMachinery

    TREE treeGroups g=skuGroup PARENT parentSkuGroup
    PROPERTIES READONLY name(g)
    ORDER BY name

    OBJECTS cg=skuGroup
    PROPERTIES(cg) READONLY canonicalNameSkuGroup
    PROPERTIES(gm, cg)      inGroupMachinerySkuGroup
    ORDER BY canonicalNameSkuGroup
    FILTERS isParentLeafSkuGroupSkuGroup(cg, g)

    FILTERGROUP filters
        FILTER 'Только выбранные группы' 'F10' inGroupMachinerySkuGroup(gm, cg)
;

DESIGN filterSkuGroupMachinery FROM DEFAULT {
    POSITION treeGroups.box TO THE LEFT cg.box;

    treeGroups.tree {
        fillHorizontal = 0.5;
    }
}

showFilterSkuGroupMachinery 'Выбрать группы' (groupMachinery) = ACTION FORM filterSkuGroupMachinery OBJECTS gm MODAL;

//---------------------------- Модели оборудования ----------------------------------------//
CLASS ABSTRACT model 'Модель' : named;
TABLE model (model);

noteModel 'Примечание' = DATA STRING[200] (model) IN baseGroup;
handlerModel 'Обработчик' = DATA STRING[200] (model) IN baseGroup;

maxProductModel 'MAX допустимое колич. товаров' = DATA INTEGER (model) IN baseGroup;

//---------------------------- типы оборудования  ----------------------------------------//
CLASS ABSTRACT machinery 'Оборудование';
TABLE machinery(machinery);

groupMachineryMachinery = ABSTRACT groupMachinery (machinery) PERSISTENT;
nameGroupMachineryMachinery 'Группа' (machinery) = nameGroupMachinery(groupMachineryMachinery(machinery));

modelMachinery = ABSTRACT model (machinery);
nameModelMachinery 'Модель' (machinery) = name(modelMachinery(machinery)) IN baseGroup;
handlerModelMachinery 'Обработчик' (machinery) = handlerModel(modelMachinery(machinery)) IN baseGroup;

nppMachinery 'Порядковый номер' = DATA INTEGER (machinery) IN baseGroup;
descriptionMachinery 'Описание' = DATA STRING[200] (machinery) IN baseGroup;
portMachinery 'Адрес/порт' = DATA STRING[100] (machinery) IN baseGroup;

