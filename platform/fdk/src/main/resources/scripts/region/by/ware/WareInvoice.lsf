MODULE WareInvoice;

REQUIRE Item, WareItem, Invoice, Shipment;

META defineInvoiceWare(NS)
    skipCreateWareUserInvoiceDetail = DATA BOOLEAN (NS.userInvoiceDetail);

    wareUserInvoiceDetailUserInvoiceDetail = DATA NS.userInvoiceDetail(NS.userInvoiceDetail);
    itemWareUserInvoiceDetailUserInvoiceDetail (userInvoiceDetail) =
        GROUP UNIQUE userInvoiceDetail BY wareUserInvoiceDetailUserInvoiceDetail(userInvoiceDetail) PERSISTENT;

    createWareUserInvoiceDetail = ACTION (userInvoiceDetail) {
        IF wareUserInvoiceDetailUserInvoiceDetail(userInvoiceDetail) THEN {
            SET NS.quantityUserInvoiceDetail(d) <- NS.quantityUserInvoiceDetail(userInvoiceDetail) WHERE d == wareUserInvoiceDetailUserInvoiceDetail(userInvoiceDetail);
        } ELSE
            FOR ADDOBJ d = userInvoiceDetail DO {
                SET NS.userInvoiceUserInvoiceDetail(d) <- NS.userInvoiceUserInvoiceDetail(userInvoiceDetail);
                SET NS.skuUserInvoiceDetail(d) <- wareItem(skuUserInvoiceDetail(userInvoiceDetail));
                SET NS.quantityUserInvoiceDetail(d) <- NS.quantityUserInvoiceDetail(userInvoiceDetail);
                SET wareUserInvoiceDetailUserInvoiceDetail(userInvoiceDetail) <- d;
                SET invoicePriceUserInvoiceDetail(d) <- warePriceDate(NS.skuUserInvoiceDetail(d), NS.dateUserInvoiceDetail(d));
                SET numberVATUserInvoiceDetail(d) <- numberRange(rangeWareDate(NS.skuUserInvoiceDetail(d), NS.dateUserInvoiceDetail(d)));
                SET valueVATUserInvoiceDetail(d) <- valueRateRangeDate(rangeWareDate(NS.skuUserInvoiceDetail(d), NS.dateUserInvoiceDetail(d)), NS.dateUserInvoiceDetail(d));
                SET priceUserInvoiceDetail(d) <- round2(invoicePriceUserInvoiceDetail(d)*100/(100+valueVATUserInvoiceDetail(d)));
            }
    }

    WHEN (CHANGED(NS.skuUserInvoiceDetail(detail)) OR CHANGED(NS.quantityUserInvoiceDetail(detail)))
         AND wareItem(NS.skuUserInvoiceDetail(detail)) AND NOT skipCreateWareUserInvoiceDetail(detail)
         DO EXEC createWareUserInvoiceDetail(detail) SESSION;

    NS.skipCreateShipmentInvoiceDetail(detail) += TRUE IF itemWareUserInvoiceDetailUserInvoiceDetail(detail);
END