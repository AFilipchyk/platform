MODULE Item;

REQUIRE System, Stock, Hierarchy, RetailCRM, Barcode, PriceList;

// ------------------------------------ Классификатор товаров --------------------------- //

CLASS itemGroup 'Товарная группа' : named, externalizable, skuGroup, priceGroup;

@defineHierarchy(itemGroup);

parentSkuGroup (itemGroup) += parentItemGroup(itemGroup);

// ------------------ Формы  --------------------- //

FORM itemGroup 'Товарная группа'
    OBJECTS g=itemGroup FIXED PANEL
    PROPERTIES(g) name, nameParentItemGroup
    EDIT itemGroup OBJECT g
;

FORM itemGroups 'Товарные группы'
    TREE treeGroups tg=itemGroup PARENT parentItemGroup
    PROPERTIES READONLY name(tg)
    ORDER BY name

    OBJECTS g=itemGroup
    PROPERTIES(g) READONLY canonicalNameItemGroup, sidExternalizable, delete
    PROPERTIES(g)          ADDFORM, EDITFORM
    ORDER BY canonicalNameItemGroup

    FILTERGROUP filters
        FILTER 'Все листья' 'F10' isParentLeafItemGroupItemGroup(g, tg) DEFAULT
        FILTER 'Всех потомков' 'F9' isParentItemGroupItemGroup(g, tg)
        FILTER 'Только непосредственных потомков' 'F8' parentItemGroup(g) == tg

    DIALOG itemGroup OBJECT g
;

DESIGN itemGroups FROM DEFAULT {
    NEW rootContainer BEFORE functions.box{
        childConstraints = TO THE RIGHT;
        type = SPLITH;

        ADD treeGroups.tree.box ;

        ADD g.box {
            fillHorizontal = 4;
            PROPERTY(sidExternalizable) {
                maximumCharWidth = 7;
            }
        }
    }
}


// ----------------------------------- Товары ----------------------------------- //

CLASS item 'Товар' : sku, externalizable;
TABLE item(item);

TABLE itemDate (item, DATE);

// Связь с группой товаров
itemGroupItem = DATA itemGroup(item) AUTOSET;
skuGroupSku(item) += itemGroupItem(item);
//roundSkuGroupSkuSku(item) += itemGroupItem(item);

nameItemGroupItem 'Группа товара' (item) = name(itemGroupItem(item));
canonicalNameItemGroupItem 'Группа товара' (item) = canonicalNameItemGroup(itemGroupItem(item)) IN base;

TABLE itemGroupItem (itemGroup, item);

isParentItemGroupItem (itemGroup, item) = isParentItemGroupItemGroup(itemGroupItem(item), itemGroup) PERSISTENT;

// Атрибуты
imageItem 'Изображение' = DATA IMAGEFILE (item);
loadImageItem 'Загрузить изображение' (item) = ACTION LOADFILE imageItem(item);

// --------------------------- Ценовые группы -------------------------------------//

parentPriceGroup(priceGroup) += parentItemGroup(priceGroup);
priceGroupSku(sku) += itemGroupItem(sku);

// ------------------------------------ Формы -------------------------- //
FORM item 'Товар'

    OBJECTS i=item FIXED PANEL

    PROPERTIES(i) canonicalNameItemGroupItem, idBarcodeSku READONLY,
                  imageItem, loadImageItem

    OBJECTS b=barcode
    PROPERTIES(b)       idBarcode, dateBarcode, shortNameUOMBarcode,
                        amountBarcode, activeBarcode, primaryBarcode ON CHANGE EXEC changePrimaryBarcodeSku(b,i)
    PROPERTIES(i)       generateBarcodeSku TODRAW b FORCE PANEL
    PROPERTIES(b)       ADDOBJ, delete
    FILTERS skuBarcode(b) == i

    OBJECTS dt2=DATE FIXED PANEL
    PROPERTIES (dt2) OBJVALUE BACKGROUND dateDiffersCurrent(dt2)

    OBJECTS c=country
    PROPERTIES (c) READONLY name

    EDIT item OBJECT i
;

DESIGN item FROM DEFAULT {
    main {
        NEW itemHeader BEFORE functions.box {
            childConstraints = TO THE RIGHT;
            NEW itemHeaderColumn1 {
                childConstraints = TO THE BOTTOM;
                ADD PROPERTY(canonicalNameItemGroupItem);
                ADD PROPERTY(idBarcodeSku);
            }
            NEW itemHeaderColumn2 {
                childConstraints = TO THE BOTTOM;
            }
        }
        NEW itemDetail BEFORE functions.box {
            type = TABBED;
            NEW itemPrimary {
                childConstraints = TO THE BOTTOM;
                title = 'Основные данные';
                fillVertical = 1.0;
                fillHorizontal = 1.0;

                NEW itemPrimaryRow1 {
                    childConstraints = TO THE RIGHT;
                    NEW itemPrimaryColumn1 {
                        childConstraints = TO THE BOTTOM;
                    }
                    NEW itemPrimaryColumn2 {
                        childConstraints = TO THE BOTTOM;
                    }
                }
                ADD b.box;
            }
            NEW regionalPrm {
                caption = 'Региональные параметры';
                ADD dt2.box;
                ADD c.box;

            }
            NEW itemImage {
                title = 'Изображение';
                ADD PROPERTY(imageItem);
                PROPERTY(imageItem) {
                    caption = '';
                    fillVertical = 1.0;
                    fillHorizontal = 1.0;
                }
                ADD PROPERTY(loadImageItem);
            }
       }
    }
}

editSku(sku) += [ACTION EDITFORM item](sku);
addSku () += [ACTION ADDFORM item]();

FORM items 'Товары'
    TREE treeGroup g=itemGroup PARENT parentItemGroup
    PROPERTIES READONLY name(g)
    ORDER BY name

    OBJECTS i=item
    PROPERTIES(i) READONLY idBarcodeSku
    PROPERTIES(i) ADDFORM, EDITFORM, delete

    DIALOG item OBJECT i
;

DESIGN items FROM DEFAULT {
    NEW rootContainer {
            type = SPLITH;
            childConstraints = TO THE RIGHT;
            ADD treeGroup.tree.box;
            ADD i.box {
                defaultComponent = TRUE;
                fillHorizontal = 4;
            }
    }
    ADD functions.box;
}

// ----------------------------------- Атрибуты товаров ------------------------------------------ //

CLASS ABSTRACT itemAttribute 'Атрибут товара' : named;
TABLE itemAttribute(itemAttribute);
TABLE itemItemAttribute(item, itemAttribute);

// Отображение
META defineItemAttribute (attribute, caption, group)
    show###attribute##ItemGroup caption (itemGroup) = DATA BOOLEAN (itemGroup) IN group;
    show###attribute##ItemGroup(itemGroup) <- TRUE WHEN ASSIGNED(itemGroup IS itemGroup);

    show###attribute##Item caption (item) = show###attribute##ItemGroup(itemGroupItem(item));
END

// Объявление
valueItemAttribute = ABSTRACT STRING[255] (item, itemAttribute) PERSISTENT;

META implementItemAttribute(attribute, caption, itemType, attributeClass)
    EXTEND CLASS itemType##ItemAttribute { attributeClass caption }
    value###itemType##ItemAttribute(item, attribute) += attribute##Item(item) WHEN attribute == itemType##ItemAttribute.##attributeClass;
END

//    value###attribute##ItemAttribute(item, attribute) = attribute##Item(item) AND attribute == itemType##ItemAttribute.##attributeClass;
//    value###itemType##ItemAttribute(item, attribute) += value###attribute##ItemAttribute(item, attribute);

META defineItemAttribute(attribute, formProperty, caption, group, itemType, attributeClass)
    @defineItemAttribute(attribute, caption, group);

    EXTEND FORM itemGroup PROPERTIES(g) show###attribute##ItemGroup;
    EXTEND FORM itemGroups PROPERTIES(g) BEFORE delete show###attribute##ItemGroup;
    EXTEND FORM item PROPERTIES(i) formProperty SHOWIF show###attribute##Item(i);
    EXTEND FORM items PROPERTIES(i) READONLY BEFORE delete formProperty SHOWIF show###attribute##ItemGroup(g);

    @implementItemAttribute(attribute, caption, itemType, attributeClass);
END

// Примитивный тип
META definePrimitiveItemAttribute(attribute, type, caption, group, itemType)
    attribute##Item caption = DATA type (item) IN group;
    @defineItemAttribute(attribute, attribute##Item, caption, group, itemType, item###attribute);
END

// Расширяем формы настройки
EXTEND FORM options
    OBJECTS ia = itemAttribute
    PROPERTIES(ia) name
;

EXTEND DESIGN options {
    pane {
        NEW itemTab {
            caption = 'Товары';
            ADD ia.box;
        }
    }
}

// -------------------------------------------- Формирование наименования ----------------------------------- //

prefixInNameItemAttribute 'Префикс' = DATA STRING[20] (itemAttribute);
postfixInNameItemAttribute 'Постфикс' = DATA STRING[20] (itemAttribute);

EXTEND FORM options PROPERTIES(ia) prefixInNameItemAttribute, postfixInNameItemAttribute;

META defineItemAttributeName (prefix, caption, group)
    numberInName###prefix##ItemAttribute 'Порядковый номер в наименовании'##caption = DATA INTEGER (itemAttribute) IN base;
    EXTEND FORM options PROPERTIES(ia) numberInName###prefix##ItemAttribute;

    name###prefix##AttributeItem 'Наименование'###caption (item) = toString255(
                    [GROUP CONCAT ustring3(prefixInNameItemAttribute(attribute) AND item IS item, valueItemAttribute(item, attribute), postfixInNameItemAttribute(attribute) AND item IS item)
                                  IF numberInName###prefix##ItemAttribute(attribute) AND valueItemAttribute(item, attribute), ' ' BY item ORDER numberInName###prefix##ItemAttribute(attribute)](item))
                    IN group PERSISTENT MINCHARWIDTH 20 PREFCHARWIDTH 80 INDEXED AGGPROP;
    EXTEND FORM item PROPERTIES(i) READONLY name###prefix##AttributeItem;
    EXTEND DESIGN item { itemHeaderColumn2 {ADD PROPERTY(name###prefix##AttributeItem); } }
END

// -------------------------------------- Типы атрибутов ------------------------------- //

// Строка
CLASS STATIC stringItemAttribute 'Строковый атрибут' : itemAttribute;

valueStringItemAttribute = ABSTRACT STRING[100] (item, stringItemAttribute) EXCLUSIVE PERSISTENT;
valueItemAttribute(item, attribute) += valueStringItemAttribute(item, attribute);

META defineStringItemAttribute(attribute, type, caption, group)
    @definePrimitiveItemAttribute(attribute, type, caption, group, string);
END

// Целое число
CLASS STATIC integerItemAttribute 'Целочисленный атрибут' : itemAttribute;

valueIntegerItemAttribute = ABSTRACT INTEGER (item, integerItemAttribute) EXCLUSIVE PERSISTENT;
stringIntegerItemAttribute(item, attribute) = toString255(valueIntegerItemAttribute(item, attribute));
valueItemAttribute(item, attribute) += stringIntegerItemAttribute(item, attribute);

META defineIntegerItemAttribute(attribute, caption, group)
    @definePrimitiveItemAttribute(attribute, INTEGER, caption, group, integer);
END

// Дробное число
CLASS STATIC doubleItemAttribute 'Дробный атрибут' : itemAttribute;

valueDoubleItemAttribute = ABSTRACT DOUBLE (item, doubleItemAttribute) EXCLUSIVE PERSISTENT;
stringDoubleItemAttribute(item, attribute) = toString255(valueDoubleItemAttribute(item, attribute));
valueItemAttribute(item, attribute) += stringDoubleItemAttribute(item, attribute);

META defineDoubleItemAttribute(attribute, type, caption, group)
    @definePrimitiveItemAttribute(attribute, type, caption, group, double);
END

// Объектный атрибут
CLASS STATIC objectItemAttribute 'Объектный атрибут' : itemAttribute;

valueObjectItemAttribute = ABSTRACT named (item, objectItemAttribute) EXCLUSIVE PERSISTENT;
nameObjectItemAttribute(item, attribute) = name(valueObjectItemAttribute(item, attribute));
valueItemAttribute(item, attribute) += nameObjectItemAttribute(item, attribute);

META implementObjectItemAttribute(attribute, caption)
    @implementItemAttribute(attribute, caption, object, item###attribute);
END

META defineObjectItemAttribute(attribute, identity, caption, group)
    attribute##Item = DATA attribute (item);
    identity###attribute##Item caption (item) = identity(attribute##Item(item)) IN group;
    @defineItemAttribute(attribute, identity###attribute##Item, caption, group, object, item###attribute);
END

// Краткое наименование атрибута
CLASS STATIC objectShortItemAttribute 'Объектный краткий атрибут' : itemAttribute;

valueObjectShortItemAttribute = ABSTRACT doubleNamed (item, objectShortItemAttribute) EXCLUSIVE PERSISTENT;
shortNameObjectItemAttribute(item, attribute) = shortName(valueObjectShortItemAttribute(item, attribute));
valueItemAttribute(item, attribute) += shortNameObjectItemAttribute(item, attribute);

META implementObjectShortItemAttribute(attribute, caption)
    EXTEND CLASS objectShortItemAttribute { shortItem###attribute caption }
    valueObjectShortItemAttribute(item, attribute) += attribute##Item(item) WHEN attribute == objectShortItemAttribute.shortItem###attribute;
END

//    value###attribute##ItemShortAttribute(item, attribute) = attribute##Item(item) AND attribute == objectShortItemAttribute.shortItem###attribute;

// ---------------------------- Конкретные свойства -------------------------------- //

GROUP itemBaseGroup 'Базовые свойства' : base;

// Группа
@implementObjectItemAttribute(itemGroup, 'Группа товаров');

// ------ Базовые свойства товара ------ //

// Название
@defineStringItemAttribute(caption, STRING[100], 'Название', itemBaseGroup);

// Единица измерения
@defineObjectItemAttribute(UOM, name, 'Единица измерения', itemBaseGroup);

shortNameUOMItem 'Единица измерения' (item) = shortName(UOMItem(item)) IN itemBaseGroup;
UOMSku(item) += UOMItem(item);

@implementObjectShortItemAttribute(UOM, 'Единица измерения (сокр.)');

// Брэнд
CLASS brand 'Бренд' : named, externalizable;
TABLE brand(brand);

@defineObjectItemAttribute(brand, name, 'Бренд', itemBaseGroup);

// Страна
@defineObjectItemAttribute(country, name, 'Страна', itemBaseGroup);
residentItem 'Отечественное производство' (item) = residentCountry(countryItem(item)) IN itemBaseGroup;
countrySku(sku) += countryItem(sku);

// Производитель
CLASS manufacturer 'Производитель товара' : named;
TABLE manufacturer(manufacturer);

@defineObjectItemAttribute(manufacturer, name, 'Производитель', itemBaseGroup);

// Тара
isContainerItem 'Тара' = DATA BOOLEAN (item) IN itemBaseGroup;
isContainerSku (sku) += isContainerItem(sku);
EXTEND FORM item PROPERTIES(i) isContainerItem;

// Весовой
isWeightItem 'Весовой товар' = DATA BOOLEAN (item) IN itemBaseGroup;
isWeightSku(sku) += isWeightItem(sku);
EXTEND FORM item PROPERTIES(i) isWeightItem;

// Неактивный
inactiveItem 'Неактивный' = DATA BOOLEAN (item) IN itemBaseGroup;
activeItem 'Активный' (item) = item IS item AND NOT inactiveItem(item);
inactiveSku(sku) += inactiveItem(sku);
EXTEND FORM item PROPERTIES(i) inactiveItem;
EXTEND FORM items FILTERGROUP inactive FILTER 'Активные' 'F10' activeItem(i) DEFAULT;

EXTEND DESIGN item { itemPrimaryColumn1 { ADD i.itemBaseGroup; } }

// ------ Габариты товара ------ //

GROUP itemSizeGroup 'Габариты товара' : public;

// Вес нетто
@defineDoubleItemAttribute(netWeight, NUMERIC[9,3], 'Вес нетто, кг', itemSizeGroup);
netWeightSku(sku) += netWeightItem(sku);

// Вес брутто
@defineDoubleItemAttribute(grossWeight, NUMERIC[9,3], 'Вес брутто, кг', itemSizeGroup);
grossWeightSku(sku) += grossWeightItem(sku);

// Кол-во в грузовом месте
// todo : здесь скорее всего надо будет рефакторить на более сложную логику
//@defineDoubleItemAttribute(quantityPack, NUMERIC[9,3], 'Количество в грузовом месте', itemSizeGroup);
//quantityPackSku(sku) += quantityPackItem(sku);

EXTEND DESIGN item { itemPrimaryColumn2 { ADD i.itemSizeGroup; } }

// ---------------------------------------------- Формирование наименований -------------------------------------- //

// Базовое наименование
@defineItemAttributeName( , , recognize);
nameSku(item) += nameAttributeItem(item);

// для оптимизации запросов
nameAttributeItemGroupItem 'Наименование' (itemGroup, item) = nameAttributeItem(item) AND isParentItemGroupItem(itemGroup, item) PERSISTENT INDEXED;

// Кассы
@defineItemAttributeName(cashRegister, ' (кассы)', public);
dataTitleCashRegisterBarcode 'Наименование для касс' = DATA STRING[100] (barcode);
titleCashRegisterBarcode 'Наименование для касс' = UNION OVERRIDE nameCashRegisterAttributeItem(skuBarcode(barcode)), dataTitleCashRegisterBarcode(barcode) MINCHARWIDTH 30 PREFCHARWIDTH 30;

// Весы
@defineItemAttributeName(scales, ' (весы)', public);
dataTitleScalesBarcode 'Наименование для весов' = DATA STRING[100] (barcode);
titleScalesBarcode 'Наименование для весов' = UNION OVERRIDE nameScalesAttributeItem(skuBarcode(barcode)), dataTitleScalesBarcode(barcode) MINCHARWIDTH 30 PREFCHARWIDTH 30;

EXTEND FORM item PROPERTIES(b) BEFORE delete titleScalesBarcode, titleCashRegisterBarcode;

// копирование товара
overCopyItem = ABSTRACT ACTION (s, d);

copyItem 'Копировать' = ACTION (item) NEWSESSION {
    FOR ADDOBJ i = item DO {
        SET itemGroupItem(i) <- itemGroupItem(item);
        SET captionItem(i) <- captionItem(item);
        SET UOMItem(i) <- UOMItem(item);
        SET brandItem(i) <- brandItem(item);
        SET netWeightItem(i) <- netWeightItem(item);
        SET grossWeightItem(i) <- grossWeightItem(item);
        SET countryItem(i) <- countryItem(item);
        SET imageItem(i) <- imageItem(item);
        SET isContainerItem(i) <- isContainerItem(item);
        SET isWeightItem(i) <- isWeightItem(item);
        SET inactiveItem(i) <- inactiveItem(item);

        FOR skuBarcode(barcode) == item DO {
            FOR ADDOBJ b = barcode DO {
                SET skuBarcode(b) <- i;
                SET dataDateBarcode(b) <- dataDateBarcode(barcode);
                SET dataUOMBarcode(b) <- dataUOMBarcode(barcode);
                SET dataAmountBarcode(b) <- dataAmountBarcode(barcode);
                SET dataTitleScalesBarcode(b) <- dataTitleScalesBarcode(barcode);
                SET dataTitleCashRegisterBarcode(b) <- dataTitleCashRegisterBarcode(barcode);
            }
        }

        EXEC overCopyItem(item, i);

        FORM item OBJECTS i = i MANAGESESSION DOCKED_MODAL;
    }
} TOOLBAR;

EXTEND FORM items
    PROPERTIES (i) copyItem
    PROPERTIES READONLY AFTER idBarcodeSku(i) nameAttributeItemGroupItem(g, i)
    FILTERS nameAttributeItemGroupItem(g, i)
    ORDER BY nameAttributeItemGroupItem
;

createItemBarcodeDate = ACTION (barcode, date) NEWSESSION {

    FOR ADDOBJ bc = barcode DO {
        SET idBarcode(bc) <- (barcode AS STRING[14]);
        SET dateBarcode(bc) <- (date AS DATE);
        FOR ADDOBJ s = item DO {
            SET skuBarcode(bc) <- s AS item;
            SET activeBarcode(bc) <- TRUE;
            SET primaryBarcode(bc) <- TRUE;
            FORM item OBJECTS i = s, b = bc MANAGESESSION DOCKED_MODAL;
        }
    }
}

createSkuBarcodeDate(barcode, date) += createItemBarcodeDate(barcode, date);