MODULE SalePurchase;

REQUIRE Sale, Purchase
;

//-----------------------------------------------------------------------------------------------------------//

availableQuantitySkuStockDateTime 'Доступное количество' (sku, stock, dateTime) = (currentBalanceSkuStock(sku, stock) AND dateTime AS DATETIME) (+) reservePurchaseBSkuStockDateTime(sku, stock, dateTime) (-) reserveSaleBSkuStockDateTime(sku, stock, dateTime);

META extendFormDocumentReserveSkuStock(object, NS, form, concrete)

    availableQuantity##NS##SkuStock###object 'Доступное количество' (sku, stock, object)= availableQuantitySkuStockDateTime(sku, stock, NS.shipmentDateTime###object(object));

    reservePurchaseB##NS##SkuStock###object 'Резерв (закупка)' (sku, stock, object) = reservePurchaseBSkuStockDateTime(sku, stock, NS.shipmentDateTime###object(object));
    reserveSaleB##NS##SkuStock###object 'Резерв (продажа)' (sku, stock, object) = reserveSaleBSkuStockDateTime(sku, stock, NS.shipmentDateTime###object(object));

    EXTEND FORM NS.form
        PROPERTIES READONLY BEFORE currentBalanceSkuStock(s, st) availableQuantity##NS##SkuStock###object(s, st, concrete)

        PROPERTIES READONLY AFTER currentBalanceSkuStock(s, st)
                   currentReserveSaleSkuStock(s,st), currentReservePurchaseSkuStock(s,st),
                   reserveSaleB##NS##SkuStock###object(s, st, concrete), reservePurchaseB##NS##SkuStock###object(s, st, concrete)
    ;
    EXTEND DESIGN NS.form {
        PROPERTY(availableQuantity##NS##SkuStock###object) { background = #F4FFBD; }
        PROPERTY(currentReservePurchaseSkuStock) { background = #CCFFCC; }
        PROPERTY(reservePurchaseB##NS##SkuStock###object) { background = #CCFFCC; }
        PROPERTY(currentReservePurchaseSkuStock) { background = #CCFFCC; }
        PROPERTY(currentReserveSaleSkuStock) { background = #BDE3FF; }
        PROPERTY(reserveSaleB##NS##SkuStock###object) { background = #BDE3FF; }
    }

END

@extendFormDocumentReserveSkuStock(userOrder, Sale, userOrder, o);
@extendFormDocumentReserveSkuStock(userOrder, SaleReturn, userOrder, o);
@extendFormDocumentReserveSkuStock(userOrder, Purchase, userOrder, o);
@extendFormDocumentReserveSkuStock(userOrder, PurchaseReturn, userOrder, o);
@extendFormDocumentReserveSkuStock(blanketOrder, Sale, blanketOrder, o);