MODULE PriceListManageStore;

REQUIRE PriceListManage, Store;

// -------------------- В ассортименте ----------------- //

countDepartmentStorePriceListTypeSkuStoreDateTime 'В ассортименте' (type, sku, store, dateTime) =
    GROUP SUM 1 IF pricePriceListTypeSkuStockDateTime(type, sku, stock, dateTime)
    BY type, sku, storeDepartmentStore(stock), dateTime;

countStorePriceListTypeSkuChainStoresDateTime 'В ассортименте' (type, sku, chainStores, dateTime) =
    GROUP SUM 1 IF countDepartmentStorePriceListTypeSkuStoreDateTime(type, sku, store, dateTime)
    BY type, sku, chainStoresStore(store), dateTime;

countStorePriceListTypeSkuStoreTypeDateTime 'В ассортименте' (type, sku, storeType, dateTime) =
    GROUP SUM 1 IF countDepartmentStorePriceListTypeSkuStoreDateTime(type, sku, store, dateTime)
    BY type, sku, storeTypeStore(store), dateTime;

countStorePriceListTypeSkuDateTime 'В ассортименте' (type, sku, dateTime) =
    GROUP SUM 1 IF countDepartmentStorePriceListTypeSkuStoreDateTime(type, sku, store, dateTime)
    BY type, sku, dateTime;

// --------------------- В наличии ---------------- //

countStoresSkuStoreTypeDateTime 'В наличии' (sku, storeType, dateTime) =
    GROUP SUM 1 IF balanceASkuStoreDateTime(sku, store, dateTime)
    BY sku, storeTypeStore(store), dateTime;

countStoreSkuChainStoresDateTime 'В наличии' (sku, chainStores, dateTime) =
    GROUP SUM 1 IF balanceASkuStoreDateTime(sku, store, dateTime)
    BY sku, chainStoresStore(store), dateTime;

EXTEND FORM priceListManage
    PROPERTIES READONLY countStorePriceListTypeSkuDateTime(pt, csk, dt) AFTER idBarcodeSku(csk)

    OBJECTS ccs = ChainStores
    PROPERTIES READONLY nameChainStores(ccs), countStoreChainStores(ccs), countStorePriceListTypeSkuChainStoresDateTime(pt, csk, ccs, dt), countStoreSkuChainStoresDateTime(csk, ccs, dt)
    FILTERS countStorePriceListTypeSkuChainStoresDateTime(pt, csk, ccs, dt)

    OBJECTS st=StoreType
    PROPERTIES READONLY nameStoreType(st), countStoreStoreType(st), countStorePriceListTypeSkuStoreTypeDateTime(pt, csk, st, dt), countStoresSkuStoreTypeDateTime(csk, st, dt)
    FILTERS countStorePriceListTypeSkuStoreTypeDateTime(pt, csk, st, dt)
;

EXTEND DESIGN priceListManage {
    c.stocks {
        ADD ccs.box BEFORE cst.box;
        ADD st.box BEFORE cst.box;
    }
}