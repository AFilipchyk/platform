MODULE Scales;

REQUIRE System, Machinery;

// Группы
CLASS groupScales 'Группы весов' : groupMachinery;

stockGroupScales = DATA stock (groupScales);
stockGroupMachinery (groupMachinery) += stockGroupScales(groupMachinery);

directoryGroupScales 'Каталог обмена' = DATA STRING[200] (groupScales) IN baseGroup;
pieceItemCodeGroupScales 'Код для штучных товаров' = DATA STRING[2] (groupScales) IN baseGroup;
weightItemCodeGroupScales 'Код для весовых товаров' = DATA STRING[2] (groupScales) IN baseGroup;

// Модели
CLASS scalesModel 'Модель весов' : model;

scalesModelName (scalesModel) = GROUP UNIQUE scalesModel BY name (scalesModel) WHERE scalesModel IS scalesModel;

maxTextScalesModel 'MAX допустимое колич. дополнительных текстов' = DATA INTEGER (scalesModel) IN baseGroup;
compositionScalesModel 'Число знаков в доп.тексте (составе товара)' = DATA INTEGER (scalesModel) IN baseGroup;

FORM scalesModel 'Модель весов'
    OBJECTS s=scalesModel FIXED PANEL
    PROPERTIES(s) name, noteModel, handlerModel, maxProductModel, maxTextScalesModel,
                  compositionScalesModel
    EDIT scalesModel OBJECT s
;

FORM scalesModels 'Модели весов'
    OBJECTS m=scalesModel
    PROPERTIES(m) READONLY objectClassName, name, maxProductModel, noteModel, handlerModel
    PROPERTIES(m) ADDFORM, EDITFORM, delete
;

// Весы
CLASS scales 'Весы' : machinery;
isGroupScales (machinery) = machinery IS groupScales;

groupScalesScales = DATA groupScales (scales);
groupMachineryMachinery(machinery) += groupScalesScales(machinery);

scalesModelScales = DATA scalesModel (scales);
modelMachinery(machinery) += scalesModelScales(machinery);

numberScales 'Заводской(серийный) номер' = DATA STRING[100] (scales) IN baseGroup;
dateScales 'Дата следующей обязательной поверки' = DATA DATE (scales) IN baseGroup;

FORM scales 'Весы'
    OBJECTS s=scales FIXED PANEL
    PROPERTIES(s) nameGroupMachineryMachinery, nppMachinery, descriptionMachinery, portMachinery, numberScales, nameModelMachinery,
                  dateScales
    EDIT scales OBJECT s
;

FORM groupScales 'Группа весов'
    OBJECTS grs=groupScales FIXED PANEL
    PROPERTIES(grs) nameStockGroupMachinery, nameEquipmentServerGroupMachinery, nameGroupMachinery,
                    directoryGroupScales,
                    pieceItemCodeGroupScales, weightItemCodeGroupScales,
                    filterSkuGroupMachinery, showFilterSkuGroupMachinery SHOWIF filterSkuGroupMachinery(grs)

    OBJECTS s=scales
    PROPERTIES(s)   nameGroupMachineryMachinery, nppMachinery, descriptionMachinery, portMachinery, numberScales, nameModelMachinery,
                    dateScales, ADDOBJ, delete
    FILTERGROUP filters1
        FILTER 'Показывать только для данной группы' 'F10' groupScalesScales(s) == grs DEFAULT
    EDIT groupScales OBJECT grs
;

FORM groupsScales 'Группы весов'
    OBJECTS grs=groupScales
    PROPERTIES(grs) READONLY nameStockGroupMachinery, nameEquipmentServerGroupMachinery, nameGroupMachinery,
                         filterSkuGroupMachinery, directoryGroupScales,
                         pieceItemCodeGroupScales, weightItemCodeGroupScales
    PROPERTIES(grs) ADDFORM, EDITFORM, delete

    OBJECTS s=scales
    PROPERTIES(s)   READONLY nppMachinery, descriptionMachinery, portMachinery, numberScales, nameModelMachinery,
                             dateScales
    FILTERS groupScalesScales(s) == grs
;

DESIGN groupsScales FROM DEFAULT {
    NEW topContainer BEFORE functions.box {
        type = SPLITV;
        childConstraints = TO THE BOTTOM;

        ADD grs.box;
        ADD s.box;
    }
}

// Ячейки
CLASS cellScales 'Ячейка весов';

groupScalesCellScales = DATA groupScales (cellScales);

compositionCellScales 'Ячейка' = DATA TEXT (cellScales);
numberCellScales 'Номер' = PARTITION SUM 1 IF c IS cellScales BY groupScalesCellScales (c) ORDER c;

groupScalesCompositionToCellScales (groupScales, composition) = GROUP UNIQUE cellScales
            BY groupScalesCellScales (cellScales), compositionCellScales (cellScales) WHERE cellScales IS cellScales;

FORM cellScales 'Ячейки весов'
    OBJECTS grs=groupScales
        PROPERTIES(grs) READONLY nameStockGroupMachinery, nameEquipmentServerGroupMachinery, nameGroupMachinery,
                             filterSkuGroupMachinery, directoryGroupScales,
                             pieceItemCodeGroupScales, weightItemCodeGroupScales

    OBJECTS cs=cellScales
    PROPERTIES(cs)  numberCellScales, compositionCellScales, delete

    FILTERS groupScalesCellScales(cs) == grs
;

DESIGN cellScales FROM DEFAULT {
    NEW topContainer{
        type = SPLITV;
        childConstraints = TO THE BOTTOM;

        ADD grs.box;
        ADD cs.box;
    }
    ADD functions.box;
}
