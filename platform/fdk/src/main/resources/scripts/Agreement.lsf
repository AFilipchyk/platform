MODULE Agreement;

REQUIRE Currency,
        Document,
        LegalEntity,
        Numerator,
        PriceList;

CLASS agreement 'Соглашение' : named, numeratedObject;

TABLE agreement (agreement);

@defineNumeratedObjectDefault(agreement, 'Нумератор для договоров', 'ТД');

@defineDocumentHeaderTime(agreement);
@defineDocumentHeaderTimePrefix(agreement, from, ' с');

@defineDocumentHeaderTimePrefix(agreement, to, ' по');
toDateAgreement(agreement) <- NULL WHEN ASSIGNED(agreement IS agreement);
toTimeAgreement(agreement) <- NULL WHEN ASSIGNED(agreement IS agreement);

@defineDocumentHeaderNote(agreement);
@defineDocumentHeaderCurrency(agreement);
@defineDocumentHeaderDescription(agreement, seriesNumberObject, 'Соглашение');

inCustomerAgreement 'Отм' = DATA BOOLEAN (agreement);

TABLE agreementLegalEntityGroup (agreement, legalEntityGroup);
inAgreementCustomerGroup 'Отм' = DATA BOOLEAN (agreement, legalEntityGroup);

TABLE agreementLegalEntity(agreement, legalEntity);
inAgreementCustomer 'Отм.' (agreement, legalEntity) = DATA BOOLEAN (agreement, legalEntity);

levelParentAgreementCustomerGroup (agreement, legalEntityGroup) =
    GROUP MIN levelLegalEntityGroupLegalEntityGroup(legalEntityGroup, parent) IF inAgreementCustomerGroup(agreement, parent)
          BY agreement, legalEntityGroup PERSISTENT;
nearestParentLegalEntityGroup (agreement, legalEntityGroup) =
    legalEntityGroupLegalEntityGroupLevel(legalEntityGroup, levelParentAgreementCustomerGroup(agreement, legalEntityGroup));
nearestInAgreementCustomerGroup (agreement, legalEntityGroup) =
    inAgreementCustomerGroup(agreement, nearestParentLegalEntityGroup(agreement, legalEntityGroup));

inAgreementCustomerGroupOver 'Отм' (agreement, legalEntityGroup) =
    UNION OVERRIDE inCustomerAgreement(agreement) AND legalEntityGroup IS legalEntityGroup,
                   nearestInAgreementCustomerGroup(agreement, legalEntityGroup),
                   inAgreementCustomerGroup(agreement, legalEntityGroup);

inAgreementCustomerOver 'Отм' (agreement, legalEntity) =
    UNION OVERRIDE inCustomerAgreement(agreement) AND legalEntity IS legalEntity,
                   nearestInAgreementCustomerGroup(agreement, legalEntityGroupLegalEntity(legalEntity)),
                   inAgreementCustomer(agreement, legalEntity);

customerAgreement 'Покупатели' (agreement) = GROUP CONCAT name(legalEntity) IF inAgreementCustomerOver(agreement, legalEntity) , ', '
                                                 BY agreement
                                                 ORDER legalEntity MINCHARWIDTH 100 PERSISTENT;

supplierAgreement (agreement) = DATA legalEntity (agreement);
nameSupplierAgreement 'Компания' (agreement) = name(supplierAgreement(agreement));

priceListTypeAgreement (agreement) = DATA priceListType (agreement) NOT NULL;
namePriceListTypeAgreement 'Вид цены' (agreement) = name(priceListTypeAgreement(agreement));

TABLE agreementPriceGroup(agreement, priceGroup);
priceListTypeAgreementPriceGroup (agreement, priceGroup) = DATA priceListType (agreement, priceGroup);
namePriceListTypeAgreementPriceGroup 'Вид цены' (agreement, priceGroup) = name(priceListTypeAgreementPriceGroup(agreement, priceGroup));

TABLE agreementSku(agreement, sku);
priceListTypeAgreementSku (agreement, sku) = DATA priceListType (agreement, sku);
namePriceListTypeAgreementSku 'Вид цены' (agreement, sku) = name(priceListTypeAgreementSku(agreement, sku));

CONSTRAINT currencyAgreement(agreement) != currencyPriceListType(priceListTypeAgreement(agreement))
           CHECKED BY priceListTypeAgreement
           MESSAGE 'Валюта соглашения должна совпадать с валютой вида цены';

CONSTRAINT currencyAgreement(agreement) != currencyPriceListType(priceListTypeAgreementPriceGroup(agreement, priceGroup))
           CHECKED BY priceListTypeAgreementPriceGroup
           MESSAGE 'Валюта соглашения должна совпадать с валютой вида цены';

CONSTRAINT currencyAgreement(agreement) != currencyPriceListType(priceListTypeAgreementSku(agreement, sku))
           CHECKED BY priceListTypeAgreementSku
           MESSAGE 'Валюта соглашения должна совпадать с валютой вида цены';

priceListTypeAgreementSkuOver (agreement, sku) =
    UNION OVERRIDE priceListTypeAgreement(agreement) AND sku IS sku,
                   priceListTypeAgreementPriceGroup(agreement, priceGroupSku(sku)),
                   priceListTypeAgreementSku(agreement, sku);

namePriceListTypeAgreementSkuOver 'Вид цены' = name(priceListTypeAgreementSkuOver(agreement, sku));

userDefaultAgreementCustomerSupplier = DATA agreement (legalEntity, legalEntity);
userDefaultAgreementCustomerSupplier(company, legalEntity) => inAgreementCustomerOver(userDefaultAgreementCustomerSupplier(company, legalEntity), legalEntity) RESOLVE FALSE;

calcDefaultAgreementCustomerSupplier(company, legalEntity) =
    GROUP MAX agreement IF inAgreementCustomerOver(agreement, legalEntity)
    BY supplierAgreement(agreement), legalEntity;

defaultAgreementCustomerSupplier(legalEntity, company) = UNION OVERRIDE calcDefaultAgreementCustomerSupplier(legalEntity, company), userDefaultAgreementCustomerSupplier(legalEntity, company) PERSISTENT;
nameDefaultAgreementCustomerSupplier 'Соглашение по умолчанию' (legalEntity, company) = name(defaultAgreementCustomerSupplier(legalEntity, company));

isDefaultAgreementCustomerSupplier 'Соглашение по умолчанию' (agreement, legalEntity, company) = defaultAgreementCustomerSupplier(legalEntity, company) == agreement;

META defineDocumentAbstractHeaderAgreement (object)
    agreement###object (object) = ABSTRACT agreement (object) PERSISTENT;
    nameAgreement###object 'Соглашение' (object)= name(agreement###object(object)) IN documentPrmGroup MINCHARWIDTH 5 PREFCHARWIDTH 10;
END
META defineDocumentHeaderAgreement (object)
    agreement###object (object) = DATA agreement (object);
    nameAgreement###object 'Соглашение' (object)= name(agreement###object(object)) IN documentPrmGroup MINCHARWIDTH 5 PREFCHARWIDTH 10;
END
META defineDocumentInterfaceHeaderAgreement (object, company, legalEntity)
    @defineDocumentAbstractHeaderAgreement(object);
    @defineDocumentHeaderAgreement(user###object);
    agreement###user###object (object) <- defaultAgreementCustomerSupplier(legalEntity(object), company(object))
        IF currency###user###object(object) == currencyAgreement(defaultAgreementCustomerSupplier(legalEntity(object), company(object)))
    WHEN CHANGED(currency###user###object(object)) OR
         CHANGED(legalEntity(object));
    agreement###object (object) += agreement###user###object(object);

    CONSTRAINT currency###user###object(object) != currencyAgreement(agreement###user###object(object))
               CHECKED BY agreement###user###object
               MESSAGE 'Валюта документа должны совпадать с валютой соглашения';

    CONSTRAINT supplierAgreement(agreement###user###object(object)) != company(object)
               CHECKED BY agreement###user###object
               MESSAGE 'Соглашение должно быть между заданными юр. лицами';

    CONSTRAINT agreement###user###object(object)
               AND NOT inAgreementCustomerOver(agreement###user###object(object), legalEntity(object))
               CHECKED BY agreement###user###object
               MESSAGE 'Соглашение должно быть между заданными юр. лицами';
END


META deriveDocumentDetailPriceListTypeAgreementCustom (object, detail)
    priceListType###user###detail(detail) <- IF agreement###user###object(object###detail(detail))
                                             THEN priceListTypeAgreementSkuOver(agreement###user###object(object###detail(detail)), sku###user###detail(detail))
                                             ELSE priceListType###user###object(object###detail(detail))
    WHEN CHANGED(agreement###user###object(object###detail(detail))) OR
         CHANGED(priceListType###user###object(object###detail(detail)));
END
META deriveDocumentDetailPriceListTypeAgreement (object)
    @deriveDocumentDetailPriceListTypeAgreementCustom(object, object###detail);
END

//--------------------------------------- Для двух объектов ----------------------------------------------------------//
META defineDocumentDoubleHeaderAgreement (object, legalEntity)
    agreement###object###legalEntity (object, legalEntity) = DATA agreement (object, legalEntity);
    nameAgreement###object###legalEntity 'Соглашение' (object, legalEntity)= name(agreement###object###legalEntity(object, legalEntity)) IN documentPrmGroup MINCHARWIDTH 5 PREFCHARWIDTH 10;
    dataPriceListType###object###legalEntity (object, legalEntity) = priceListTypeAgreement(agreement###object###legalEntity (object, legalEntity));
    priceListType###object###legalEntity (object, legalEntity) =
        UNION OVERRIDE dataPriceListType###object###legalEntity(object, legalEntity),
                       userPriceListType###object###legalEntity(object, legalEntity);
    namePriceListType###object###legalEntity 'Вид цен' (object, legalEntity)= name(priceListType###object###legalEntity(object, legalEntity)) IN documentPrmGroup MINCHARWIDTH 5 PREFCHARWIDTH 10;
END
META defineDocumentDoubleInterfaceHeaderAgreement (object, company, legalEntity)
    @defineDocumentDoubleHeaderAgreement(object, legalEntity);
    agreement###object###legalEntity (object, legalEntity) <- defaultAgreementCustomerSupplier(legalEntity, company(object))
        IF currency###object(object) == currencyAgreement(defaultAgreementCustomerSupplier(legalEntity, company(object))
    WHEN CHANGED(currency###object(object)) AND legalEntity IS legalEntity OR
         CHANGED(in###object###legalEntity(object, legalEntity));

    CONSTRAINT currency###object(object) != currencyAgreement(agreement###object###legalEntity(object, legalEntity))
               CHECKED BY agreement###object###legalEntity
               MESSAGE 'Валюта документа должны совпадать с валютой соглашения';

    CONSTRAINT supplierAgreement(agreement###object###legalEntity(object, legalEntity)) != company(object)
               CHECKED BY agreement###object###legalEntity
               MESSAGE 'Соглашение должно быть между заданными юр. лицами';

    CONSTRAINT agreement###object###legalEntity(object, legalEntity)
               AND NOT inAgreementCustomerOver(agreement###object###legalEntity(object, legalEntity), legalEntity)
               CHECKED BY agreement###object###legalEntity
               MESSAGE 'Соглашение должно быть между заданными юр. лицами';
END

META deriveDocumentDoubleDetailPriceListTypeAgreementCustom (object, detail, legalEntity)
    priceListType###detail (idetail) = UNION OVERRIDE priceListType###object###legalEntity(object###detail(idetail), legalEntity###detail(idetail)), dataPriceListType###detail(idetail) PERSISTENT;
    namePriceListType###detail 'Вид цен' (idetail) = name(priceListType###detail(idetail)) MINCHARWIDTH 10 PREFCHARWIDTH 20;

    priceListType###detail(detail) <- IF agreement###object###legalEntity(object###detail(detail), legalEntity###detail(detail))
                                             THEN priceListTypeAgreementSkuOver(agreement###object###legalEntity(object###detail(detail), legalEntity###detail(detail)), sku###detail(detail))
                                             ELSE priceListType###object###legalEntity(object###detail(detail), legalEntity###detail(detail))
    WHEN CHANGED(agreement###object###legalEntity(object###detail(detail), legalEntity###detail(detail))) OR
         CHANGED(priceListType###object###legalEntity(object###detail(detail), legalEntity###detail(detail))) OR
         CHANGED(sku###detail(detail)) OR
         CHANGED(stock###detail(detail)) OR
         CHANGED(legalEntity###detail(detail));
END
META deriveDocumentDoubleDetailPriceListTypeAgreement (object, legalEntity)
    @deriveDocumentDoubleDetailPriceListTypeAgreementCustom(object, object###detail, legalEntity);
END

META deriveDocumentDetailPricePriceListTypeCustom (detail, stockProp)
    price###detail(detail) <- prevPricePriceListTypeSkuStockDateTime(priceListType###detail(detail),
                                                                     sku###detail(detail),
                                                                     stockProp###detail(detail),
                                                                     dateTime###detail(detail))
                                    WHEN CHANGED(priceListType###detail(detail)) OR
                                         CHANGED(sku###detail(detail)) OR
                                         CHANGED(stockProp###detail(detail)) OR
                                         CHANGED(dateTime###detail(detail));
END

META deriveDocumentDetailPricePriceListType (object, stockProp)
    @deriveDocumentDetailPricePriceListTypeCustom(object##Detail, stockProp);
END

META deriveDocumentDetailPriceBatchPriceListTypeCustom (detail, stockProp)
    price###detail(detail) <- IF batch###detail(detail) THEN
                                    prevPricePriceListTypeBatchStockDateTime(priceListType###detail(detail),
                                                                             batch###detail(detail),
                                                                             stockProp###detail(detail),
                                                                             dateTime###detail(detail))
                              ELSE
                                    prevPricePriceListTypeSkuStockDateTime(priceListType###detail(detail),
                                                                           sku###detail(detail),
                                                                           stockProp###detail(detail),
                                                                           dateTime###detail(detail))
                                    WHEN CHANGED(batch###detail(detail)) OR
                                         CHANGED(priceListType###detail(detail)) OR
                                         CHANGED(sku###detail(detail)) OR
                                         CHANGED(stockProp###detail(detail)) OR
                                         CHANGED(dateTime###detail(detail));
END

META deriveDocumentDetailPriceBatchPriceListType (object, stockProp)
    @deriveDocumentDetailPriceBatchPriceListTypeCustom(object##Detail, stockProp);
END

FORM agreementsLegalEntity 'Соглашения'

    OBJECTS l=legalEntity FIXED PANEL
    PROPERTIES(l) name

    OBJECTS c=legalEntity FIXED PANEL
    PROPERTIES(c) name

    OBJECTS ag=agreement
    PROPERTIES(ag) READONLY name, numberObject, seriesObject, dateAgreement, timeAgreement,
                            fromDateAgreement, fromTimeAgreement, toDateAgreement, toTimeAgreement,
                            nameCurrencyAgreement, namePriceListTypeAgreement, noteAgreement
    PROPERTIES inAgreementCustomerOver(ag, l)
;

DESIGN agreementsLegalEntity FROM DEFAULT{
    NEW mainContainer{
        REMOVE l.box;
        REMOVE c.box;
        ADD ag.box;
    }
    ADD functions.box;
}

addAgreementsCustomerSupplier 'Добавление соглашений' = ACTION (legalEntity, company) {

    FORM agreementsLegalEntity OBJECTS c=legalEntity, l=company MODAL;
    IF formResult() == formResult.ok THEN {
        EXEC apply();
    }
} TOOLBAR;

FORM agreement 'Соглашение'

    OBJECTS a = agreement FIXED PANEL
    PROPERTIES(a) name, nameNumeratorObject, numberObject, seriesObject, dateAgreement, timeAgreement,
                  fromDateAgreement, fromTimeAgreement, toDateAgreement, toTimeAgreement, nameSupplierAgreement,
                  nameCurrencyAgreement, namePriceListTypeAgreement, noteAgreement

    TREE legalEntityGroupTree b=STRING[3], lg = legalEntityGroup PARENT parentLegalEntityGroup
    PROPERTIES READONLY OBJVALUE(b), lgTreeName = name(lg)
    FILTERS stringEqualsAll(b)
    PROPERTIES(a) inCustomerAgreement TODRAW b FORCE GRID
    PROPERTIES(a, lg) inAgreementCustomerGroupOver

    OBJECTS l = legalEntity
    PROPERTIES(l) READONLY name
    PROPERTIES(a, l) inAgreementCustomerOver
    FILTERS inLegalEntityGroupLegalEntity(lg, l)

    FILTERGROUP filters
        FILTER 'Только отмеченные' 'F10' inAgreementCustomerOver (a, l)

    TREE priceGroupTree g=priceGroup PARENT parentPriceGroup
    PROPERTIES READONLY name(g)
    ORDER BY name(g)

    OBJECTS pg = priceGroup
    PROPERTIES(pg) READONLY canonicalNamePriceGroup
    PROPERTIES(a, pg) namePriceListTypeAgreementPriceGroup
    FILTERS isParentPriceGroupPriceGroup(pg, g)

    TREE skuGroupTree sg=skuGroup PARENT parentSkuGroup
    PROPERTIES READONLY name(sg)
    ORDER BY name(sg)

    OBJECTS s = sku
    PROPERTIES(s) READONLY nameSku
    PROPERTIES(a, s) namePriceListTypeAgreementSku
    FILTERS isParentSkuGroupSku(sg, s)

    EDIT agreement OBJECT a
;

DESIGN agreement FROM DEFAULT {

    NEW topContainer{
        childConstraints = TO THE BOTTOM;
        NEW headContainer {
            caption = 'Шапка документа';
            childConstraints = TO THE RIGHT;
            ADD PROPERTY (name);
            ADD PROPERTY (nameNumeratorObject);
            ADD PROPERTY (numberObject);
            ADD PROPERTY (seriesObject);
            ADD PROPERTY (dateAgreement);
            ADD PROPERTY (timeAgreement);

        }
        NEW firstContainer{
            childConstraints = TO THE BOTTOM;
            NEW timeContainer{
                caption = 'Период действия';
                childConstraints = TO THE RIGHT;
                ADD PROPERTY (fromDateAgreement);
                ADD PROPERTY (fromTimeAgreement);
                ADD PROPERTY (toDateAgreement);
                ADD PROPERTY (toTimeAgreement);
            }
            NEW propContainer{
                caption = 'Параметры документа';
                childConstraints = TO THE RIGHT;
                ADD PROPERTY(nameSupplierAgreement);
                ADD PROPERTY(nameCurrencyAgreement);
                ADD PROPERTY(namePriceListTypeAgreement);
                ADD PROPERTY(noteAgreement);
            }
        }
            NEW tabContainer{
                type = TABBED;
                NEW legalEntityBox{
                    caption = 'Контрагенты';
                    childConstraints = TO THE RIGHT;
                    type = SPLITH;
                    ADD legalEntityGroupTree.tree.box;
                    ADD l.box{
                        fillHorizontal = 2.0;
                    }
                }
                NEW priceGroupContainer{
                    childConstraints = TO THE RIGHT;
                    caption = 'Уточнение цен по ценовым группам';
                    type = SPLITH;
                    ADD priceGroupTree.tree.box;
                    ADD pg.box{fillHorizontal = 3.0;}
                }
                NEW skuContainer{
                    childConstraints = TO THE RIGHT;
                    caption = 'Уточнение цен по товарам';
                    type = SPLITH;
                    ADD skuGroupTree.tree.box;
                    ADD s.box{fillHorizontal = 3.0;}
                }
            }
    }
    ADD functions.box;
}

createAgreementCustomerSupplier 'Создать соглашение' = ACTION (company, legalEntity) {

    FOR ADDOBJ ag = agreement DO {
        SET inAgreementCustomer(ag, legalEntity) <- TRUE;
        SET supplierAgreement(ag) <- (company AS legalEntity);
        FORM agreement OBJECTS a = ag MODAL;
        IF TRUE AND NOT formResult() == formResult.ok THEN {
            EXEC delete(ag);
        }
    }
} TOOLBAR;

FORM agreements 'Соглашения'

    OBJECTS a = agreement
    PROPERTIES(a) READONLY name, seriesNumberObject, dateTimeAgreement,
                           fromDateTimeAgreement, toDateTimeAgreement, nameSupplierAgreement,
                           nameCurrencyAgreement, namePriceListTypeAgreement, customerAgreement, noteAgreement

    PROPERTIES(a) ADDFORM, EDITFORM, delete
;

EXTEND FORM legalEntity

    OBJECTS s=legalEntity
    PROPERTIES(s) READONLY name

    OBJECTS ag=agreement
    PROPERTIES(ag, s, l) isDefaultAgreementCustomerSupplier
    PROPERTIES(ag, l) inAgreementCustomerOver
    PROPERTIES(ag) READONLY name, numberObject, seriesObject, dateAgreement, timeAgreement,
                            fromDateAgreement, fromTimeAgreement, toDateAgreement, toTimeAgreement,
                            nameCurrencyAgreement, namePriceListTypeAgreement, noteAgreement
    PROPERTIES(ag) EDITFORM
    PROPERTIES createAgreementCustomerSupplier(s, l) TODRAW ag FORCE PANEL DRAWTOTOOLBAR, addAgreementsCustomerSupplier(s, l) TODRAW ag FORCE PANEL DRAWTOTOOLBAR
    FILTERS inAgreementCustomerOver(ag, l)

    OBJECTS c=legalEntity
    PROPERTIES(c) READONLY name

    OBJECTS ag2=agreement
    PROPERTIES(ag2, l, c) isDefaultAgreementCustomerSupplier
    PROPERTIES(ag2, l) inAgreementCustomerOver
    PROPERTIES(ag2) READONLY name, numberObject, seriesObject, dateAgreement, timeAgreement,
                            fromDateAgreement, fromTimeAgreement, toDateAgreement, toTimeAgreement,
                            nameCurrencyAgreement, namePriceListTypeAgreement, noteAgreement
    PROPERTIES(ag2) EDITFORM
    PROPERTIES createAgreementCustomerSupplier(l, c) TODRAW ag2 FORCE PANEL DRAWTOTOOLBAR, addAgreementsCustomerSupplier(l, c) TODRAW ag2 FORCE PANEL DRAWTOTOOLBAR
    FILTERS inAgreementCustomerOver(ag2, l)
;

EXTEND DESIGN legalEntity {
    extendContainer {
        NEW agreementBuyContainer{
            caption = 'Соглашения на поставку';
            type = SPLITH;
            ADD s.box;
            ADD ag.box{fillHorizontal = 3;}
        }
        NEW agreementSaleContainer{
            caption = 'Соглашения на продажу';
            type = SPLITH;
            ADD c.box;
            ADD ag2.box{fillHorizontal = 3;}
        }
    }
}