MODULE Shipment;

REQUIRE Stock, Item, LegalEntity;

CLASS shipment 'Расходная накладная';
CLASS shipmentDetail 'Строка расходной накладной';

shipmentShipmentDetail 'Документ строки' (shipmentDetail) = DATA shipment(shipmentDetail);
indexShipmentDetail 'Номер строки' (shipmentDetail) =
        PARTITION SUM 1 IF shipmentDetail IS shipmentDetail BY shipmentShipmentDetail(shipmentDetail)
        ORDER shipmentDetail;

numberShipment 'Номер накладной' (shipment) = DATA STRING[10](shipment);
dateShipment 'Дата накладной' (shipment) = DATA DATE(shipment);

customerShipment 'Покупатель' (shipment) = DATA legalEntity(shipment);
nameCustomerShipment 'Наименование покупателя' (shipment) = nameLegalEntity(customerShipment(shipment));

stockShipment 'Склад' (shipment) = DATA stock(shipment);
nameStockShipment 'Наименование склада' (shipment) = nameStock(stockShipment(shipment));

itemShipmentDetail 'Товар' (shipmentDetail) = DATA item(shipmentDetail);
nameItemShipmentDetail 'Наименование товара' (shipmentDetail) = nameItem(itemShipmentDetail(shipmentDetail));

quantityShipmentDetail 'Количество' (shipmentDetail) = DATA NUMERIC[14,2](shipmentDetail);
priceShipmentDetail 'Цена продажи' (shipmentDetail) = DATA NUMERIC[17,2](shipmentDetail);
sumShipmentDetail 'Сумма продажи' (shipmentDetail) = quantityShipmentDetail(shipmentDetail)*priceShipmentDetail(shipmentDetail);

priceShipmentDetail(shipmentDetail) <- salePriceItem(itemShipmentDetail(shipmentDetail)) WHEN CHANGED(itemShipmentDetail(shipmentDetail));

FORM shipment 'Расходная накладная'
	OBJECTS s=shipment FIXED PANEL
	PROPERTIES(s) numberShipment, dateShipment, nameCustomerShipment, nameStockShipment

	OBJECTS d=shipmentDetail
	PROPERTIES(d) nameItemShipmentDetail, quantityShipmentDetail, priceShipmentDetail, sumShipmentDetail READONLY, ADDOBJ, delete
	FILTERS shipmentShipmentDetail(d) == s

	EDIT shipment OBJECT s
;

FORM shipments 'Расходные накладные'
	OBJECTS s=shipment
	PROPERTIES(s) READONLY numberShipment, dateShipment, nameCustomerShipment, nameStockShipment
	PROPERTIES(s) ADDFORM, EDITFORM, delete

	OBJECTS d=shipmentDetail
	PROPERTIES(d) READONLY nameItemShipmentDetail, quantityShipmentDetail, priceShipmentDetail, sumShipmentDetail
	FILTERS shipmentShipmentDetail(d) == s
 ;